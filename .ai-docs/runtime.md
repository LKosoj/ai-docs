# Запуск и окружение

## Базовый запуск

Инструмент `ai_docs` запускается через CLI. Точка входа — команда `ai_docs` или прямой вызов `python -m ai_docs.cli`.

Пример минимального запуска:
```bash
ai_docs --source ./my-project
```

По умолчанию будет:
- Проанализирована директория `./my-project`.
- Сгенерированы `README.md` и MkDocs-сайт.
- Вывод размещён в `.ai-docs/` и `ai_docs_site/`.
- Использован язык `ru`.

---

## Переменные окружения

| Переменная               | Назначение | Значение по умолчанию |
|--------------------------|------------|------------------------|
| `OPENAI_API_KEY`         | Ключ доступа к OpenAI или совместимому API | Обязательна |
| `OPENAI_BASE_URL`        | Базовый URL API (для локальных моделей) | `https://api.openai.com/v1` |
| `OPENAI_MODEL`           | Модель LLM | `gpt-4o-mini` |
| `OPENAI_TEMPERATURE`     | Температура генерации | `0.2` |
| `OPENAI_MAX_TOKENS`      | Макс. токенов в ответе | `1200` |
| `OPENAI_CONTEXT_TOKENS`  | Лимит контекста | `8192` |
| `AI_DOCS_THREADS`        | Количество потоков обработки | `4` |
| `AI_DOCS_LOCAL_SITE`     | Режим локального хостинга MkDocs (`true`/`false`) | `false` |

> **Примечание**: переменные загружаются из `.env` при наличии.

---

## Аргументы командной строки

| Аргумент | Описание | Пример |
|--------|--------|--------|
| `--source` | Путь к директории или URL git-репозитория | `--source https://github.com/user/repo.git` |
| `--output` | Корневая директория вывода | `--output ./docs` |
| `--language` | Язык документации (`ru`, `en`) | `--language en` |
| `--readme` | Генерировать только `README.md` | `--readme` |
| `--mkdocs` | Генерировать только MkDocs-сайт | `--mkdocs` |
| `--include` | Glob-паттерны включения файлов | `--include "*.py" --include "Dockerfile"` |
| `--exclude` | Glob-паттерны исключения | `--exclude "tests/*" --exclude "*.log"` |
| `--max-size` | Макс. размер файла в байтах | `--max-size 500000` |
| `--threads` | Количество потоков | `--threads 8` |
| `--no-cache` | Отключить кэширование LLM-ответов | `--no-cache` |
| `--local-site` | Настроить MkDocs для локального хостинга | `--local-site` |
| `--force` | Перезаписать существующий `README.md` | `--force` |

> Если не указаны `--readme` и `--mkdocs`, генерируются оба артефакта.

---

## Режимы работы

### 1. Локальная директория
```bash
ai_docs --source ./src
```
- Сканируется локальная папка.
- Учитываются `.gitignore`, `.build_ignore`.
- Кэш сохраняется в `.ai_docs_cache/`.

### 2. Удалённый репозиторий
```bash
ai_docs --source https://github.com/example/project.git
```
- Репозиторий клонируется во временную директорию.
- После завершения — временные файлы удаляются.
- Поддерживаются публичные и приватные репозитории (через SSH или токен в URL).

### 3. Инкрементальная генерация
При повторном запуске:
- Сравниваются хэши файлов с предыдущим состоянием (`cache/index.json`).
- Обрабатываются только изменённые, добавленные или удалённые файлы.
- Результаты LLM кэшируются по хешу запроса.

Отчёт об изменениях сохраняется в `docs/changes.md`.

---

## Кастомизация через `.ai-docs.yaml`

Файл в корне проекта позволяет переопределить поведение сканирования:

```yaml
code_extensions:
  - ext: ".py"
    desc: "Python модуль"
  - ext: ".go"
    desc: "Go-пакет"

config_extensions:
  - ext: ".yaml"
    desc: "Конфигурация"

exclude:
  - "temp/"
  - "*.tmp"
  - "legacy/"
```

Поддерживаемые секции:
- `code_extensions`, `doc_extensions`, `config_extensions` — расширения с описаниями.
- `exclude` — дополнительные паттерны исключения.

> При отсутствии `.ai-docs.yaml` создаётся дефолтный конфиг.

---

## Каталоги и артефакты

| Путь | Назначение |
|------|----------|
| `.ai-docs/` | Детальная документация по файлам, модулям, навигация (`_index.json`) |
| `ai_docs_site/` | Собранный MkDocs-сайт (статика) |
| `.ai_docs_cache/` | Кэш хэшей файлов и ответов LLM (`index.json`, `llm_cache.json`) |
| `mkdocs.yml` | Сгенерированный конфиг для MkDocs |
| `docs/changes.md` | История изменений в структуре проекта |

---

## Интеграция в CI/CD

Пример `.gitlab-ci.yml`:
```yaml
generate-docs:
  image: python:3.11
  before_script:
    - pip install ai_docs
  script:
    - ai_docs --source . --language ru --mkdocs
    - mv ai_docs_site public
  artifacts:
    paths:
      - public/
```

Рекомендации:
- Храните `.ai_docs_cache/` между запусками (например, через кэш CI).
- Используйте `--no-cache` только при отладке.
- Переменные API-ключа передавайте через секреты.

---

## Ограничения и безопасность

- **Макс. размер файла**: 200 КБ (настраивается через `--max-size`).
- **Бинарные файлы** пропускаются (определяются по наличию нулевых байтов).
- **Текстовые файлы** обрезаются до 4000 символов при анализе.
- **Кэш LLM** потокобезопасен, использует `threading.Lock`.
- Временные директории при клонировании удаляются автоматически.

---

## Диагностика

При ошибках:
- Проверьте наличие `OPENAI_API_KEY`.
- Убедитесь, что `--source` доступен и не пуст.
- Просмотрите `docs/changes.md` и логи в stdout.
- При проблемах с кэшем — удалите `.ai_docs_cache/` и перезапустите.

Для отладки используйте:
```bash
ai_docs --source . --no-cache --threads 1
```
