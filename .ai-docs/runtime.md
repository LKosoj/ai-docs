# Запуск и окружение

## Базовый запуск

Инструмент `ai_docs` запускается из командной строки. Основная команда:

```bash
ai_docs --source <путь_или_url> [опции]
```

Примеры:
```bash
# Генерация README для локального проекта
ai_docs --source . --readme

# Генерация сайта документации из удалённого репозитория
ai_docs --source https://github.com/user/project.git --mkdocs

# Генерация README и сайта на русском языке
ai_docs --source . --readme --mkdocs --language ru
```

## Переменные окружения

Конфигурация LLM и поведения инструмента задаётся через `.env`-файл или переменные окружения:

```env
# Обязательно
OPENAI_API_KEY=your_api_key_here

# Опционально
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4o-mini
OPENAI_MAX_TOKENS=1200
OPENAI_CONTEXT_TOKENS=8192
OPENAI_TEMPERATURE=0.2

# Потоки и кэширование
AI_DOCS_THREADS=4
AI_DOCS_LOCAL_SITE=true
```

## Поддерживаемые источники

- **Локальные директории**: `--source ./my-project`
- **Git-репозитории (удалённые)**: `--source https://github.com/user/repo.git`
- **Локальные репозитории**: `--source /path/to/local/repo/.git`

При работе с URL репозиторий клонируется во временный каталог, который удаляется после завершения.

## Ключевые параметры CLI

| Параметр | Назначение |
|--------|-----------|
| `--source` | Путь или URL к анализируемому проекту (обязательный) |
| `--readme` | Генерировать `README.md` |
| `--mkdocs` | Генерировать структуру для MkDocs (`mkdocs.yml` и `.ai-docs/`) |
| `--language ru\|en` | Язык документации (по умолчанию `ru`) |
| `--threads N` | Количество потоков обработки (по умолчанию — из `AI_DOCS_THREADS`) |
| `--cache-dir path` | Кастомная директория кэша (по умолчанию `.ai_docs_cache/`) |
| `--no-cache` | Отключить кэширование LLM-ответов |
| `--local-site` | Настроить `mkdocs.yml` для локального хостинга (`site_url: ""`) |
| `--force` | Перезаписать существующий `README.md` |
| `--include "*.py" "*.md"` | Дополнительные шаблоны включения |
| `--exclude "tests/" "*.log"` | Дополнительные шаблоны исключения |
| `--max-size 500000` | Макс. размер файла в байтах (по умолчанию 200 КБ) |

## Режимы вывода

- При `--readme`: создаётся `README.md` в корне проекта.
- При `--mkdocs`: генерируется:
  - `.ai-docs/` — Markdown-файлы документации
  - `mkdocs.yml` — конфигурация сайта
  - (опционально) `ai_docs_site/` — собранный сайт (если запущена сборка MkDocs)

## Фильтрация файлов

Файлы фильтруются по:
- `.gitignore` (автоматически загружается)
- Встроенным правилам:
  - **Исключаются**: `.git`, `node_modules`, `.venv`, `__pycache__`, `dist`, `build`, `.ai-docs/`, `.ai_docs_cache/`
  - **Включаются по умолчанию**: исходный код, конфиги (`.yml`, `.json`), Docker, CI/CD, документация

Используйте `--include` и `--exclude` для переопределения.

## Кэширование

Инструмент использует кэш для ускорения повторных запусков:
- Расположение: `.ai_docs_cache/` (настраивается через `--cache-dir`)
- Содержит:
  - `llm_cache.json` — закэшированные ответы LLM
  - `index.json` — хеши файлов и метаданные

При следующем запуске анализируются только изменённые файлы.

## Особенности окружения

- **Требуется Python 3.8+**
- **Зависимости**: `tiktoken`, `PyYAML`, `requests`, `python-dotenv`
- **Бинарные файлы** автоматически пропускаются (проверка по первым 2048 байтам)
- **Символические ссылки** игнорируются
- Все пути нормализуются в POSIX-формат (`/`)

## Пример полного запуска

```bash
# Установка (если не установлена)
pip install ai-docs

# Настройка окружения
echo "OPENAI_API_KEY=sk-..." > .env
echo "AI_DOCS_THREADS=6" >> .env

# Запуск
ai_docs \
  --source . \
  --readme \
  --mkdocs \
  --language ru \
  --threads 6 \
  --include "*.py" "*.yml" "*.md" \
  --exclude "migrations/" "*.log" \
  --max-size 500000 \
  --local-site
```

После выполнения:
- Обновлён `README.md`
- Сгенерированы `.ai-docs/*.md`
- Создан `mkdocs.yml`
- Обновлён `.ai_docs_cache/`
