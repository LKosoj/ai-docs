# Соглашения

В проекте `ai_docs` действуют строгие соглашения по структуре, именованию, обработке данных и взаимодействию с системой. Эти правила обеспечивают предсказуемость, воспроизводимость и масштабируемость генерации документации.

## Структура проекта и директории

- **`.ai-docs/`** — основная рабочая директория, содержит:
  - `_index.json` — навигационный индекс с метаданными файлов, доменами, приоритетами.
  - `index.md`, `architecture.md`, `dependencies.md`, `changes.md` и другие разделы документации.
  - Поддиректории `modules/`, `configs/` — автоматически сгенерированные описания.
- **`.ai_docs_cache/`** — кэш LLM-запросов и хэшей файлов:
  - `llm_cache.json` — закэшированные ответы LLM (ключ — SHA256 от payload).
  - `index.json` — хэши и метаданные файлов для инкрементального анализа.
- **`docs/`** — выходная директория для MkDocs (генерируется при `--mkdocs`).
- **`mkdocs.yml`** — конфигурация сайта, создаётся автоматически.

> ⚠️ Все перечисленные директории и файлы **не должны редактироваться вручную**. Любые изменения будут перезаписаны при следующем запуске.

## Именование и форматирование файлов

- Имена файлов документации генерируются на основе **относительного пути исходного файла**:
  - Символы `/`, `\`, `:`, `?`, `*`, `"` заменяются на `-`.
  - Расширение заменяется на `.md`.
  - Пример: `src/utils/helpers.py` → `src-utils-helpers.md`.
- Заголовки в Markdown автоматически локализуются через `SECTION_TITLES` и `DOMAIN_TITLES` (поддержка `ru`, `en`).
- Все выходные `.md`-файлы сохраняются в UTF-8 без BOM.

## Классификация файлов

Тип файла определяется по расширению, имени и пути:

| Тип | Критерии |
|-----|--------|
| **Код** | Расширения из `CODE_EXTENSIONS` (`.py`, `.js`, `.go`, `.java`, `.cpp` и др.) |
| **Конфигурация** | Расширения из `CONFIG_EXTENSIONS` (`.yaml`, `.toml`, `.json`, `.env`) или имена вроде `Dockerfile`, `Makefile`, `requirements.txt` |
| **Документация** | Расширения `.md`, `.rst`, `.txt` |
| **CI/CD** | Имена `Jenkinsfile`, `.gitlab-ci.yml`, `*.github/workflows/*` |
| **Инфраструктура** | Определяется по доменам: `k8s`, `terraform`, `docker`, `ansible` и др. |

Используются встроенные наборы:
```python
TERRAFORM_EXTENSIONS = {".tf", ".tfvars"}
DOCKER_FILENAMES = {"Dockerfile", ".dockerignore"}
CI_FILENAMES = {"Jenkinsfile", "azure-pipelines.yml"}
```

## Фильтрация и игнорирование

Файлы исключаются по следующим правилам (в порядке приоритета):

1. **Обязательные исключения** (`DEFAULT_EXCLUDE_PATTERNS`):
   - `.git/`, `.svn/`, `__pycache__/`
   - `.venv/`, `venv/`, `node_modules/`
   - `dist/`, `build/`, `*.egg-info/`, `.mypy_cache/`
   - `.ai-docs/`, `.ai_docs_cache/`

2. **`.gitignore`** — применяется автоматически, если файл существует.

3. **`.build_ignore`** — пользовательские шаблоны исключения (аналог `.gitignore`).

4. **Конфиг `.ai-docs.yaml`**:
   ```yaml
   exclude:
     - "*.log"
     - "temp/"
   ```

5. **Размер файла** — превышает `max_size` (по умолчанию 200 000 байт).

Файлы, соответствующие `FIXED_INCLUDE_PATTERNS`, **всегда включаются**, даже если попадают под игнор:
- `*.tf`, `*.hcl`, `Dockerfile`, `docker-compose.yml`, `package.json`, `pyproject.toml`, `*.lock`

## Работа с кэшем

- Кэширование включено по умолчанию.
- Используется два уровня:
  1. **Файловый кэш** — `CacheManager` сравнивает хэши (`SHA-256`) файлов для определения изменений.
  2. **LLM-кэш** — ответы моделей кэшируются по хешу JSON-представления запроса.
- Отключить кэширование можно через:
  - CLI: `--no-cache`
  - Переменную окружения: не используется (управление только через флаг).
- При `--force` перезаписывается только `README.md`, но **не очищается кэш LLM**.

## Обработка контекста и токенов

- Текст разбивается на чанки с помощью `chunk_text()` на основе токенизации `tiktoken`.
- Используется кодировка `cl100k_base` (совместима с `gpt-4`, `gpt-3.5-turbo`).
- Лимит на чанк: `max_tokens` (по умолчанию 1200).
- Общий лимит контекста: `context_limit` (по умолчанию 8192).
- Перед отправкой в LLM применяется `_truncate_context()` для укладывания в лимит.

## Безопасность и надёжность

- Все временные директории (например, при клонировании Git) удаляются после завершения.
- Чтение файлов — только в UTF-8, с проверкой на бинарные данные (наличие `\x00`).
- Пути нормализуются в POSIX-формат (`/`), даже на Windows.
- URL-источники проверяются по префиксу (`http://`, `https://`, `git@`).

## Локализация

- Язык документации задаётся через `--language` (по умолчанию `ru`).
- Поддерживаются:
  - Заголовки разделов (`SECTION_TITLES`)
  - Названия доменов (`DOMAIN_TITLES`)
  - Тексты шаблонов (в `.md`-файлах)
- Язык вывода **всегда соответствует языку запроса пользователя** при использовании `.ai-docs` как источника контекста.

## Инкрементальная обработка

При каждом запуске:
1. Сравнивается текущее состояние файлов с `CacheManager.index`.
2. Определяются:
   - `added` — новые файлы
   - `modified` — изменённые
   - `deleted` — удалённые
   - `unchanged` — без изменений
3. Перегенерируются только сводки для `added` и `modified`.
4. Обновляется `changes.md` с детализацией изменений.
5. Обновляется `mkdocs.yml` и навигация, если структура изменилась.

> ✅ Это позволяет быстро обновлять документацию в больших проектах.

Соблюдение этих соглашений гарантирует стабильную и предсказуемую работу `ai_docs`.
