# Соглашения

## Файловая структура

После запуска `ai_docs` в проекте создаются следующие артефакты:

```
<проект>/
├── README.md                     # Краткое описание проекта (опционально)
├── .ai-docs/                     # Сгенерированные страницы документации
│   ├── overview.md
│   ├── architecture.md
│   ├── configs/
│   └── changes.md                # Отчёт об изменениях с последнего запуска
├── mkdocs.yml                    # Конфигурация сайта (если --mkdocs)
├── .ai_docs_cache/               # Кэш LLM-обработки (по умолчанию)
└── ai_docs_site/                 # Собранный статический сайт (при сборке)
```

- `.ai-docs/` — основная директория с Markdown-файлами документации.
- `.ai_docs_cache/` — скрытая директория с `index.json` (хеши файлов) и `llm_cache.json` (кешированные ответы LLM).
- `ai_docs_site/` — выводится вне `.ai-docs/`, чтобы не мешать версионному контролю.

## Именование и безопасность имён

- Имена файлов в `.ai-docs/` нормализуются через `safe_slug()`: удаляются спецсимволы, заменяются на `_`, приводятся к нижнему регистру.
- Пути всегда преобразуются в POSIX-формат (`/` как разделитель) с помощью `to_posix()`.
- Для избежания коллизий используются хеши SHA-256 (например, в кэше LLM и индексации файлов).

## Фильтрация файлов

По умолчанию сканируются только текстовые файлы, подходящие для анализа:

| Категория | Включено по умолчанию |
|---------|----------------------|
| **Исходный код** | `.py`, `.js`, `.ts`, `.go`, `.java`, `.rs`, `.rb`, `.php`, `.cs`, `.kt`, `.swift` и др. |
| **Конфигурации** | `.yml`, `.yaml`, `.json`, `.toml`, `.ini`, `.env`, `.cfg`, `.conf` |
| **Документация** | `.md`, `.rst`, `.adoc`, `.txt` |
| **CI/CD** | `.gitlab-ci.yml`, `Jenkinsfile`, `.github/workflows/`, `azure-pipelines.yml` |
| **Инфраструктура** | `Dockerfile`, `docker-compose.yml`, `.tf`, `Chart.yaml`, `kustomization.yaml` |

**Исключаются автоматически:**
- `.git/`, `.venv/`, `venv/`, `node_modules/`, `__pycache__/`, `dist/`, `build/`, `.mypy_cache/`
- Файлы > 200 КБ (настраивается через `--max-size`)
- Бинарные файлы (определяются по наличию нулевых байтов в первых 2048 байтах)
- Символические ссылки

Фильтрация учитывает `.gitignore` и может быть переопределена через `--include` / `--exclude`.

## Классификация файлов

Используются функции:
- `classify_type()` — возвращает тип: `code`, `config`, `docs`, `data`, `infra`, `ci`, `other`.
- `detect_domains()` — определяет технологии: `docker`, `kubernetes`, `helm`, `terraform`, `ansible`, `ci`.
- `is_infra()` — проверяет, относится ли файл к инфраструктуре.

Пример:
```python
path = Path("k8s/deployment.yaml")
classify_type(path)        # → "config"
detect_domains(path, "")   # → {"kubernetes"}
is_infra({"kubernetes"})   # → True
```

## Кэширование

- **LLM-кэш**: ответы моделей кэшируются по SHA-256 хешу нормализованного JSON-запроса.
- **Файловый индекс**: в `.ai_docs_cache/index.json` хранятся хеши файлов для определения изменений.
- Кэши потокобезопасны (используется `threading.Lock`).
- Отключается флагом `--no-cache`.

## Работа с токенами

- Подсчёт токенов — через `tiktoken` с поддержкой `cl100k_base` (GPT-3.5, GPT-4).
- Текст разбивается на чанки с `chunk_text(text, model, max_tokens)`.
- Ограничения:
  - `OPENAI_MAX_TOKENS` — максимум в ответе (по умолчанию 1200).
  - `OPENAI_CONTEXT_TOKENS` — общий лимит контекста (по умолчанию 8192).
- При генерации учитываются бюджеты, чтобы не превысить лимиты модели.

## Генерация документации

- Все промпты формируются с учётом `language` (`ru` по умолчанию).
- Поддерживается параллельная обработка через `ThreadPoolExecutor` (настраивается `--threads` или `AI_DOCS_THREADS`).
- Генерируются:
  - `README.md` — краткий обзор проекта.
  - `.ai-docs/` — полная документация (архитектура, домены, зависимости).
  - `mkdocs.yml` — конфигурация сайта (включая Mermaid и поиск).
- При `--local-site` в `mkdocs.yml` устанавливаются:
  ```yaml
  site_url: ""
  use_directory_urls: false
  ```

## Отчёт об изменениях

Файл `.ai-docs/changes.md` содержит:
- Добавленные, изменённые, удалённые файлы.
- Перегенерированные разделы.
- Краткое резюме изменений.

Форматируется через `format_changes_md()` с группировкой по секциям:

```markdown
## Добавленные файлы
- src/new_module.py

## Изменённые файлы
- config/app.yaml

## Перегенерированные разделы
- Архитектура
- Зависимости

## Краткое резюме
Обновлены конфигурации, добавлен новый модуль.
```

## Переменные окружения

| Переменная | Назначение | По умолчанию |
|-----------|------------|--------------|
| `OPENAI_API_KEY` | Ключ доступа к LLM | Обязательна |
| `OPENAI_BASE_URL` | Базовый URL API | `https://api.openai.com/v1` |
| `OPENAI_MODEL` | Модель для генерации | `gpt-4o-mini` |
| `OPENAI_TEMPERATURE` | Креативность (0.0–2.0) | `0.2` |
| `OPENAI_MAX_TOKENS` | Макс. токенов в ответе | `1200` |
| `OPENAI_CONTEXT_TOKENS` | Лимит контекста | `8192` |
| `AI_DOCS_THREADS` | Количество потоков | Зависит от CPU |
| `AI_DOCS_LOCAL_SITE` | Локальный режим MkDocs | `false` |
