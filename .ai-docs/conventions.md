# Соглашения

В проекте используются единые соглашения по структуре, именованию и обработке файлов для обеспечения предсказуемости и автоматизации генерации документации.

## Структура проекта
- `.ai-docs/` — корневая директория сгенерированной документации:
  - `modules/` — описания модулей (по одному `.md` на файл кода).
  - `configs/` — документация по конфигурационным файлам.
  - `_index.json` — навигационный индекс с метаданными и приоритетами.
- `docs/` — финальная документация для MkDocs (копия `.ai-docs/` при сборке).
- `.ai_docs_cache/` — кэш LLM-запросов и хэшей файлов (`llm_cache.json`, `index.json`).
- `mkdocs.yml` — конфигурация сайта, генерируется автоматически.
- `ai_docs_site/` — результат выполнения `mkdocs build`.

## Именование и пути
- Имена файлов документации нормализуются:
  - Замена `/`, `\`, `.` на `-`.
  - Преобразование в lowercase.
  - Пример: `src/utils/helper.py` → `modules/src-utils-helper.md`.
- Slug-идентификаторы генерируются через `slugify()` с использованием только допустимых ASCII-символов.
- Все пути в `_index.json` и навигации используют POSIX-формат (`/`), даже на Windows.

## Классификация файлов
Тип файла определяется по расширению, имени и пути:
- **Код**: `*.py`, `*.js`, `*.go` и др. из `CODE_EXTENSIONS`.
- **Конфигурации**: `*.yaml`, `*.toml`, `*.tf`, `.env` и др. из `CONFIG_EXTENSIONS`.
- **Документация**: `*.md`, `README*`, `CHANGELOG*`.
- **CI/CD**: файлы с именами `Dockerfile`, `.gitlab-ci.yml`, `Jenkinsfile` и др.

Домены (инфраструктура) определяются по ключевым файлам:
- `Kubernetes`: `*.yaml` с `apiVersion: v1`, `kustomization.yaml`.
- `Terraform`: `*.tf`, `terraform.tfstate`.
- `Helm`: `Chart.yaml`, `templates/`.
- `Docker`: `Dockerfile`, `docker-compose.yml`.

## Формат вывода
- Все сгенерированные `.md`-файлы:
  - В UTF-8.
  - С заголовком первого уровня (`#`) — название файла или модуля.
  - С разметкой Mermaid для диаграмм (в разделе архитектуры).
  - С переносами строк в Unix-стиле (`\n`).
- `_index.json` содержит:
  ```json
  {
    "files": {
      "relative/path/file.py": {
        "type": "code",
        "domains": ["terraform", "ci_cd"],
        "hash": "sha256...",
        "summary_path": "modules/..."
      }
    },
    "navigation": [...]
  }
  ```

## Обработка изменений
- При запуске `ai_docs`:
  - Сравнивается хэш каждого файла с `index.json`.
  - Определяются: `added`, `modified`, `deleted`.
  - Перегенерируются только затронутые файлы и зависимые разделы (например, `dependencies.md`).
- В `changes.md` фиксируются:
  - Списки изменённых файлов.
  - Перегенерированные разделы.
  - Итоговое резюме изменений в Markdown.

## Работа с кэшем
- Кэширование LLM-запросов:
  - Ключ — SHA256 от сериализованного payload.
  - Хранится в `.ai_docs_cache/llm_cache.json`.
  - Потокобезопасная запись через `threading.Lock`.
- Кэш файлов (`index.json`):
  - Содержит хэши и метаданные.
  - Используется для инкрементальной обработки.
  - Обновляется после успешной генерации.

## Язык и локализация
- Язык документации задаётся через `--language` (по умолчанию `ru`).
- Все заголовки и шаблоны берутся из `SECTION_TITLES` и `DOMAIN_TITLES` по языку.
- Пример:
  ```python
  SECTION_TITLES = {
      "ru": {"architecture": "Архитектура"},
      "en": {"architecture": "Architecture"}
  }
  ```

Соблюдение этих соглашений позволяет системе корректно анализировать, кэшировать и обновлять документацию без ручного вмешательства.
