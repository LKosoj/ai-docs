# Соглашения

```markdown
## Соглашения

### Именование и структура файлов
- Все сгенерированные файлы сохраняются в формате **Markdown (`.md`)**.
- Имена файлов приводятся к безопасному формату через `safe_slug`:  
  - Заменяются все неалфавитно-цифровые символы на `_`.  
  - Результат приводится к нижнему регистру.  
  - Удаляются ведущие и завершающие `_`.  
  Пример: `My Module v2!` → `my_module_v2`.
- Структура выходной директории:
  ```
  .ai-docs/               # Исходники для MkDocs
  ├── index.md
  ├── changes.md
  ├── modules/
  │   └── <module_slug>.md
  └── sections/
      └── <section>.md
  ai_docs_site/           # Собранный сайт (не коммитится)
  .ai_docs_cache/         # Кэш LLM и индексов (не коммитится)
  ```

### Классификация файлов
Тип файла определяется автоматически:
- **`code`**: исходный код (`.py`, `.js`, `.go` и др.).
- **`docs`**: документация (`.md`, `.rst`).
- **`config`**: конфиги (`.yaml`, `.json`, `.env`).
- **`data`**: данные (`.csv`, `.parquet`).
- **`infra`**: инфраструктурные файлы (Terraform, Docker, Helm).
- **`ci`**: CI/CD-конфигурации (`.gitlab-ci.yml`, `Jenkinsfile`).
- **`other`**: всё остальное.

### Определение технологических доменов
Файл может относиться к одному или нескольким доменам:
- **`docker`**: `Dockerfile`, `docker-compose.yml`.
- **`kubernetes`**: `deployment.yaml`, `kustomization.yml`, наличие `apiVersion` + `kind`.
- **`helm`**: `Chart.yaml`, пути `/charts/`, `/templates/`.
- **`terraform`**: `.tf`, `.tfvars`, упоминание `terraform` в пути.
- **`ansible`**: пути `/ansible/`, `/roles/`, `/tasks/`.
- **`ci`**: CI-файлы или `.github/workflows/`.

Если файл относится к любому из доменов `kubernetes`, `helm`, `terraform`, `ansible`, `docker`, `ci` — он считается **инфраструктурным** (`is_infra=True`).

### Обработка бинарных файлов
- Файл считается бинарным, если в первых 2048 байтах содержится нулевой байт (`\x00`).
- Бинарные файлы **не читаются и не анализируются**.
- Символические ссылки пропускаются.

### Фильтрация файлов при сканировании
Учитываются:
- `.gitignore`
- `.build_ignore` (кастомный файл исключений)
- Встроенные исключения: `node_modules`, `.venv`, `.env`, `__pycache__`, `.pytest_cache`, `.mypy_cache`, `.github/`, `.git/`

Файлы включаются, если:
- Соответствуют `include`-паттернам (по умолчанию — код, конфиги, документация).
- Не попадают под `exclude`-паттерны.
- Размер ≤ 200 КБ.
- Не являются бинарными.

### Кэширование
- Используется директория `.ai_docs_cache/` (настраивается через `--cache-dir`).
- Кэшируются:
  - Хэши файлов (`index.json`).
  - Ответы LLM (`llm_cache.json`).
- Ключ кэша LLM — SHA-256 от нормализованного JSON-представления запроса.
- Кэш потокобезопасен (через `threading.Lock`).
- Отключение кэширования: флаг `--no-cache`.

### Работа с LLM
- Модель по умолчанию: `gpt-4o-mini`.
- Рекомендуемая температура: `0.2` (для предсказуемости технического текста).
- Максимальное количество токенов в ответе: `1200`.
- Общий лимит контекста: `8192`.
- Таймауты: 30 с (подключение), 120 с (ответ).
- При повторных запусках используются закэшированные ответы при совпадении запроса.

### Параллелизация
- Обработка файлов — многопоточная (через `ThreadPoolExecutor`).
- Количество потоков: значение `--threads` или переменной `AI_DOCS_THREADS`.
- Ограничение на генерацию секций: не более 4 потоков (`section_workers`).

### Язык документации
- Поддерживаемые языки: `ru` (по умолчанию), `en`.
- Все заголовки, описания и шаблоны локализованы.
- Названия разделов в `mkdocs.yml` адаптируются под язык.

### Генерация `mkdocs.yml`
- `docs_dir`: `.ai-docs`
- `site_dir`: `ai_docs_site`
- Плагины: `search`, `mermaid2`
- Расширения Markdown: `pymdownx.superfences`
- При `--local-site`:
  - Убирается `site_url`.
  - `use_directory_urls: false`.

### Обработка изменений
После генерации формируется отчёт `changes.md` с группами:
- **Добавленные файлы**
- **Изменённые файлы**
- **Удалённые файлы**
- **Перегенерированные разделы**
- **Краткое резюме**

Если группа пуста — выводится «- нет».

### Безопасность и отказоустойчивость
- Все операции чтения файлов используют `errors="ignore"` при декодировании UTF-8.
- Временные репозитории (при `--source URL`) удаляются после завершения.
- При ошибках доступа к файлу он считается бинарным и пропускается.
- Неизвестные модели LLM используют резервную кодировку `cl100k_base`.
```
