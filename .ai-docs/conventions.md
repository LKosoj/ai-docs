# Соглашения

## Файловая структура

После выполнения `ai_docs` в проекте появляются следующие артефакты:

```
project-root/
├── .ai-docs/                 # Генерируемая документация (детальные описания, модули)
├── .ai_docs_cache/           # Кэш анализа и LLM-ответов (index.json, llm_cache.json)
├── ai_docs_site/             # Сгенерированный MkDocs-сайт (при --mkdocs)
├── README.md                 # Основной обзор проекта (при --readme)
├── mkdocs.yml                # Конфигурация сайта (генерируется автоматически)
├── .ai-docs.yaml             # Опциональная кастомизация сканирования и фильтрации
└── .ai_docs_ignore           # Устаревшее, заменено на .build_ignore и exclude в .ai-docs.yaml
```

- **`.ai-docs`** — основная выходная директория. Содержит:
  - `index.md` — главная страница документации.
  - `architecture.md`, `dependencies.md`, `conventions.md` — ключевые разделы.
  - `modules/` — детальные описания модулей.
  - `_index.json` — навигационный индекс с приоритетами и структурой.

- **`.ai_docs_cache`** — не удалять вручную. Хранит:
  - `index.json` — хэши и метаданные файлов для инкрементального анализа.
  - `llm_cache.json` — закэшированные ответы LLM (ключ — SHA256 от payload).

## Именование и форматирование

- Все генерируемые `.md`-файлы используют **Markdown GFM**.
- Имена файлов в `modules/` нормализуются в `slug`-формат:  
  `src/utils/helpers.py` → `src_utils_helpers.md`
- Заголовки в документации соответствуют языку (`--language`):
  - `ru`: "Архитектура", "Зависимости", "Соглашения"
  - `en`: "Architecture", "Dependencies", "Conventions"
- Внутренние ссылки в Markdown используют относительные пути:  
  `[Модули](modules/)` → `/modules/`

## Фильтрация файлов

Файлы включаются/исключаются по следующим правилам:

### Включение
- **Обязательно включаются**:
  - Terraform: `.tf`, `.tfvars`
  - Docker: `Dockerfile`, `.dockerignore`
  - CI/CD: `.gitlab-ci.yml`, `.github/workflows/`
  - Lock-файлы: `package-lock.json`, `poetry.lock`
- **Кастомизация**:
  - Через `.ai-docs.yaml`:
    ```yaml
    code_extensions: [".py", ".ts", ".go"]
    config_extensions: [".yaml", ".toml"]
    doc_extensions: [".md", ".rst"]
    ```

### Исключение
- **По умолчанию**:
  - `.git/`, `__pycache__/`, `node_modules/`, `.venv/`, `.env`
  - Бинарные файлы (определяются по наличию нулевых байтов)
  - Сборочные артефакты: `*.log`, `*.tmp`, `*.exe`
- **Дополнительно**:
  - Правила из `.gitignore`
  - Пользовательские шаблоны в `.ai-docs.yaml`:
    ```yaml
    exclude:
      - "tests/"
      - "**/*.test.*"
      - "temp/"
    ```
- **Ограничение по размеру**: файлы > `200 000` байт (настраивается через `--max-size`)

## Работа с LLM

- **Модель**: задаётся через `OPENAI_MODEL` (по умолчанию `gpt-4o-mini`).
- **Кэширование**: включено по умолчанию. Отключается флагом `--no-cache`.
- **Параллелизм**: управляет `--threads` или `AI_DOCS_THREADS` (рекомендуется 4–8).
- **Токены**:
  - `OPENAI_MAX_TOKENS` — максимум в ответе (по умолчанию 1200).
  - `OPENAI_CONTEXT_TOKENS` — общий лимит контекста (по умолчанию 8192).
- Все запросы к LLM хешируются по SHA256 от полного payload.

## Режимы генерации

| Флаг | Результат |
|------|-----------|
| Без флагов | Генерирует `README.md` и `mkdocs.yml` + сайт в `ai_docs_site/` |
| `--readme` | Только `README.md` |
| `--mkdocs` | Только `mkdocs.yml` и сайт |
| `--force` | Перезаписывает существующий `README.md` |

## Интеграция в CI/CD

- Поддерживает повторные запуски: использует кэш для ускорения.
- При изменении только одного файла — перегенерирует только связанные разделы.
- В `docs/changes.md` сохраняется отчёт об изменениях:
  - Добавленные/изменённые/удалённые файлы.
  - Перегенерированные разделы.
  - Краткое резюме изменений.

## Работа с репозиториями

- Поддержка:
  - Локальные пути: `./`, `/path/to/project`
  - Git-URL: `https://github.com/user/repo.git`
- При работе с URL:
  - Репозиторий клонируется во временный каталог.
  - После завершения — временная директория удаляется.
- Проверяется наличие `git` в `PATH`.

## Кастомизация через `.ai-docs.yaml`

Пример полной конфигурации:

```yaml
code_extensions:
  - ".py"
  - ".go"
  - ".ts"

config_extensions:
  - ".yaml"
  - ".json"
  - ".tfvars"

doc_extensions:
  - ".md"
  - ".rst"

exclude:
  - "tests/"
  - "mocks/"
  - "**/*.test.*"
  - ".env*"
```

- Файл опциональный. При отсутствии — используются настройки по умолчанию.
- Создаётся автоматически при первом запуске, если не найден.
