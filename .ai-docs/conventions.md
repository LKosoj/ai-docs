# Соглашения

Данный раздел описывает принятые соглашения по структуре, именованию, конфигурации и поведению инструмента `ai_docs`. Соблюдение этих правил обеспечивает предсказуемость, воспроизводимость и интегрируемость в CI/CD.

---

## Структура проекта

После выполнения `ai_docs` в корне проекта формируются следующие артефакты:

```
.
├── .ai-docs/               # Детальная документация (генерируется)
│   ├── modules/            # Описания модулей по файлам
│   ├── index.md            # Главная страница документации
│   ├── architecture.md     # Диаграммы и описание архитектуры
│   ├── dependencies.md     # Зависимости проекта
│   ├── conventions.md      # Соглашения по коду и инфраструктуре
│   └── _index.json         # Навигационный индекс (приоритеты, связи)
├── .ai_docs_cache/         # Кэш анализа и LLM-ответов (скрытый)
│   ├── index.json          # Хэши файлов и метаданные
│   └── llm_cache.json      # Кэш ответов модели
├── ai_docs_site/           # Собранный MkDocs-сайт (при --mkdocs)
├── mkdocs.yml              # Конфигурация сайта (генерируется)
├── README.md               # Краткая документация (при --readme)
└── .ai-docs.yaml           # Опциональная кастомизация (настраивается)
```

---

## Именование и пути

- Все пути в `_index.json`, `mkdocs.yml` и навигации используют **POSIX-формат** (`/`), независимо от ОС.
- Имена файлов в `.ai-docs/modules/` формируются как `slug(относительный_путь_к_файлу).md`.
- Slug-преобразование:
  - Заменяет пробелы и спецсимволы на `-`.
  - Приводит к нижнему регистру.
  - Удаляет недопустимые символы для имён файлов.
- Заголовки в Markdown генерируются с учётом языка (`--language`), но имена файлов — всегда на английском.

---

## Конфигурация

### `.ai-docs.yaml`

Опциональный файл для кастомизации поведения сканирования и фильтрации. Пример:

```yaml
code_extensions:
  .ts: TypeScript
  .kt: Kotlin
config_extensions:
  .yaml: YAML config
  .props: Java Properties
exclude:
  - temp/
  - "*.log"
  - "docs/drafts/"
```

- При отсутствии файла — создаётся с дефолтными расширениями.
- Поля:
  - `code_extensions`, `doc_extensions`, `config_extensions` — расширения с описаниями.
  - `exclude` — дополнительные glob-паттерны исключения (добавляются к дефолтным).
- Поддерживает комментарии и вложенность.

### Переменные окружения

| Переменная                | Назначение                                  | По умолчанию           |
|---------------------------|---------------------------------------------|------------------------|
| `OPENAI_API_KEY`          | Ключ для доступа к LLM                      | Обязательна            |
| `OPENAI_BASE_URL`         | Базовый URL API (для кастомных эндпоинтов)  | `https://api.openai.com/v1` |
| `OPENAI_MODEL`            | Модель LLM                                  | `gpt-4o-mini`          |
| `OPENAI_TEMPERATURE`      | Температура генерации                       | `0.2`                  |
| `OPENAI_MAX_TOKENS`       | Макс. токенов в ответе                      | `1200`                 |
| `OPENAI_CONTEXT_TOKENS`   | Общий лимит контекста                       | `8192`                 |
| `AI_DOCS_THREADS`         | Количество потоков обработки                | `4`                    |
| `AI_DOCS_LOCAL_SITE`      | Режим локального хостинга MkDocs            | `false`                |

> Переменные загружаются из `.env`, если файл существует.

---

## Фильтрация файлов

Файлы включаются/исключаются по следующим правилам:

1. **Всегда включаются** (даже если в `.gitignore`):
   - `*.tf`, `*.tfvars` (Terraform)
   - `Dockerfile`, `.dockerignore`
   - `k8s/`, `helm/`, `charts/`
   - `*.yml`, `*.yaml` в CI/CD-каталогах (`.github/workflows`, `.gitlab-ci.yml`)
   - `package.json`, `pyproject.toml`, `requirements.txt`

2. **Всегда исключаются**:
   - `node_modules/`, `__pycache__/`, `.venv/`, `.env/`
   - Скрытые директории (`.*`) кроме `.github`, `.gitlab`
   - Бинарные файлы (определяются по наличию нулевых байтов)
   - Файлы > `--max-size` (по умолчанию 200 КБ)

3. **Дополнительные правила**:
   - Учитываются `.gitignore` и `.build_ignore`.
   - Паттерны из `--include`, `--exclude` и `.ai-docs.yaml` применяются после базовых правил.
   - Приоритет: `--include` > `--exclude` > `.ai-docs.yaml` > дефолтные правила.

---

## Форматы документации

### Краткие описания (резюме)
- Генерируются для всех включённых файлов.
- Формат: Markdown, без заголовков верхнего уровня.
- Объём: до 3–5 предложений.
- Используется `SUMMARY_PROMPT`.

### Детализированная документация (Doxygen-style)
- Применяется для файлов с кодом (`*.py`, `*.ts`, `*.go` и др.).
- Содержит:
  - Назначение модуля
  - Интерфейсы, функции, классы
  - Параметры, возвращаемые значения
  - Примеры использования
- После генерации проходит нормализацию через `MODULE_SUMMARY_REFORMAT_PROMPT`.
- Удаляются лишние Markdown-блоки (```) и заголовки.

### Архитектура и зависимости
- Генерируются на основе анализа:
  - `pyproject.toml`, `package.json`, `go.mod` — зависимости.
  - `Dockerfile`, `k8s/`, `helm/` — инфраструктура.
  - `Makefile`, `scripts/` — CI/CD и запуск.
- Диаграммы — в формате Mermaid (встраивается в `architecture.md`).

---

## Кэширование

- Кэш хранится в `.ai_docs_cache/`.
- Два файла:
  - `index.json` — хэши файлов (SHA-256), типы, метаданные.
  - `llm_cache.json` — ответы LLM (ключ — SHA-256 от payload).
- Кэширование LLM включено по умолчанию. Отключается флагом `--no-cache`.
- Кэш обновляется после:
  - Успешной генерации аннотации.
  - Изменения состояния файлов.
- Потокобезопасен (используется `threading.Lock`).

---

## Поведение в CI/CD

- Поддерживает повторные запуски: анализ только изменённых файлов.
- Использует `diff_files()` для определения:
  - Добавленных
  - Изменённых
  - Удалённых
  - Неизменённых
- Генерирует отчёт `docs/changes.md` с перечислением:
  - Изменённых файлов
  - Перегенерированных разделов
  - Краткого резюме изменений
- При `--force` перезаписывает `README.md`, даже если он существует.

---

## Язык и локализация

- Язык задаётся через `--language` (`ru` или `en`, по умолчанию `ru`).
- Все заголовки разделов берутся из `SECTION_TITLES` и `DOMAIN_TITLES` (локализованные словари).
- Текст генерируется на указанном языке.
- Имена файлов, переменные, код — остаются на английском.

---

## Ошибки и отказоустойчивость

- Ошибки LLM логируются, но не прерывают выполнение.
- При сбое обработки файла:
  - Сохраняется ошибка в списке `errors`.
  - Файл пропускается, остальные обрабатываются.
- Кэш сохраняется после каждой ключевой операции.
- Временные директории (например, при клонировании из URL) удаляются автоматически.
