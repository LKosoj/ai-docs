# Соглашения

При работе с `ai_docs` и генерируемой документацией соблюдаются единые технические и стилистические соглашения. Они обеспечивают согласованность, читаемость и автоматическую обработку.

## Структура проекта

Генерируемая документация размещается в следующей структуре:

```
.ai-docs/
├── _index.json          # Навигационный индекс
├── changes.md           # Отчёт об изменениях
├── glossary.md          # Заглушка глоссария
├── dependencies.md      # Список зависимостей
├── modules/             # Описания модулей
├── configs/             # Документация конфигураций
└── js/mermaid.min.js    # Поддержка диаграмм Mermaid
```

- Все промежуточные данные и кэш хранятся в `.ai-docs/` и `.ai_docs_cache/`.
- Исходные файлы проекта не изменяются, если не указан флаг `--force`.

## Именование файлов

- Имена файлов в `modules/` и `configs/` нормализуются:
  - Удаляются недопустимые символы.
  - Пробелы заменяются на дефисы.
  - Пути преобразуются в slug-формат (например, `src/utils/helper.py` → `src-utils-helper.md`).
- Файлы сохраняются в UTF-8 без BOM.

## Форматирование Markdown

- Заголовки разделов используют `#`, `##`, `###` в соответствии с иерархией.
- Код оформляется в блоки с указанием языка:
  ````markdown
  ```python
  def example():
      pass
  ```
  ````
- Для конфигурационных блоков (YAML, JSON, TOML) используется перенос строк с `<br>` только при необходимости отображения в MkDocs.
- Ссылки на другие разделы — относительные (например, `[Модули](modules/)`).

## Классификация файлов

Файлы автоматически классифицируются по типу и домену:

| Тип           | Примеры расширений/имён                     |
|---------------|---------------------------------------------|
| `code`        | `.py`, `.js`, `.ts`, `.go`, `.java`, `.cpp` |
| `config`      | `.yaml`, `.yml`, `.json`, `.toml`, `.env`   |
| `docs`        | `.md`, `.rst`, `.txt`                       |
| `docker`      | `Dockerfile`, `.dockerignore`               |
| `terraform`   | `.tf`, `.tfvars`                            |
| `kubernetes`  | `k8s/`, `helm/`, `*.k8s.yaml`               |
| `ci`          | `.gitlab-ci.yml`, `.github/workflows/`      |

Домены определяются по наличию ключевых файлов или путей (например, `requirements.txt` → Python, `package.json` → JS/TS).

## Генерация контента

- Все описания генерируются с помощью LLM, с нормализацией вывода:
  - Для модулей — через `MODULE_SUMMARY_PROMPT`.
  - Для конфигов — через `CONFIG_SUMMARY_PROMPT`.
  - Общие резюме — через `SUMMARY_PROMPT`.
- Длинные файлы разбиваются на чанки (`chunk_text`) с учётом лимита токенов модели.
- Вывод LLM нормализуется: удаляются лишние префиксы, приводится к единому формату.

## Кэширование

- Результаты LLM-запросов кэшируются по SHA256 от payload.
- Состояние файлов отслеживается через `CacheManager`:
  - `index.json` — хэши и метаданные файлов.
  - `llm_cache.json` — ответы модели.
- При запуске с `--no-cache` кэш игнорируется, но не удаляется.

## Язык документации

- Язык задаётся флагом `--language` (по умолчанию `ru`).
- Все заголовки, описания и сообщения генерируются на указанном языке.
- Локализованные заголовки хранятся в `SECTION_TITLES`, `DOMAIN_TITLES`.

## Обработка изменений

После генерации формируется `changes.md` со списками:
- Добавленные файлы.
- Изменённые файлы.
- Удалённые файлы.
- Перегенерированные разделы.

Отчёт используется для аудита и CI/CD-интеграций.

## Работа с MkDocs

- Генерируется `mkdocs.yml` с поддержкой:
  - Плагина `mermaid2` для диаграмм.
  - Кастомной навигации из `_index.json`.
  - Локализованных заголовков.
- Сборка выполняется автоматически, если не указан `--local-site`.

## Безопасность и совместимость

- Бинарные файлы определяются по наличию нулевых байтов и исключаются из анализа.
- Симлинки обрабатываются, но не следуют за циклами.
- Поддерживается только UTF-8 кодировка текстовых файлов.

Соблюдение этих соглашений гарантирует стабильную и предсказуемую работу `ai_docs` в любых проектах.
