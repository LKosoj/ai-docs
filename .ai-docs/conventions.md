# Соглашения

В проекте `ai_docs` действуют чёткие соглашения по именованию, структуре файлов, обработке данных и взаимодействию с системой. Эти правила обеспечивают предсказуемость, воспроизводимость и масштабируемость процесса генерации документации.

## Именование и структура файлов

- **Конфигурационные файлы**:
  - `.ai-docs.yaml` — основной конфиг проекта (расширения, исключения).
  - `.ai_docs_cache/` — кэш LLM-запросов и хэшей файлов (не коммитится).
  - `.ai-docs/` — выходная директория с генерируемой документацией и метаданными.
  - `_index.json` — навигационный индекс, содержит структуру модулей, домены, приоритеты.

- **Генерируемые артефакты**:
  - `README.md` — краткая сводка проекта.
  - `mkdocs.yml` — конфигурация сайта документации.
  - `docs/` — директория с Markdown-файлами для MkDocs.
  - `changes.md` — отчёт об изменениях после генерации.

- **Безопасные имена файлов**:
  - Имена файлов в `modules/`, `configs/` нормализуются: удаляются недопустимые символы, используются slug-форматы.
  - Пример: `src/utils/helper.py` → `src_utils_helper.md`.

## Классификация файлов

Файлы автоматически классифицируются по типу и домену:

- **Типы**:
  - `code` — по расширениям из `CODE_EXTENSIONS` (`.py`, `.js`, `.go` и др.).
  - `config` — по `CONFIG_EXTENSIONS` (`.yaml`, `.toml`, `.json`) и ключевым именам (`Dockerfile`, `terraform.tf`, `k8s.yaml`).
  - `doc` — по `doc_extensions` (`.md`, `.rst`).
  - `ci` — по `CI_FILENAMES` (`Jenkinsfile`, `.gitlab-ci.yml`).

- **Домены инфраструктуры**:
  - Определяются по имени, пути и содержимому:
    - `kubernetes`, `helm`, `terraform`, `docker`, `ansible`, `observability`, `data`, `service_mesh`.
  - Используются для группировки в разделах документации.

## Обработка контекста и LLM

- **Ограничение токенов**:
  - Максимальный размер файла: `200 000` байт (настраивается через `--max-size`).
  - Текст разбивается на чанки с `chunk_text()` при превышении `max_tokens` (по умолчанию — лимит модели).
  - Используется `tiktoken` для точного подсчёта токенов.

- **Кэширование**:
  - Ключ кэша LLM — SHA256 от сериализованного payload.
  - Кэш хранится в `.ai_docs_cache/llm_cache.json`.
  - Повторные запросы с тем же контекстом не отправляются.
  - Отключается флагом `--no-cache`.

- **Параметры LLM**:
  - По умолчанию: `gpt-4o-mini`, `temperature=0.2`, `max_tokens=1200`.
  - Настраиваются через переменные окружения (`OPENAI_*`) или CLI.

## Фильтрация файлов

- **Включение**:
  - Всегда включаются: `README*`, `*.tf`, `Dockerfile`, `requirements.txt`, `pyproject.toml`, `package.json`, `*.lock`.
  - Дополнительные расширения — через `.ai-docs.yaml`.

- **Исключение**:
  - Стандартные паттерны: `.git`, `__pycache__`, `node_modules`, `.venv`, `dist`, `build`, `.ai-docs`, `.ai_docs_cache`.
  - Учитываются `.gitignore` и `.build_ignore`.
  - Дополнительные исключения — через поле `exclude` в `.ai-docs.yaml`.

## Поведение при генерации

- **Инкрементальная обработка**:
  - `CacheManager` сравнивает хэши файлов из `index.json`.
  - Обрабатываются только новые, изменённые или отсутствующие в кэше файлы.
  - Удалённые файлы удаляются из `docs/modules/`, `docs/configs/`.

- **Режимы вывода**:
  - По умолчанию: генерация `README.md` и `mkdocs`-сайта.
  - `--readme` — только `README.md`.
  - `--mkdocs` — только сайт.
  - `--force` — перезапись существующего `README.md`.

- **Локализация**:
  - Язык по умолчанию — `ru`.
  - Заголовки разделов локализованы через `SECTION_TITLES`, `DOMAIN_TITLES`.
  - Поддерживается только русский и английский.

## Работа с Git

- **Локальные репозитории**:
  - Сканируется рабочая директория.
  - `.gitignore` применяется автоматически.

- **Удалённые репозитории**:
  - Клонируются во временный каталог.
  - После обработки удаляются.
  - Требуется установленный `git`.

## Рекомендации по использованию

- Перед первым запуском выполните:
  ```bash
  ai-docs --source . --mkdocs --readme
  ```
- Для CI/CD:
  - Установите `OPENAI_API_KEY`.
  - Используйте `--local-site` для локальной сборки.
  - Сохраняйте `.ai_docs_cache/` между запусками для ускорения.

- Для разработки:
  - Просматривайте `.ai-docs/index.md` и `_index.json` для понимания структуры.
  - Обновляйте `.ai-docs.yaml` при добавлении новых типов конфигураций.

Соблюдение этих соглашений гарантирует стабильную и предсказуемую работу инструмента.
