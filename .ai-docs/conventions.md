# Соглашения

В проекте используются единые соглашения по структуре, именованию и обработке файлов для обеспечения предсказуемости и автоматизации генерации документации.

## Именование и структура файлов

- **Документация по модулям**:  
  Файлы размещаются в `.ai-docs/modules/`.  
  Имя файла — slug-версия исходного пути (например, `src__utils__helpers.py.md` для `src/utils/helpers.py`).  
  Замена `/` → `__`, удаление недопустимых символов.

- **Документация по конфигурациям**:  
  Файлы — в `.ai-docs/configs/`.  
  Аналогичное именование: `Dockerfile.md`, `k8s__deploy.yaml.md`.

- **Главная страница**:  
  `.ai-docs/index.md` — вводный раздел сайта MkDocs.  
  `README.md` — краткое описание проекта в корне.

- **Навигация**:  
  `.ai-docs/_index.json` — JSON-индекс с приоритетами, типами и путями модулей. Используется для построения `nav` в `mkdocs.yml`.

## Классификация файлов

Тип файла определяется по расширению, имени и пути:

| Тип | Критерии |
|-----|--------|
| `code` | Расширения из `CODE_EXTENSIONS` (`.py`, `.js`, `.go` и др.) |
| `config` | Из `CONFIG_EXTENSIONS` (`.yaml`, `.toml`, `.json`) или ключевые имена (`Dockerfile`, `Makefile`) |
| `doc` | `.md`, `.rst`, `.txt` |
| `test` | Содержит `test` в имени или пути |

Домены (инфраструктура) определяются по:
- `TERRAFORM_EXTENSIONS`, `K8S_FILENAMES`, `HELM_FILENAMES`, `DOCKER_FILENAMES`
- Наличию `requirements.txt`, `pyproject.toml`, `package.json` — для Python/JS

## Соглашения по обработке

- **Максимальный размер файла**: 200 КБ. Превышение — пропуск с логом.
- **Бинарные файлы**: определяются по наличию нулевых байтов. Не читаются.
- **Кодировка**: все текстовые файлы читаются как UTF-8. Ошибки заменяются.
- **Игнорирование**:  
  Учитываются:
  - `.gitignore`
  - `.build_ignore`
  - `.ai-docs.yaml` → `exclude`
  - Стандартные паттерны: `.venv`, `node_modules`, `__pycache__`, `dist`, `build`, `.ai-docs`, `.ai_docs_cache`

## Соглашения по кэшированию

- Кэш LLM-запросов: `.ai_docs_cache/llm_cache.json`  
  Ключ — SHA256 от сериализованного payload.
- Индекс файлов: `.ai_docs_cache/index.json`  
  Хранит хэши (SHA-256) и метаданные. Используется для инкрементальной обработки.
- При запуске с `--no-cache` кэш не используется, но не удаляется.

## Соглашения по генерации контента

- **Язык**: по умолчанию `ru`, задаётся через `--language` или `AI_DOCS_LANGUAGE`.
- **Заголовки разделов**: локализованы через `SECTION_TITLES`, `DOMAIN_TITLES`.
- **Шаблоны промптов**:  
  - `SUMMARY_PROMPT` — общий обзор файла.  
  - `MODULE_SUMMARY_PROMPT` — для модулей кода.  
  - `CONFIG_SUMMARY_PROMPT` — для конфигураций.  
  Все шаблоны поддерживают переменные: `{content}`, `{path}`, `{type}`, `{domains}`.

## Соглашения по навигации MkDocs

- Структура `nav` в `mkdocs.yml` строится динамически:
  - Группировка через `__` в именах файлов: `auth__login.py.md` → `Авторизация / Вход`.
  - Стандартные разделы: Главная, Архитектура, Зависимости, Тестирование, Изменения.
  - Авто-добавление доменных разделов: Kubernetes, Helm, Terraform — при обнаружении.

## Соглашения по логированию и отладке

- Прогресс отображается в реальном времени (через `tqdm` при многопоточной обработке).
- Ошибки чтения/обработки файла — логируются, но не прерывают выполнение.
- Для отладки: запуск через `python -m ai_docs.cli ...` с `--verbose` (если реализовано).
