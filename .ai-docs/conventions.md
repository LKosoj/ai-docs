# Соглашения

## Файловая структура

После запуска `ai_docs` в корне проекта или в указанной директории вывода формируется следующая структура:

```
.
├── README.md                     # Краткое описание проекта (генерируется при --readme)
├── mkdocs.yml                    # Конфигурация сайта документации (при --mkdocs)
├── .ai-docs/                     # Исходники документации в Markdown
│   ├── index.md                  # Главная страница
│   ├── changes.md                # Отчёт об изменениях
│   ├── modules/                  # Документация по модулям
│   │   └── <module_name>.md
│   └── <section>.md              # Доменные разделы (dependencies, architecture и др.)
├── ai_docs_site/                 # Собранный статический сайт (результат mkdocs build)
└── .ai_docs_cache/               # Кэш LLM и хешей файлов (если не переопределено)
    ├── index.json                # Хеши исходных файлов
    └── llm_cache.json            # Кэшированные ответы LLM
```

> **Примечание**: `.ai_docs_cache/` и `.ai-docs/` добавлены в `.gitignore` по умолчанию.

---

## Именование и пути

- **Безопасные имена файлов**: Все генерируемые имена файлов проходят через `safe_slug()`:
  - Недопустимые символы заменяются на `_`.
  - Кириллица транслитерируется.
  - Результат приводится к нижнему регистру.
- **Пути в навигации**: Используется POSIX-формат (`/`) независимо от ОС.
- **Слаги URL**: Для поддержки кириллицы в MkDocs используется `safe_slug()` при генерации `nav`.

---

## Классификация файлов

### Типы файлов (`classify_type`)
| Категория | Критерии |
|---------|--------|
| `code`  | Расширения: `.py`, `.js`, `.go`, `.java`, `.rs` и др. |
| `docs`  | `.md`, `.rst`, `.txt` |
| `config`| `.yml`, `.json`, `.toml`, `.env` |
| `data`  | `.csv`, `.parquet`, `.avro` |
| `infra` | `.tf`, `Dockerfile`, `kustomization.yaml` и др. |
| `ci`    | `.gitlab-ci.yml`, `Jenkinsfile`, `.github/workflows/` |
| `other` | Все остальные |

### Домены (`detect_domains`)
Определяются по имени, пути и содержимому:
- `docker`, `kubernetes`, `helm`, `terraform`, `ansible`, `ci`

Файл считается инфраструктурным (`is_infra=True`), если относится к одному из доменов.

---

## Фильтрация файлов

При сканировании учитываются:
1. `.gitignore`
2. `.build_ignore` (кастомные правила)
3. Встроенные исключения:
   - `node_modules/`, `.venv/`, `__pycache__/`
   - `.git/`, `.github/`, `.DS_Store`
   - `*.log`, `*.tmp`, `*.lock`

**Ограничения**:
- Максимальный размер файла: **200 КБ** (настраивается через `--max-size`).
- Бинарные файлы пропускаются (определяются по наличию `\x00` в первых 2048 байтах).
- Символические ссылки игнорируются.

---

## Работа с LLM

### Параметры по умолчанию
| Параметр | Значение | Назначение |
|--------|--------|----------|
| `model` | `gpt-4o-mini` | Модель для генерации |
| `temperature` | `0.2` | Низкая креативность, предсказуемость |
| `max_tokens` | `1200` | Макс. длина ответа |
| `context_limit` | `8192` | Общий лимит контекста |

> Рекомендуется `temperature=0.2` для технической документации.

### Кэширование
- Ключ кэша: SHA-256 от нормализованного JSON-представления запроса.
- Кэш хранится в `.ai_docs_cache/llm_cache.json`.
- Доступ к кэшу синхронизирован (`threading.Lock`).
- Отключается флагом `--no-cache`.

---

## Генерация документации

### Режимы
- `--readme`: Генерирует `README.md` в корне.
- `--mkdocs`: Создаёт `.ai-docs/` и `mkdocs.yml` для полноценного сайта.

### Язык
- По умолчанию: `ru`.
- Поддерживается: `ru`, `en`.
- Все заголовки и названия разделов локализованы.

### Параллелизм
- Управляется параметром `--threads` (или `AI_DOCS_THREADS`).
- Используется `ThreadPoolExecutor` для обработки файлов и разделов.

---

## MkDocs-интеграция

### Конфигурация (`mkdocs.yml`)
```yaml
site_name: <название проекта>
docs_dir: .ai-docs
site_dir: ai_docs_site
plugins:
  - search
  - mermaid2
markdown_extensions:
  - pymdownx.superfences
nav: <автогенерация по разделам и модулям>
```

### Особенности
- При `--local-site`:
  - Убирается `site_url`.
  - `use_directory_urls: false`.
- Поддержка Mermaid: диаграммы в разделе "Архитектура".
- Навигация строится иерархически по структуре модулей.

---

## Обработка изменений

При повторном запуске:
1. Сравниваются хеши файлов с предыдущим состоянием (`index.json`).
2. Определяются: `added`, `modified`, `deleted`, `unchanged`.
3. Перегенерируются только изменённые файлы и зависимые разделы.
4. Удаляются устаревшие `.md`-файлы в `.ai-docs/modules/`.

Отчёт об изменениях сохраняется в `.ai-docs/changes.md`.

---

## Переменные окружения

| Переменная | Назначение | Обязательная |
|-----------|-----------|-------------|
| `OPENAI_API_KEY` | Ключ доступа к LLM | Да |
| `OPENAI_BASE_URL` | Адрес API (по умолчанию OpenAI) | Нет |
| `OPENAI_MODEL` | Модель (по умолчанию `gpt-4o-mini`) | Нет |
| `OPENAI_TEMPERATURE` | Температура генерации | Нет |
| `OPENAI_MAX_TOKENS` | Макс. токенов в ответе | Нет |
| `OPENAI_CONTEXT_TOKENS` | Лимит контекста | Нет |
| `AI_DOCS_THREADS` | Количество потоков по умолчанию | Нет |
| `AI_DOCS_LOCAL_SITE` | Флаг локального развёртывания | Нет |

---

## CLI-аргументы

| Аргумент | Назначение |
|--------|-----------|
| `--source` | Путь или URL репозитория (обязательный) |
| `--output` | Директория вывода (по умолчанию: `output/<repo>`) |
| `--readme` | Генерировать `README.md` |
| `--mkdocs` | Генерировать MkDocs-сайт |
| `--language` | Язык (`ru`/`en`, по умолчанию `ru`) |
| `--threads` | Количество потоков |
| `--cache-dir` | Директория кэша (по умолчанию `.ai_docs_cache`) |
| `--no-cache` | Отключить кэширование LLM |
| `--local-site` | Настроить MkDocs для локального просмотра |
| `--force` | Перезаписать существующий `README.md` |
| `--include` / `--exclude` | Шаблоны включения/исключения файлов |
| `--max-size` | Макс. размер файла в байтах |
