# Соглашения

## Файловая структура и именование

- Все сгенерированные артефакты документации сохраняются в:
  - `README.md` — в корне проекта.
  - `docs/` — для полной документации в формате MkDocs.
  - `.ai-docs/` — служебная директория с навигационным индексом (`_index.json`), описаниями модулей, конфигураций и отчётом `changes.md`.
  - `.ai_docs_cache/` — кэш LLM-запросов и хэшей файлов.

- Имена файлов в `docs/modules/` и `docs/configs/` нормализуются:
  - Преобразуются в slug-формат (например, `src/utils/helper.py` → `src_utils_helper.md`).
  - Сохраняют вложенность через поддиректории.

## Классификация файлов

Тип файла определяется по расширению, имени и пути:

| Категория       | Критерии |
|-----------------|--------|
| **Код**         | Расширения из `CODE_EXTENSIONS` (`.py`, `.js`, `.go`, `.java`, `.cpp` и др.). |
| **Конфигурация**| Расширения из `CONFIG_EXTENSIONS` (`.yaml`, `.yml`, `.json`, `.toml`, `.tf`, `.hcl`) или имена вроде `Dockerfile`, `Makefile`, `Jenkinsfile`. |
| **Документация**| Расширения `.md`, `.rst`, `.txt`, а также файлы `README*`, `LICENSE`, `CHANGELOG`. |
| **CI/CD**       | Файлы в `.github/workflows`, `.gitlab-ci.yml`, `Jenkinsfile`, `azure-pipelines.yml`. |
| **Инфраструктура** | Обнаруживается по доменам: Kubernetes (`.yaml` с `apiVersion: v1`, `kind: Deployment`), Terraform (`.tf`), Helm (`Chart.yaml`), Docker (`Dockerfile`, `docker-compose.yml`). |

## Домены технологий

При анализе файлов определяются домены:

- `kubernetes`, `helm`, `terraform`, `ansible`, `docker`, `ci_cd`, `observability`, `service_mesh`, `data_storage`.

Используются для группировки в навигации и генерации разделов вроде **Инфраструктура** или **CI/CD**.

## Кэширование и инкрементальная обработка

- Кэш LLM-ответов хранится в `.ai_docs_cache/llm_cache.json` (ключ — SHA256 от payload).
- Индекс файлов — в `.ai_docs_cache/index.json` (содержит хэши, размеры, метаданные).
- При запуске:
  - Сравниваются текущие хэши файлов с кэшированными.
  - Обрабатываются только **новые**, **изменённые** или явно указанные (`--force`) файлы.
  - Удалённые файлы удаляются из `docs/`.

## Фильтрация файлов

Учитываются три уровня фильтрации:

1. **Обязательное включение**:
   - Файлы из `FIXED_INCLUDE_PATTERNS`: `*.tf`, `Dockerfile`, `requirements.txt`, `pyproject.toml`, `package.json`, `*.yaml` в `.github/`.
2. **Исключение по умолчанию**:
   - Директории: `.git`, `.venv`, `venv`, `node_modules`, `__pycache__`, `dist`, `build`, `.ai-docs`, `.ai_docs_cache`.
   - Шаблоны: `*.log`, `*.tmp`, `*.swp`.
3. **Пользовательские правила**:
   - Из `.gitignore` и `.build_ignore`.
   - Из `.ai-docs.yaml`:
     ```yaml
     exclude:
       - "*.bak"
       - "temp/"
     code_extensions:
       - ".kt"
     config_extensions:
       - ".conf"
     ```

## Язык и локализация

- По умолчанию — русский (`--language ru`).
- Заголовки разделов берутся из `SECTION_TITLES` и `DOMAIN_TITLES` (локализованные словари).
- Поддерживаемые языки: `ru`, `en`.

## Работа с LLM

- Используется OpenAI-совместимый API.
- Параметры по умолчанию:
  - Модель: `gpt-4o-mini`
  - Температура: `0.2`
  - Макс. токенов: `1200`
  - Контекст: `8192`
- Кэширование включено по умолчанию. Отключается флагом `--no-cache`.

## Поведение при генерации

- При `--readme` — обновляется `README.md`.
- При `--mkdocs` — генерируется `mkdocs.yml` и сайт в `site/`.
- При отсутствии флагов — генерируется всё.
- Если `README.md` существует и нет `--force` — пропускается.
- MkDocs собирается автоматически через `mkdocs build -f mkdocs.yml`.

## Переменные окружения

| Переменная               | Назначение | По умолчанию |
|--------------------------|------------|--------------|
| `OPENAI_API_KEY`         | Ключ API | Обязательна |
| `OPENAI_BASE_URL`        | Базовый URL | `https://api.openai.com/v1` |
| `OPENAI_MODEL`           | Модель LLM | `gpt-4o-mini` |
| `AI_DOCS_THREADS`        | Число потоков | `4` |
| `AI_DOCS_LOCAL_SITE`     | Локальная сборка (без публикации) | `false` |

## Работа с Git-репозиториями

- Поддерживаются URL вида `https://github.com/user/repo.git`.
- Репозиторий клонируется во временный каталог.
- После обработки временная директория удаляется.

## Обработка ошибок

- Ошибки чтения файлов логируются, но не прерывают выполнение.
- Бинарные файлы пропускаются (определяются по наличию нулевых байтов).
- Файлы > `max_size` (по умолчанию 200 КБ) игнорируются.
