# Соглашения

```markdown
# Соглашения

Данный раздел описывает ключевые соглашения, принятые в проекте `ai_docs`, для обеспечения согласованности, предсказуемости и поддерживаемости кода и генерируемой документации.

## Именование и форматирование

- **Имена файлов и директорий**:
  - Используется `snake_case` для всех файлов и директорий.
  - Служебные директории: `.ai-docs`, `.ai_docs_cache`, `.env`.
  - Генерируемые файлы: `README.md`, `mkdocs.yml`, `_index.json`.

- **Имена переменных и функций**:
  - В Python — `snake_case`.
  - Приватные функции и методы начинаются с подчёркивания: `_helper_function`.
  - Константы — `UPPER_SNAKE_CASE` (например, `DEFAULT_INCLUDE_PATTERNS`).

- **Форматирование кода**:
  - Соблюдается `black` с настройками по умолчанию.
  - Используется `isort` для сортировки импортов.
  - Документация в docstring — в формате Google Style.

## Работа с путями и файлами

- Все пути обрабатываются через `pathlib.Path`.
- Преобразование в строку для логирования или конфигурации — только через `to_posix()` для кроссплатформенности.
- Бинарные файлы определяются по наличию нулевых байтов в первых 2048 байтах.
- Текстовые файлы читаются с `errors="ignore"` для устойчивости к битым символам.

## Классификация и метаданные

- **Типы файлов**:
  - `code`, `config`, `docs`, `infra`, `ci`, `data`, `other`.
  - Определяется по расширению, имени файла и пути.

- **Домены инфраструктуры**:
  - Определяются по эвристикам: имена файлов (`Dockerfile`, `kustomization.yaml`), ключевые слова в содержимом (`apiVersion`, `kind`, `resource`), маркеры в путях (`/k8s/`, `/terraform/`).
  - Поддерживаемые домены: `kubernetes`, `docker`, `terraform`, `helm`, `ci`, `observability`, `service_mesh`, `data_storage`.

- **Инфраструктурный файл**:
  - Файл считается инфраструктурным, если в его доменах есть хотя бы один из `infra`-типов (определяется через `is_infra(domains)`).

## Обработка контента

- **Токенизация**:
  - Используется `tiktoken` с кодировкой `cl100k_base` (совместимо с `gpt-3.5-turbo`, `gpt-4`).
  - При неизвестной модели — fallback на `cl100k_base`.
  - Фрагментация текста (`chunk_text`) — по максимальному количеству токенов с учётом модели.

- **Генерация документации**:
  - Режимы: краткое резюме (`detailed=False`) и детальное описание в стиле Doxygen (`detailed=True`).
  - Перед сохранением текст проверяется на соответствие Doxygen-формату (`_needs_doxygen_fix`) и при необходимости нормализуется через LLM.

- **Кэширование**:
  - Кэш LLM: хранится в `llm_cache.json`, ключ — SHA-256 нормализованного JSON-запроса.
  - Кэш файлов: `index.json` содержит хеши (`sha256_text`) для отслеживания изменений.
  - Кэширование потокобезопасно (через `threading.Lock`).

## Конфигурация и окружение

- **`.env`**:
  - Создаётся на основе `.env.example`.
  - Поддерживает переопределение через переменные окружения.
  - Ключевые переменные:
    - `OPENAI_API_KEY` — обязательна.
    - `OPENAI_BASE_URL`, `OPENAI_MODEL`, `OPENAI_MAX_TOKENS`, `OPENAI_CONTEXT_TOKENS`, `OPENAI_TEMPERATURE` — опциональные.
    - `AI_DOCS_THREADS` — количество потоков по умолчанию.
    - `AI_DOCS_LOCAL_SITE` — режим локального развёртывания MkDocs.

- **CLI-аргументы**:
  - Приоритет: CLI > переменные окружения > значения по умолчанию.
  - Все пути нормализуются и проверяются на существование (если применимо).
  - Язык документации: `--language` (по умолчанию `ru`).

## Структура генерируемой документации

- Корневая директория: `.ai-docs/`.
- Поддиректории:
  - `modules/` — страницы по модулям.
  - `cache/` — кэш LLM и индексов.
- Ключевые файлы:
  - `_index.json` — метаданные, навигация, приоритеты.
  - `mkdocs.yml` — конфигурация сайта.
  - `README.md` — краткое описание проекта (генерируется при `--readme`).

## Обработка ошибок и отказоустойчивость

- Ошибки при чтении файлов (например, кодировка) — игнорируются, файл пропускается.
- Ошибки при клонировании Git-репозитория — временная директория удаляется.
- Ошибки API LLM — логируются, при повторных сбоях — прерывание с сообщением.
- Отсутствие `.ai-docs/` в скиле `documentary` — немедленный выход с инструкцией.

## Тестирование

- Все тесты используют изолированные временные директории (`tempfile.TemporaryDirectory`).
- Проверяются граничные случаи: пустые директории, бинарные файлы, игнорируемые пути, отсутствующие файлы.
- Юнит-тесты покрывают: сканирование, кэширование, форматирование, классификацию.

Соблюдение этих соглашений обязательно для всех участников проекта.
```
