# Соглашения

При работе с `ai_docs` и генерируемой документацией соблюдаются единые технические и стилистические соглашения, обеспечивающие согласованность, читаемость и автоматическую обработку.

## Файловая структура

Генерируемая документация размещается в следующих директориях:

- `.ai-docs/` — основная директория с документацией:
  - `index.md` — главная страница сайта.
  - `_index.json` — навигационный индекс с метаданными (приоритеты, зависимости, домены).
  - `architecture.md`, `testing.md`, `dependencies.md` — автоматически сгенерированные разделы.
  - `modules/`, `configs/` — детальные описания модулей и конфигураций.
- `.ai_docs_cache/` — кэш LLM-запросов и хэшей файлов (`llm_cache.json`, `index.json`).
- `ai_docs_site/` — результат сборки MkDocs (создаётся при `mkdocs build`).
- `README.md` — краткая документация в корне проекта (генерируется при флаге `--readme`).

## Именование и форматирование

- **Имена файлов**:
  - Генерируемые `.md`-файлы именуются в `kebab-case`: `ci-cd.md`, `service-mesh.md`.
  - Имена на основе путей к исходным файлам нормализуются: `src/utils/helpers.py` → `src-utils-helpers.md`.
- **Заголовки**:
  - Все заголовки в Markdown используют `#` без лишних пробелов.
  - Уровни: `#` — главный, `##` — раздел, `###` — подраздел.
- **Язык**:
  - По умолчанию — русский (`--language ru`).
  - Английский используется при `--language en`.
  - Переводы заголовков управляются через `SECTION_TITLES`, `DOMAIN_TITLES`.

## Классификация файлов

Типы файлов определяются по расширениям и именам:

| Тип | Расширения / Имена |
|-----|---------------------|
| Код | `.py`, `.js`, `.ts`, `.go`, `.java`, `.cpp` |
| Конфигурация | `.yaml`, `.yml`, `.toml`, `.json`, `.tf`, `.hcl` |
| Документация | `.md`, `.rst` |
| CI/CD | `.gitlab-ci.yml`, `.github/workflows/`, `Jenkinsfile` |
| Docker | `Dockerfile`, `docker-compose.yml` |
| Terraform | `.tf`, `.tfvars` |
| Kubernetes | `k8s/`, `.k8s.yaml`, `helm/` |

Домены (например, `kubernetes`, `terraform`) определяются автоматически и используются для группировки в навигации.

## Фильтрация и игнорирование

Файлы исключаются из обработки, если:
- Указаны в `.gitignore` или `.build_ignore`.
- Соответствуют шаблонам в `DEFAULT_EXCLUDE_PATTERNS`:  
  `.venv/`, `node_modules/`, `__pycache__/`, `.git/`, `dist/`, `build/`, `.ai-docs/`, `.ai_docs_cache/`.
- Превышают `max_size` (по умолчанию — 200 КБ).
- Являются бинарными (обнаружены нулевые байты).

Кастомные правила задаются в `.ai-docs.yaml`:
```yaml
exclude:
  - "*.log"
  - "temp/"
code_extensions:
  - ".php"
  - ".rb"
```

## Формат вывода LLM

Все LLM-генерируемые описания нормализуются к единому формату:

- **Резюме файла**:
  ```markdown
  ### Назначение
  Краткое описание функциональности.

  **Ключевые сущности**:  
  - `Функция`, `Класс` — краткое пояснение.
  ```
- **Конфигурационные блоки**:
  - Переносы строк заменяются на `<br>`.
  - Блоки кода оборачиваются в ```yaml или ```json.
- **Модули**:
  - Автоматически извлекаются классы, функции, экспорты.
  - Добавляются ссылки на зависимости.

## Работа с кэшем

- Кэширование включено по умолчанию.
- Ключ кэша LLM-запроса — SHA256 от сериализованного payload.
- Кэш файлов (`index.json`) сравнивает хэши (SHA-256) содержимого.
- При изменении файла — перегенерация сводки.
- Отключение: флаг `--no-cache` или удаление `.ai_docs_cache/`.

## Интеграция с MkDocs

Генерируемый `mkdocs.yml` включает:
- Поддержку Mermaid: через `pymdownx.superfences`.
- Кастомные JS/CSS для диаграмм.
- Автонавигацию на основе `project_config_nav_paths` и `module_nav_paths`.
- Локальный режим: при `--local-site` отключается публикация, пути настраиваются под `file://`.

## Логирование и отчётность

- Прогресс отображается в реальном времени.
- Ошибки LLM-обработки логируются, но не прерывают выполнение.
- Файл `changes.md` фиксирует:
  - Добавленные / изменённые / удалённые файлы.
  - Перегенерированные разделы.
  - Краткое резюме изменений.

## Работа с Git

- Поддержка локальных и удалённых репозиториев.
- При `--source https://...` репозиторий клонируется во временный каталог и удаляется после завершения.
- Имя репозитория извлекается из URL для метаданных.

Соблюдение этих соглашений обеспечивает стабильную работу инструмента и высокое качество документации.
