# Соглашения

При работе с `ai_docs` соблюдайте следующие соглашения для обеспечения предсказуемости, читаемости и совместимости сгенерированной документации.

## Структура файлов и директорий

- **`.ai-docs/`** — корневая директория сгенерированной документации. Не редактируйте вручную: изменения будут перезаписаны при следующем запуске.
- **`.ai-docs/_index.json`** — навигационный индекс. Содержит маршруты, приоритеты и метаданные страниц. Используется для построения навигации и ранжирования модулей.
- **`docs/changes.md`** — автоматически обновляемый отчёт об изменениях в проекте (добавленные, изменённые, удалённые файлы).
- **`ai_docs_site/`** — выходная директория после `mkdocs build`. Исключите из Git, если используется публикация через CI/CD.
- **`.ai_docs_cache/`** — кэш LLM-запросов и хешей файлов. Можно удалять для полной перегенерации.

## Именование и форматирование

- Все генерируемые `.md`-файлы используют **UTF-8** и **LF**-перевод строк.
- Имена файлов в `modules/` и `configs/` нормализуются в формат `slug` (нижний регистр, дефисы вместо пробелов и спецсимволов).
- Заголовки разделов соответствуют `SECTION_TITLES` и `DOMAIN_TITLES` из внутренних маппингов (например, `architecture.md` → "Архитектура").
- Пагинация применяется автоматически: списки длиннее 100 элементов разбиваются с навигацией «← Предыдущая / Следующая →».

## Классификация файлов

Тип файла определяется по:
- Расширению (`.py` → код, `.yaml` → конфигурация).
- Имени (например, `Dockerfile`, `requirements.txt`).
- Расположению (папки `tests/`, `__pycache__` исключаются).

Поддерживаемые категории:
- **Код**: `.py`, `.js`, `.go`, `.java`, `.rs` и др.
- **Конфигурации**: `.yaml`, `.yml`, `.json`, `.tf`, `.env`.
- **Документация**: `.md`, `.rst`, `.txt`.
- **Инфраструктура**: распознаются домены по ключевым файлам:
  - `kubernetes`: `k8s/`, `.k8s.yaml`, `Deployment.yaml`.
  - `terraform`: `*.tf`, `terraform.tfstate`.
  - `docker`: `Dockerfile`, `docker-compose.yml`.
  - `ci_cd`: `.github/workflows/`, `.gitlab-ci.yml`.

## Поведение при генерации

- **Инкрементальная обработка**: анализируются только изменённые или отсутствующие файлы. Основана на сравнении хешей (`sha256`) из `file_map`.
- **Кэширование LLM**: ответы сохраняются по хешу входного `payload`. Отключается флагом `--no-cache`.
- **Перегенерация**: принудительная перезапись секций возможна через `--regen architecture,configs` или `--force` для `README.md`.
- **Очистка**: устаревшие `.md`-файлы в `modules/`, `configs/` удаляются автоматически, если соответствующие исходные файлы удалены.

## Интеграция с Git

- Учитываются `.gitignore`, `.build_ignore` и встроенные исключения:  
  `.venv`, `node_modules`, `__pycache__`, `.ai-docs`, `.ai_docs_cache`, `dist`, `build`, `ai_docs_site`.
- При работе с удалённым репозиторием (`--source https://...`) используется временная директория, удаляемая после завершения.

## Переменные окружения

Используйте для настройки поведения в CI/CD:

```bash
OPENAI_API_KEY=...                # обязательный
OPENAI_MODEL=gpt-4o-mini          # рекомендуется для баланса качества и стоимости
AI_DOCS_THREADS=4                 # параллельная обработка
AI_DOCS_LOCAL_SITE=true           # для локального хостинга (отключает публикацию)
```

## Рекомендации по использованию

- Всегда запускайте `ai_docs` из корня проекта.
- Для локальной разработки используйте `--local-site`, чтобы избежать ошибок валидации `site_url`.
- При интеграции в CI/CD:  
  1. Установите `ai-docs-gen`.  
  2. Передайте `OPENAI_API_KEY`.  
  3. Запустите: `ai-docs --source . --mkdocs --language ru`.  
  4. Соберите сайт: `mkdocs build -f mkdocs.yml`.

Соблюдение этих соглашений обеспечивает стабильную и актуальную документацию, синхронизированную с кодовой базой.
