# Документация проекта

## Обзор

`ai_docs` — CLI-инструмент для автоматической генерации технической документации по исходному коду и конфигурационным файлам. Поддерживает анализ локальных директорий, локальных и удалённых Git-репозиториев. Основные выходные артефакты:

- `README.md` — краткое описание проекта.
- `ai_docs_site/` — полноценный сайт документации на базе MkDocs.

Инструмент использует LLM (через OpenAI API или совместимые эндпоинты) для анализа кода, поддерживает многопоточную обработку, кэширование и инкрементальную генерацию.

---

## Структура проекта

```
.
├── .ai-docs/               # Выходная директория с детальной документацией
│   ├── modules/            # Описания модулей
│   ├── _index.json         # Навигационный индекс (структура и приоритеты)
│   ├── index.md            # Главная страница
│   ├── architecture.md     # Диаграммы и описание архитектуры
│   └── ...                 # Другие разделы (запуск, конфиги, зависимости)
├── ai_docs_site/           # Сгенерированный MkDocs-сайт (при --mkdocs)
├── .ai_docs_cache/         # Кэш: хэши файлов и ответы LLM
├── .ai-docs.yaml           # Опциональная конфигурация (переопределяет дефолты)
├── mkdocs.yml              # Сгенерированный конфиг для MkDocs
└── docs/changes.md         # Отчёт об изменениях после генерации
```

---

## Запуск и использование

### Базовый запуск

```bash
ai_docs --source /path/to/project
```

Сгенерирует `README.md` и `ai_docs_site/` в директории проекта.

### Параметры командной строки

| Параметр | Описание | По умолчанию |
|--------|--------|-------------|
| `--source` | Путь к директории или URL Git-репозитория | — |
| `--output` | Корневая директория вывода | `.ai-docs` в корне проекта |
| `--readme` | Генерировать только `README.md` | — |
| `--mkdocs` | Генерировать только MkDocs-сайт | — |
| `--language ru\|en` | Язык документации | `ru` |
| `--include GLOB` | Включить файлы по шаблону (например, `*.py`) | — |
| `--exclude GLOB` | Исключить файлы по шаблону (например, `*.test.*`) | — |
| `--max-size N` | Макс. размер файла в байтах | `200000` (200 КБ) |
| `--threads N` | Количество потоков обработки | `4` |
| `--no-cache` | Отключить кэширование LLM-ответов | — |
| `--local-site` | Настроить MkDocs для локального хостинга | — |
| `--force` | Перезаписать существующий `README.md` | — |

> Если не указаны `--readme` и `--mkdocs`, генерируются оба артефакта.

---

## Конфигурация

### `.ai-docs.yaml` (опционально)

Позволяет кастомизировать поведение сканера и классификации файлов.

Пример:

```yaml
code_extensions:
  - ext: ".py"
    desc: "Python-модуль"
  - ext: ".go"
    desc: "Go-пакет"

config_extensions:
  - ext: ".yaml"
    desc: "Конфигурационный файл"
  - ext: ".tf"
    desc: "Terraform-модуль"

exclude:
  - "temp/"
  - "*.log"
  - "secrets/**"
```

Поддерживаемые секции:
- `code_extensions`, `doc_extensions`, `config_extensions` — пользовательские расширения.
- `exclude` — дополнительные паттерны исключения.

> При отсутствии файла создаётся дефолтная конфигурация.

---

## Фильтрация файлов

Сканирование учитывает:
- `.gitignore` и `.build_ignore`
- Бинарные файлы (определяются по наличию нулевых байтов)
- Размер файлов (ограничение `--max-size`)
- Стандартные исключения: `node_modules`, `.venv`, `__pycache__`, скрытые директории

**Всегда включаются** (даже если исключены в `.gitignore`):
- `Dockerfile`, `docker-compose.yml`
- `*.tf`, `*.tfvars`
- `.github/workflows/`, `.gitlab-ci.yml`
- `kubernetes/`, `helm/`, `charts/`

---

## Работа с LLM

### Переменные окружения

| Переменная | Назначение | По умолчанию |
|----------|----------|-------------|
| `OPENAI_API_KEY` | Ключ API | Обязательна |
| `OPENAI_BASE_URL` | Базовый URL API | `https://api.openai.com/v1` |
| `OPENAI_MODEL` | Модель (например, `gpt-4o-mini`) | `gpt-4o-mini` |
| `OPENAI_TEMPERATURE` | Температура генерации | `0.2` |
| `OPENAI_MAX_TOKENS` | Макс. токенов в ответе | `1200` |
| `OPENAI_CONTEXT_TOKENS` | Лимит контекста | `8192` |
| `AI_DOCS_THREADS` | Количество потоков | `4` |
| `AI_DOCS_LOCAL_SITE` | Локальный режим MkDocs | `false` |

> Поддерживает любые OpenAI-совместимые API (например, Azure, Ollama).

---

## Процесс генерации

1. **Сканирование**:
   - Определяется тип источника (локальный/URL).
   - Рекурсивный обход с фильтрацией.
   - Классификация файлов по типу и домену (Kubernetes, Terraform и др.).

2. **Сравнение с кэшем**:
   - `CacheManager` сравнивает хэши файлов.
   - Определяются: добавленные, изменённые, удалённые, неизменные.

3. **Генерация описаний**:
   - Для новых/изменённых файлов вызывается `summarize_file`.
   - Используются шаблоны: краткое описание или Doxygen-стиль.
   - Ответы кэшируются по хешу запроса.

4. **Постобработка**:
   - Нормализация формата (удаление лишних Markdown-блоков).
   - Повторная обработка при отклонении от Doxygen-стиля.

5. **Формирование структуры**:
   - Построение `_index.json` и навигации MkDocs.
   - Генерация `mkdocs.yml`.
   - Запись файлов в `.ai-docs/`.

6. **Отчёт**:
   - Создаётся `docs/changes.md` с перечнем изменений.

---

## Интеграция в CI/CD

Инструмент поддерживает повторные запуски с сохранением контекста:

```yaml
- name: Generate Docs
  run: |
    ai_docs --source . --readme --mkdocs --language ru
  env:
    OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
```

**Рекомендации**:
- Сохраняйте `.ai_docs_cache/` между запусками.
- Используйте `--no-cache` только при полной перегенерации.
- Добавьте `.ai-docs/` и `ai_docs_site/` в `.gitignore`, если не требуется хранить в репозитории.

---

## Расширения и классификация

Файлы классифицируются по:
- Расширению (`.py`, `.tf`, `.yaml` и др.)
- Имени (`Dockerfile`, `requirements.txt`)
- Пути (`kubernetes/`, `terraform/modules/`)

Поддерживаемые домены:
- `kubernetes`, `terraform`, `docker`, `ci/cd`, `python`, `go`, `java`, `typescript`

> Классификация используется для генерации разделов (например, "Конфиги Kubernetes").

---

## Безопасность и ограничения

- Бинарные файлы не читаются.
- Файлы > `--max-size` пропускаются.
- Текстовые файлы обрезаются до 4000 символов при анализе.
- Все временные файлы (например, при клонировании) удаляются после работы.

---

## Отладка и диагностика

- Ошибки логируются, но не прерывают выполнение.
- Кэш сохраняется после ключевых операций.
- Для отладки используйте `--threads 1` и проверьте `docs/changes.md`.

---

## Зависимости

- `tiktoken` — для подсчёта токенов.
- `PyYAML` — для генерации `mkdocs.yml`.
- `openai`, `requests` — для работы с LLM API.
- `python-dotenv` — загрузка `.env`.

---

## Поддержка языков

- Документация генерируется на `ru` или `en` (через `--language`).
- Все заголовки (`SECTION_TITLES`, `DOMAIN_TITLES`) локализованы.
- Ответы LLM формируются на указанном языке.
