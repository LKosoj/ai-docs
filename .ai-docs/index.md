# Документация проекта

## Обзор

`ai_docs` — это CLI-инструмент для автоматической генерации технической документации на основе анализа исходного кода и конфигурационных файлов. Инструмент поддерживает локальные директории и Git-репозитории (локальные и удалённые), а также генерирует как краткую документацию в формате `README.md`, так и полноценный сайт документации с использованием MkDocs.

Основная цель — минимизация ручного труда при поддержке актуальной, структурированной и локализованной документации.

---

## Архитектура и компоненты

### 1. Сканирование файлов (`ai_docs.scanner`)
- **Назначение**: рекурсивный обход файловой системы с фильтрацией.
- **Поддержка источников**:
  - Локальные пути.
  - URL Git-репозиториев (клонируются во временные каталоги).
- **Фильтрация**:
  - Учитывает `.gitignore`, `.build_ignore`.
  - Применяет `include`/`exclude` из CLI и `.ai-docs.yaml`.
  - Ограничивает размер файлов (`--max-size`, по умолчанию 200 КБ).
- **Результат**: объект `ScanResult` с метаданными по каждому файлу (путь, тип, домен, хэш).

### 2. Определение доменов и типов
- **Классификация**:
  - `classify_type()`: определяет тип файла (код, конфигурация, документация).
  - `detect_domains()`: распознаёт домены (Kubernetes, Terraform, Docker, CI/CD) по расширениям и именам.
- **Базовые наборы**:
  - `CODE_EXTENSIONS`, `CONFIG_EXTENSIONS`, `CI_FILENAMES`, `DOCKER_FILENAMES` и др.
- **Кастомизация**: через `.ai-docs.yaml`.

### 3. Генерация документации (`ai_docs.generator`)
- **Основные функции**:
  - `summarize_file()`: генерирует краткое описание файла с помощью LLM.
  - Поддержка чанкинга: большие файлы разбиваются на части, суммируются, затем объединяются.
  - Нормализация вывода: удаление лишних markdown-элементов, приведение к единому формату.
- **Разделы документации**:
  - Архитектура (с диаграммами Mermaid).
  - Зависимости.
  - Тестирование.
  - Изменения (`changes.md`).
  - Глоссарий.

### 4. Кэширование (`ai_docs.cache`)
- **Менеджер кэша**:
  - `CacheManager` отслеживает изменения файлов через `index.json`.
  - `llm_cache.json` хранит ответы LLM по хешу запроса.
- **Оптимизация**:
  - Повторные запуски обрабатывают только изменённые файлы.
  - Кэш потокобезопасен (`threading.Lock`).
- **Управление**: `--no-cache` отключает кэширование.

### 5. LLM-клиент (`ai_docs.llm`)
- **Функции**:
  - `LLMClient`: отправка запросов к OpenAI-совместимым API.
  - Поддержка кастомных `base_url` (например, для локальных моделей).
- **Параметры**:
  - `model`, `temperature`, `max_tokens`, `context_limit`.
  - Таймауты: 120 с (подключение), 480 с (ответ).
- **Кэширование**: на основе SHA256 от payload.

### 6. Генерация MkDocs (`ai_docs.mkdocs`)
- **Функции**:
  - `build_mkdocs_yaml()`: формирует `mkdocs.yml` с динамической навигацией.
  - `write_docs_files()`: записывает `.md`-файлы в `.ai-docs/`.
- **Навигация**:
  - Автоматическое построение дерева по структуре `docs/`.
  - Группировка через `__` в именах файлов (например, `modules__network.md` → вложенность).
- **Плагины**:
  - `search`, `mermaid2` (диаграммы), расширенные Markdown-расширения.

### 7. Токенизация (`ai_docs.tokenizer`)
- **Функции**:
  - `count_tokens()`: подсчёт токенов с учётом модели.
  - `chunk_text()`: разбиение текста на части по лимиту токенов.
- **Библиотека**: `tiktoken`.
- **Использование**: контроль длины контекста при запросах к LLM.

---

## Работа с инструментом

### Установка
```bash
pip install ai-docs
```

### Базовое использование
```bash
ai-docs --source . --readme --mkdocs --language ru
```

### Параметры CLI
| Флаг | Описание | По умолчанию |
|------|---------|-------------|
| `--source` | Путь или URL репозитория | — |
| `--output` | Директория вывода | `.ai-docs/` |
| `--readme` | Генерировать `README.md` | `False` |
| `--mkdocs` | Генерировать сайт MkDocs | `False` |
| `--language` | Язык документации (`ru`/`en`) | `ru` |
| `--include` | Glob-шаблоны для включения | — |
| `--exclude` | Glob-шаблоны для исключения | — |
| `--max-size` | Макс. размер файла (байт) | 200000 |
| `--threads` | Количество потоков | `AI_DOCS_THREADS` или 4 |
| `--no-cache` | Отключить кэширование | `False` |
| `--force` | Перезаписать `README.md` | `False` |
| `--local-site` | Режим локального сайта | `AI_DOCS_LOCAL_SITE` |

### Переменные окружения
| Переменная | Назначение | По умолчанию |
|-----------|-----------|-------------|
| `OPENAI_API_KEY` | Ключ API | Обязательна |
| `OPENAI_BASE_URL` | Базовый URL API | `https://api.openai.com/v1` |
| `OPENAI_MODEL` | Модель LLM | `gpt-4o-mini` |
| `OPENAI_TEMPERATURE` | Температура генерации | `0.2` |
| `OPENAI_MAX_TOKENS` | Макс. токенов в ответе | `1200` |
| `AI_DOCS_THREADS` | Количество потоков | `4` |
| `AI_DOCS_LOCAL_SITE` | Локальный режим MkDocs | `False` |

---

## Конфигурация

### `.ai-docs.yaml`
```yaml
code_extensions:
  - .py
  - .js
  - .go
doc_extensions:
  - .md
  - .rst
config_extensions:
  - .yaml
  - .toml
exclude:
  - .env.local
  - temp/
```

- Создаётся автоматически при отсутствии.
- Позволяет расширить стандартные наборы и исключения.

---

## Генерируемые артефакты
| Артефакт | Назначение |
|--------|-----------|
| `README.md` | Краткое описание проекта |
| `.ai-docs/` | Полная документация (MkDocs) |
| `mkdocs.yml` | Конфигурация сайта |
| `ai_docs_site/` | Собранный сайт (результат `mkdocs build`) |
| `.ai_docs_cache/` | Кэш файлов и LLM-ответов |
| `_index.json` | Навигационный индекс (приоритеты, структура) |

---

## Игнорируемые файлы
Учитываются:
- `.gitignore`
- `.build_ignore`
- `.ai-docs.yaml` (поле `exclude`)
- Стандартные паттерны: `.git`, `__pycache__`, `.venv`, `node_modules`, `dist`, `build`, `.ai-docs`, `.ai_docs_cache`, `ai_docs_site`.

---

## Сборка сайта
```bash
mkdocs build -f mkdocs.yml
```
- Вывод: `ai_docs_site/`
- Для предпросмотра: `mkdocs serve -f mkdocs.yml`

---

## Разработка

### Зависимости
Указаны в `pyproject.toml`:
- `requests`, `tiktoken`, `PyYAML`, `mkdocs`, `mkdocs-material`, `pathspec`, `python-dotenv`.

### Точки входа
- CLI: `ai_docs.cli:main`
- Запуск: `python -m ai_docs` или `ai-docs`

### Тестирование
- `test_scanner.py`: проверка фильтрации и сканирования.
- `test_cache.py`: валидация `CacheManager.diff_files()`.
- `test_changes.py`: проверка генерации `changes.md`.

---

## Лицензия
MIT. Проект открыт для PR и предложений.
