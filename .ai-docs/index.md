# Документация проекта

## Обзор

`ai_docs` — это CLI-инструмент для автоматической генерации и поддержки технической документации на основе исходного кода, конфигураций и структуры проекта. Поддерживает анализ локальных директорий и Git-репозиториев (локальных и удалённых), распознаёт технологические домены (Kubernetes, Terraform, CI/CD и др.) и генерирует:

- `README.md` — краткое описание проекта;
- полноценный сайт документации в формате **MkDocs**.

Инструмент использует LLM для анализа и суммаризации файлов, поддерживает кэширование, инкрементальную обработку и многопоточную генерацию.

---

## Установка и запуск

### Установка

```bash
pip install ai-docs-gen
```

Или из исходников:

```bash
git clone https://github.com/your-repo/ai_docs.git
cd ai_docs
pip install -e .
```

### Быстрый старт

```bash
ai-docs --source ./my-project --readme --mkdocs
```

Сгенерирует `README.md` и сайт MkDocs в папке `docs/`.

---

## Конфигурация

### Переменные окружения

| Переменная | Назначение | По умолчанию |
|-----------|------------|--------------|
| `OPENAI_API_KEY` | Ключ для доступа к LLM (обязательно) | — |
| `OPENAI_BASE_URL` | Базовый URL API (поддержка OpenAI-совместимых эндпоинтов) | `https://api.openai.com/v1` |
| `OPENAI_MODEL` | Модель для генерации | `gpt-4o-mini` |
| `OPENAI_TEMPERATURE` | Температура генерации | `0.2` |
| `OPENAI_MAX_TOKENS` | Макс. токенов в ответе | `1200` |
| `AI_DOCS_THREADS` | Количество потоков обработки | `4` |
| `AI_DOCS_LOCAL_SITE` | Режим локального сайта (без `site_url`) | `false` |

Переменные можно задавать в `.env`-файле в корне проекта.

---

### Конфигурационный файл `.ai-docs.yaml`

Располагается в корне проекта. Позволяет кастомизировать:

```yaml
code_extensions:
  - ".py"
  - ".go"
  - ".ts"

doc_extensions:
  - ".md"
  - ".rst"

config_extensions:
  - ".yaml"
  - ".toml"
  - ".json"

exclude:
  - "temp/"
  - "*.log"
```

При отсутствии файла создаётся конфиг по умолчанию с поддержкой типичных расширений.

---

## CLI-флаги

| Флаг | Назначение | Пример |
|------|-----------|--------|
| `--source` | Путь к директории или URL Git-репозитория (обязательно) | `--source ./project` |
| `--readme` | Генерировать `README.md` | `--readme` |
| `--mkdocs` | Генерировать MkDocs-сайт | `--mkdocs` |
| `--language` | Язык документации | `--language ru` |
| `--threads` | Количество потоков | `--threads 8` |
| `--force` | Перезаписать существующий `README.md` | `--force` |
| `--local-site` | Отключить `site_url` и `use_directory_urls` в `mkdocs.yml` | `--local-site` |
| `--no-cache` | Отключить кэширование LLM-запросов | `--no-cache` |
| `--include` | Дополнительные glob-паттерны для включения | `--include "**/*.conf"` |
| `--exclude` | Дополнительные glob-паттерны для исключения | `--exclude "**/test/*"` |
| `--max-size` | Макс. размер файла в байтах | `--max-size 500000` |

> **Примечание**: Если не указаны `--readme` или `--mkdocs`, генерируются оба артефакта.

---

## Архитектура и внутренние компоненты

### Структура проекта

```
.ai-docs/          # Временные и промежуточные данные
├── _index.json    # Навигационный индекс
├── changes.md     # Отчёт об изменениях
├── modules/       # Описания модулей
└── configs/       # Описания конфигураций

.ai_docs_cache/    # Кэш LLM-запросов и хэшей файлов
├── index.json     # Хэши файлов
└── llm_cache.json # Кэш ответов LLM

docs/              # Выходная документация (MkDocs)
├── index.md
├── modules/
└── configs/

mkdocs.yml         # Конфигурация сайта
README.md          # Краткая документация
```

---

### Ключевые модули

#### `ai_docs.scanner`

Сканирует файлы с фильтрацией по расширениям, `.gitignore`, `.build_ignore` и пользовательским правилам.

- Поддерживает локальные пути и Git-URL.
- Автоматически клонирует репозитории во временные директории.
- Использует `pathspec` для обработки `.gitignore`.

#### `ai_docs.llm`

Клиент для взаимодействия с LLM через OpenAI-совместимый API.

- Поддержка кэширования по SHA256 от payload.
- Потокобезопасен.
- Таймауты: 120 сек (connect), 480 сек (read).

#### `ai_docs.summarize`

Генерирует резюме файлов с помощью LLM.

- Поддерживает три режима: общий обзор, описание модуля, описание конфигурации.
- Разбивает текст на чанки с учётом лимита токенов (`chunk_text`).
- Нормализует вывод к строгому Markdown-формату.

#### `ai_docs.mkdocs`

Генерирует `mkdocs.yml` и файлы документации.

- Динамическое построение навигации через `_build_tree_nav`.
- Поддержка плагинов: `mermaid2`, `pymdown-extensions`.
- При `--local-site` устанавливает:
  ```yaml
  site_url: ""
  use_directory_urls: false
  ```

#### `ai_docs.cache`

Менеджер кэширования на основе двух JSON-файлов:

- `index.json` — хэши файлов и метаданные.
- `llm_cache.json` — закэшированные ответы LLM.

Метод `diff_files()` возвращает:
- `added`, `modified`, `deleted`, `unchanged` — для инкрементальной обработки.

---

## Поддерживаемые технологии и домены

Инструмент автоматически распознаёт:

| Домен | Ключевые файлы/расширения |
|------|---------------------------|
| **Kubernetes** | `.yaml`, `k8s/`, `deployment.yaml` |
| **Helm** | `Chart.yaml`, `values.yaml` |
| **Terraform** | `.tf`, `terraform.tfstate` |
| **Ansible** | `playbook.yml`, `inventory.ini` |
| **Docker** | `Dockerfile`, `docker-compose.yml` |
| **CI/CD** | `.gitlab-ci.yml`, `.github/workflows/` |
| **Observability** | `prometheus.yml`, `grafana/` |
| **Service Mesh** | `istio`, `ingress.yaml` |
| **Data / Storage** | `.sql`, `migrations/`, `parquet` |

Классификация выполняется по расширениям, именам файлов и путям.

---

## Работа с кэшированием

Кэширование включено по умолчанию. Используется для:

- Хранения хэшей файлов (`index.json`) — определение изменений.
- Кэширования ответов LLM (`llm_cache.json`) — ускорение перегенерации.

Отключить кэширование:
```bash
ai-docs --source . --no-cache
```

Кэш сохраняется в `.ai_docs_cache/`. Рекомендуется добавить в `.gitignore`:

```gitignore
.ai_docs_cache/
.ai-docs/
docs/
```

---

## Инкрементальная обработка

При каждом запуске:

1. Сравнивается текущее состояние файлов с `index.json`.
2. Обрабатываются только:
   - новые файлы;
   - изменённые файлы;
   - файлы из перегенерируемых разделов.
3. Генерируется `changes.md` с отчётом:
   - Добавленные/изменённые/удалённые файлы.
   - Перегенерированные разделы (архитектура, зависимости и др.).

---

## Расширение и вклад

Проект открыт для вклада. Требования:

- Python ≥ 3.8
- Зависимости: `requests`, `tiktoken`, `pyyaml`, `python-dotenv`, `mkdocs`, `pathspec`

Запуск для разработки:

```bash
python -m ai_docs --source ./test-project --readme
```

Тесты:

```bash
pytest tests/
```

Поддерживаются:
- `test_scanner.py` — проверка фильтрации файлов.
- `test_cache.py` — проверка `CacheManager`.
- `test_changes.py` — проверка генерации `changes.md`.

**Лицензия**: MIT

---

## Ограничения

- Максимальный размер файла: 200 КБ (настраивается через `--max-size`).
- Бинарные файлы (с нулевыми байтами) пропускаются.
- Git-репозитории клонируются полностью — может быть медленно для больших репозиториев.
- Требуется стабильное интернет-соединение при использовании облачных LLM.

---

## Примеры использования

### 1. Генерация только README

```bash
ai-docs --source . --readme --language ru
```

### 2. Полная документация с кастомными настройками

```bash
ai-docs \
  --source https://github.com/user/project.git \
  --mkdocs \
  --threads 6 \
  --include "**/*.conf" \
  --exclude "**/logs/*"
```

### 3. Локальная сборка без публикации

```bash
AI_DOCS_LOCAL_SITE=true ai-docs --source . --mkdocs
```

После генерации:
```bash
cd docs && mkdocs serve
```

---

## Поддержка

Для вопросов и предложениями — создавайте issue или PR в репозитории проекта.
