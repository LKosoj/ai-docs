# Документация проекта

## Обзор

Инструмент `ai_docs` автоматически генерирует техническую документацию по исходному коду и конфигурационным файлам. Поддерживает анализ локальных директорий, локальных и удалённых Git-репозиториев. На выходе создаётся `README.md` и полноценный MkDocs-сайт с иерархической структурой.

### Основные возможности
- Автоматическое определение технологий: Kubernetes, Helm, Terraform, Ansible, Docker, CI/CD.
- Генерация `README.md` и сайта документации (через MkDocs).
- Поддержка русского и английского языков.
- Инкрементальная генерация с кэшированием LLM-ответов.
- Многопоточная обработка для ускорения анализа.
- Учёт `.gitignore`, `.build_ignore` и встроенных исключений.

---

## Структура выходных данных

После выполнения генерации создаются следующие артефакты:

| Путь | Назначение |
|------|-----------|
| `README.md` | Краткое описание проекта. |
| `.ai-docs/` | Директория сгенерированных страниц. |
| &nbsp;&nbsp;├── `changes.md` | Отчёт об изменениях в кодовой базе. |
| &nbsp;&nbsp;└── `modules/` | Детальная документация по модулям. |
| `mkdocs.yml` | Конфигурация для сборки сайта. |
| `ai_docs_site/` | Собранный статический сайт. |
| `.ai_docs_cache/` | Кэш LLM-обработки (включает `index.json`, `llm_cache.json`). |

---

## Настройка через `.env`

Поддерживаются следующие переменные окружения:

| Переменная | Назначение | Значение по умолчанию |
|-----------|-----------|------------------------|
| `OPENAI_API_KEY` | Ключ API для доступа к LLM | Обязательно |
| `OPENAI_BASE_URL` | Базовый URL API | `https://api.openai.com/v1` |
| `OPENAI_MODEL` | Модель для генерации | `gpt-4o-mini` |
| `OPENAI_MAX_TOKENS` | Макс. токенов в ответе | `1200` |
| `OPENAI_CONTEXT_TOKENS` | Общий лимит контекста | `8192` |
| `OPENAI_TEMPERATURE` | Уровень креативности | `0.2` (рекомендуется для техдока) |
| `AI_DOCS_THREADS` | Количество потоков | Зависит от системы |
| `AI_DOCS_LOCAL_SITE` | Локальный режим MkDocs | `false` |

---

## CLI-интерфейс

### Основные команды

```bash
ai_docs --source <путь_или_url> [--readme] [--mkdocs]
```

### Ключевые параметры

| Параметр | Описание |
|---------|--------|
| `--source` | Путь к директории или URL репозитория (обязательный). |
| `--readme` | Генерировать `README.md`. |
| `--mkdocs` | Генерировать `mkdocs.yml` и собрать сайт. |
| `--language ru/en` | Язык документации (`ru` по умолчанию). |
| `--threads N` | Количество параллельных потоков. |
| `--cache-dir DIR` | Путь к кэшу (по умолчанию `.ai_docs_cache`). |
| `--no-cache` | Отключить кэширование LLM-ответов. |
| `--local-site` | Настроить `mkdocs.yml` для локального просмотра (без `site_url`, `use_directory_urls: false`). |
| `--force` | Перезаписать существующий `README.md`. |
| `--include PATTERN` | Шаблон включения файлов (можно указать несколько). |
| `--exclude PATTERN` | Шаблон исключения файлов. |
| `--max-size N` | Макс. размер файла в байтах (по умолчанию 200 КБ). |
| `--output DIR` | Директория вывода (по умолчанию `output/<repo_name>`). |

---

## Принципы работы

### 1. Сканирование файлов
- Используется `ai_docs.scanner.scan_source`.
- Поддерживаются: локальные пути, Git-репозитории (клонируются с `--depth 1`).
- Фильтрация:
  - По расширениям (`.py`, `.yaml`, `.tf` и др.).
  - По встроенным исключениям: `node_modules`, `.venv`, `.git`, `.cache`.
  - По `.gitignore` и `.build_ignore` (обрабатываются через `pathspec`).
- Бинарные файлы пропускаются (определяются по наличию нулевых байтов в первых 2048 байтах).

### 2. Классификация файлов
Определяются:
- **Тип файла**: `code`, `config`, `docs`, `infra`, `ci`, `data`, `other`.
- **Домены**: `docker`, `kubernetes`, `helm`, `terraform`, `ansible`, `ci`.

На основе:
- Имени файла (например, `Dockerfile`, `Chart.yaml`).
- Расширения (`.tf` → `terraform`).
- Пути (`.github/workflows/` → `ci`).
- Содержимого (наличие `apiVersion` и `kind` в `.yaml` → `kubernetes`).

### 3. Генерация документации
- Каждый файл разбивается на чанки с учётом лимита токенов (`tiktoken`).
- Для каждого чанка формируется промпт, отправляется в LLM.
- Ответы кэшируются по хешу запроса (SHA-256 от нормализованного JSON).
- Поддерживается два режима:
  - Краткое резюме (по умолчанию).
  - Детальная документация в стиле Doxygen (для модулей).

### 4. Постобработка
- Текст, нарушающий Markdown (например, заголовки в списке), переформатируется через LLM.
- Генерируется `changes.md` с отчётом об изменениях:
  - Добавленные, изменённые, удалённые файлы.
  - Перегенерированные разделы.
- Автоматически собирается диаграмма архитектуры (Mermaid) при наличии соответствующих данных.

### 5. Сборка MkDocs
- Генерируется `mkdocs.yml`:
  - Поддержка русских заголовков (транслитерация через `safe_slug`).
  - Динамическая навигация: `Главная`, `Модули`, `Зависимости`, `Изменения`.
  - Включены плагины: `search`, `mermaid2`.
- Сайт собирается через `mkdocs build`.

---

## Кэширование

Используется для ускорения повторных запусков:
- **`index.json`** — хранит хеши файлов и структуру проекта.
- **`llm_cache.json`** — хранит ответы LLM по хешу запроса.
- При запуске:
  - Сравниваются хеши текущих файлов с кэшем.
  - Обрабатываются только `added` и `modified` файлы.
  - Устаревшие файлы в `.ai-docs/modules/` удаляются.

---

## Интеграция и запуск

### Установка
```bash
pip install ai_docs
```

### Примеры использования

**Генерация README на русском:**
```bash
ai_docs --source . --readme --language ru
```

**Генерация сайта из удалённого репозитория:**
```bash
ai_docs --source https://github.com/user/repo.git --mkdocs --local-site
```

**Полная документация с кастомными настройками:**
```bash
ai_docs \
  --source . \
  --readme \
  --mkdocs \
  --language ru \
  --threads 8 \
  --include "*.py" \
  --include "docs/*.md" \
  --exclude "tests/*" \
  --max-size 500000 \
  --output ./docs
```

---

## Тестирование

Включены юнит-тесты для ключевых компонентов:
- `test_scanner.py` — проверка корректности сканирования с учётом `.gitignore`.
- `test_cache.py` — проверка `CacheManager.diff_files` на всех сценариях изменений.
- `test_changes.py` — проверка форматирования `changes.md`.

Запуск:
```bash
python -m unittest discover tests/
```

---

## Ограничения и рекомендации

- **Размер файлов**: файлы > 200 КБ по умолчанию пропускаются (настраивается).
- **LLM-затраты**: кэширование критически важно для снижения стоимости.
- **Безопасность**: не передавайте в инструмент файлы с секретами.
- **Производительность**: используйте `--threads` и кэширование для больших проектов.
- **Локализация**: поддержка русского языка включает транслитерацию заголовков в URL.
