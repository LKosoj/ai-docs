# Документация проекта

## Обзор

`ai_docs` — это CLI-инструмент для автоматической генерации и поддержки технической документации на основе исходного кода, конфигураций и структуры проекта. Инструмент анализирует локальные директории или Git-репозитории (локальные и удалённые), распознаёт технологические домены (Kubernetes, Terraform, CI/CD и др.) и генерирует:

- `README.md` — краткое описание проекта;
- полноценный сайт документации в формате **MkDocs**.

Поддерживается инкрементальная обработка, кэширование LLM-ответов и многопоточная генерация.

---

## Установка и запуск

### Установка

```bash
pip install ai-docs-gen
```

Или из исходников:

```bash
git clone https://github.com/your-repo/ai_docs.git
cd ai_docs
pip install -e .
```

### Быстрый старт

```bash
ai-docs --source . --readme --mkdocs
```

Сгенерирует `README.md` и сайт MkDocs в папке `docs/`.

---

## Конфигурация

### Переменные окружения

| Переменная               | Назначение                                  | По умолчанию               |
|--------------------------|---------------------------------------------|----------------------------|
| `OPENAI_API_KEY`         | Ключ API для LLM (обязательно)              | —                          |
| `OPENAI_BASE_URL`        | Базовый URL API (для кастомных эндпоинтов)  | `https://api.openai.com/v1`|
| `OPENAI_MODEL`           | Модель LLM                                  | `gpt-4o-mini`              |
| `OPENAI_TEMPERATURE`     | Температура генерации                       | `0.2`                      |
| `OPENAI_MAX_TOKENS`      | Макс. токенов в ответе                      | `1200`                     |
| `OPENAI_CONTEXT_TOKENS`  | Общий лимит контекста                       | `8192`                     |
| `AI_DOCS_THREADS`        | Количество потоков обработки                | `4`                        |
| `AI_DOCS_LOCAL_SITE`     | Режим локальной сборки (без публикации)     | `false`                    |

Переменные можно задать в `.env`-файле в корне проекта.

---

### Конфигурационный файл `.ai-docs.yaml`

Располагается в корне проекта. Позволяет кастомизировать:

```yaml
code_extensions:
  - ".py"
  - ".go"
  - ".ts"
doc_extensions:
  - ".md"
  - ".rst"
config_extensions:
  - ".yaml"
  - ".toml"
  - ".tf"
exclude:
  - "temp/"
  - "*.log"
  - "secrets/"
```

Если файл отсутствует, создаётся автоматически с настройками по умолчанию.

---

## CLI-интерфейс

### Основные флаги

| Флаг                | Описание |
|---------------------|--------|
| `--source PATH|URL` | Путь к директории или URL Git-репозитория (обязательно) |
| `--readme`          | Сгенерировать `README.md` |
| `--mkdocs`          | Сгенерировать сайт MkDocs |
| `--language ru|en`  | Язык документации (`ru` по умолчанию) |
| `--threads N`       | Количество потоков (переопределяет `AI_DOCS_THREADS`) |
| `--force`           | Перезаписать существующий `README.md` |
| `--local-site`      | Настроить MkDocs для локального запуска (переопределяет `AI_DOCS_LOCAL_SITE`) |
| `--no-cache`        | Отключить кэширование LLM-запросов |
| `--include GLOB`    | Дополнительные glob-паттерны для включения файлов |
| `--exclude GLOB`    | Дополнительные glob-паттерны для исключения |
| `--max-size N`      | Макс. размер файла в байтах (по умолчанию 200 000) |

> Если не указаны `--readme` или `--mkdocs`, генерируются оба артефакта.

---

## Архитектура и внутренние компоненты

### Основные модули

| Модуль | Назначение |
|-------|-----------|
| `ai_docs.scanner` | Сканирование файлов с фильтрацией по расширениям, `.gitignore`, размеру и типу |
| `ai_docs.llm` | Клиент для взаимодействия с LLM (OpenAI-совместимый API) |
| `ai_docs.summarize` | Генерация резюме файлов с использованием промптов и кэширования |
| `ai_docs.docs` | Построение структуры документации, генерация `mkdocs.yml`, запись файлов |
| `ai_docs.cache` | Управление кэшем: `index.json` (состояние файлов), `llm_cache.json` (ответы LLM) |
| `ai_docs.utils` | Вспомогательные функции: токенизация, хеширование, работа с путями |

---

### Каталоги и артефакты

После запуска создаются:

- `.ai-docs/` — промежуточные данные:
  - `_index.json` — навигационный индекс, приоритеты модулей;
  - `changes.md` — отчёт об изменениях;
  - `modules/`, `configs/` — описания файлов.
- `.ai_docs_cache/` — кэш:
  - `index.json` — хэши файлов;
  - `llm_cache.json` — закэшированные ответы LLM.
- `docs/` — выходная документация MkDocs.
- `README.md` — основной файл описания проекта.
- `mkdocs.yml` — конфигурация сайта.

> Каталоги `.ai-docs` и `.ai_docs_cache` добавлены в `.gitignore` по умолчанию.

---

## Принципы работы

### 1. Сканирование

- Поддерживаются: локальные пути, `https://`, `git@`.
- При работе с URL — репозиторий клонируется во временный каталог.
- Фильтрация:
  - Учитываются `.gitignore`, `.build_ignore`.
  - Исключаются: `.git`, `__pycache__`, `node_modules`, `.venv`, `dist`, `build`.
  - Ограничение по размеру: до 200 КБ на файл.
- Автоматическое определение типа файла: код, конфигурация, документация.
- Обнаружение доменов: Kubernetes, Helm, Terraform, Docker, CI/CD и др.

### 2. Генерация резюме

- Для каждого файла вызывается `summarize_file()` с соответствующим промптом:
  - `SUMMARY_PROMPT` — базовое описание;
  - `MODULE_SUMMARY_PROMPT` — для модулей кода;
  - `CONFIG_SUMMARY_PROMPT` — для конфигураций.
- Длинные файлы разбиваются на чанки (`chunk_text`) с учётом лимита токенов.
- Вывод нормализуется: удаляются лишние символы, форматируется Markdown.

### 3. Кэширование

- `CacheManager` сравнивает хэши файлов (`sha256`) с предыдущим запуском.
- Определяет:
  - `added` — новые файлы;
  - `modified` — изменённые;
  - `deleted` — удалённые;
  - `unchanged` — без изменений.
- LLM-запросы кэшируются по хешу payload (SHA256).
- Кэш потокобезопасен.

### 4. Построение документации

- Формируется `mkdocs.yml`:
  - Поддержка Mermaid, таблиц, поиска;
  - Многоуровневая навигация через `_build_tree_nav`.
- Генерируются разделы:
  - Архитектура (с диаграммами);
  - Зависимости (из `pyproject.toml`, `package.json`, `requirements.txt`);
  - Тестирование;
  - Изменения (`changes.md`).
- Все файлы записываются в `docs/` с сохранением структуры.

---

## Интеграция в CI/CD

Пример для GitHub Actions:

```yaml
- name: Generate Docs
  run: |
    pip install ai-docs-gen
    ai-docs --source . --readme --mkdocs --language ru
  env:
    OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
```

> Рекомендуется запускать при каждом коммите в `main`, чтобы поддерживать документацию в актуальном состоянии.

---

## Разработка и вклад

### Запуск для отладки

```bash
python -m ai_docs --source . --readme --mkdocs
```

### Тестирование

```bash
pytest tests/
```

Тесты покрывают:
- Сканирование файлов;
- Работу кэша;
- Форматирование отчётов;
- Генерацию конфигурации MkDocs.

### Вклад

Приветствуются:
- Исправления ошибок;
- Добавление поддержки новых технологий;
- Улучшение промптов;
- Расширение документации.

Лицензия: **MIT**.

---

## Ограничения

- Требуется доступ к LLM с API, совместимым с OpenAI.
- Не обрабатывает бинарные файлы.
- Максимальный размер файла — 200 КБ (настраивается).
- Для больших проектов может потребоваться увеличение `AI_DOCS_THREADS` и времени выполнения.

---

## Поддержка

Для вопросов и предложений используйте Issues и Pull Requests в репозитории проекта.
