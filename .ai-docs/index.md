# Документация проекта

## Обзор

`ai_docs` — это CLI-инструмент для автоматической генерации технической документации на основе анализа исходного кода, конфигураций и структуры проекта. Поддерживает локальные директории и Git-репозитории (включая удалённые по URL). Результатом работы являются:

- `README.md` — краткое описание проекта;
- полноценный сайт документации на MkDocs (в `ai_docs_site/`);
- структурированная документация в `.ai-docs/`.

Инструмент использует LLM для анализа и генерации текста, поддерживает кэширование, инкрементальную обработку и многопоточность.

---

## Установка и запуск

### Установка

```bash
pip install ai-documentery
```

Или из исходников:

```bash
pip install -e .
```

### Быстрый старт

```bash
ai-docs --source . --readme --mkdocs --language ru
```

Сгенерирует `README.md` и сайт MkDocs на русском языке.

---

## Основные команды

```bash
ai-docs --source <путь_или_url> [опции]
```

### Обязательный параметр

- `--source` — путь к локальной директории или URL Git-репозитория.

### Опции вывода

| Флаг | Назначение |
|------|-----------|
| `--readme` | Генерировать `README.md` |
| `--mkdocs` | Генерировать конфиг и структуру для MkDocs |
| `--output DIR` | Каталог вывода (по умолчанию: `.` для README, `.ai-docs` для MkDocs) |

### Фильтрация файлов

| Флаг | Назначение |
|------|-----------|
| `--include GLOB` | Включить файлы по шаблону (можно указать несколько раз) |
| `--exclude GLOB` | Исключить файлы по шаблону (можно указать несколько раз) |
| `--max-size N` | Макс. размер файла в байтах (по умолчанию: 200 000) |

### Настройки LLM

| Переменная окружения | Назначение | Значение по умолчанию |
|----------------------|-----------|------------------------|
| `OPENAI_API_KEY` | Ключ API | Обязательно |
| `OPENAI_BASE_URL` | Базовый URL API | `https://api.openai.com/v1` |
| `OPENAI_MODEL` | Модель | `gpt-4o-mini` |
| `OPENAI_TEMPERATURE` | Температура генерации | `0.2` |
| `OPENAI_MAX_TOKENS` | Макс. токенов в ответе | `1200` |
| `OPENAI_CONTEXT_TOKENS` | Лимит контекста | `8192` |

### Прочие опции

| Флаг / Переменная | Назначение |
|-------------------|-----------|
| `--force` | Перезаписать существующий `README.md` |
| `--no-cache` | Отключить кэширование LLM-запросов |
| `--threads N` | Количество потоков (по умолчанию: 4) |
| `AI_DOCS_THREADS` | Альтернатива `--threads` |
| `--local-site` | Настроить MkDocs для локального запуска |
| `AI_DOCS_LOCAL_SITE` | Альтернатива `--local-site` |
| `--language ru/en` | Язык документации | `ru` |

---

## Артефакты

После выполнения генерируются:

| Артефакт | Назначение |
|---------|-----------|
| `README.md` | Краткое описание проекта |
| `.ai-docs/` | Полная документация (модули, конфиги, зависимости) |
| `mkdocs.yml` | Конфигурация сайта |
| `ai_docs_site/` | Собранный сайт (после `mkdocs build`) |
| `.ai_docs_cache/` | Кэш LLM-запросов и хэшей файлов |

---

## Конфигурация

### `.ai-docs.yaml`

Позволяет кастомизировать поведение сканера:

```yaml
code_extensions:
  - .py
  - .js
  - .go

doc_extensions:
  - .md
  - .rst

config_extensions:
  - .yaml
  - .toml

exclude:
  - temp/
  - *.log
```

Если файл отсутствует — создаётся автоматически с настройками по умолчанию.

### Игнорируемые файлы

Учитываются:
- `.gitignore`
- `.build_ignore`
- Настройки в `.ai-docs.yaml`

По умолчанию исключаются:
```
.git, __pycache__, .venv, venv, node_modules, dist, build, 
.ai-docs, .ai_docs_cache, ai_docs_site, *.pyc, *.log
```

---

## Работа с кэшем

Кэширование включено по умолчанию. Используется два файла в `.ai_docs_cache/`:

- `index.json` — хэши файлов и метаданные (для отслеживания изменений)
- `llm_cache.json` — ответы LLM (ключ — SHA256 от payload)

При повторном запуске:
- Неизменённые файлы не перепроцессируются.
- Повторные LLM-запросы возвращаются из кэша.

Отключить: `--no-cache`.

---

## Поддерживаемые домены

Автоматически определяются по наличию характерных файлов:

| Домен | Файлы |
|------|------|
| Kubernetes | `k8s.yaml`, `deployment.yaml` |
| Helm | `Chart.yaml`, `values.yaml` |
| Terraform | `.tf`, `terraform.tfstate` |
| Docker | `Dockerfile`, `docker-compose.yml` |
| CI/CD | `.gitlab-ci.yml`, `.github/workflows/` |
| Python | `pyproject.toml`, `requirements.txt` |
| Node.js | `package.json`, `npm`/`yarn`-файлы |

Используется для формирования разделов в документации.

---

## Структура документации

Сгенерированная документация в `.ai-docs/` включает:

```
.ai-docs/
├── index.md               # Обзор проекта
├── architecture.md        # Архитектура (с Mermaid-диаграммами)
├── dependencies.md        # Зависимости
├── testing.md             # Тестирование
├── changes.md             # История изменений
├── glossary.md            # Глоссарий
├── modules/               # Описание модулей
├── configs/               # Описание конфигураций
└── _index.json            # Навигационный индекс
```

`_index.json` используется для построения навигации в MkDocs.

---

## Сборка сайта

После генерации:

```bash
mkdocs build -f mkdocs.yml
```

Сайт будет доступен в `ai_docs_site/`.

Для предпросмотра:

```bash
mkdocs serve -f mkdocs.yml
```

---

## Разработка

### Зависимости

Указаны в `pyproject.toml`:
- `requests`, `tiktoken`, `PyYAML`, `python-dotenv`
- `mkdocs`, `mkdocs-mermaid2`, `pymdown-extensions`

### Запуск в режиме разработки

```bash
python -m ai_docs.cli --source . --readme
```

### Тестирование

```bash
pytest tests/
```

Тестируются:
- Сканирование файлов
- Кэширование (`CacheManager`)
- Форматирование отчётов (`format_changes_md`)
- Обработка игнорируемых файлов

---

## Лицензия

MIT. Проект принимает PR и предложения.
