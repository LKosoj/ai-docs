# Документация проекта

## Обзор

`ai_docs` — это CLI-инструмент для автоматической генерации и поддержки актуальной технической документации на основе исходного кода, конфигураций и структуры проекта. Поддерживает анализ локальных директорий, локальных и удалённых Git-репозиториев.

Основная цель — сократить ручной труд при создании и обновлении документации за счёт автоматического анализа кода с использованием LLM, кэширования и инкрементальной обработки.

---

## Возможности

- **Генерация документации**:
  - Автоматическое создание `README.md`.
  - Полноценный сайт документации в формате **MkDocs**.
- **Поддержка технологий**:
  - Автоматическое распознавание доменов: Kubernetes, Helm, Terraform, Ansible, Docker, CI/CD, Observability, Service Mesh / Ingress, Data / Storage.
- **Производительность**:
  - Параллельная обработка файлов с помощью многопоточности.
  - Кэширование результатов LLM-запросов и состояния файлов.
- **Фильтрация и настройка**:
  - Учёт `.gitignore`, `.build_ignore`, пользовательских правил в `.ai-docs.yaml`.
  - Поддержка кастомных расширений и исключений.
- **Хранение данных**:
  - Кэш: `.ai_docs_cache/` — хранение LLM-ответов и хэшей файлов.
  - Рабочие данные: `.ai-docs/` — навигационный индекс (`_index.json`), сводки по файлам, отчёт изменений (`changes.md`).

---

## Установка и запуск

### Установка

```bash
pip install ai-docs-gen
```

Или из исходников:

```bash
git clone https://github.com/your-repo/ai_docs.git
cd ai_docs
pip install -e .
```

### Быстрый старт

```bash
ai-docs --source ./my-project --readme --mkdocs --language ru
```

---

## Конфигурация

### Переменные окружения

| Переменная               | Назначение                                  | По умолчанию               |
|--------------------------|---------------------------------------------|----------------------------|
| `OPENAI_API_KEY`         | Ключ для доступа к LLM                      | Обязательна                |
| `OPENAI_BASE_URL`        | Базовый URL API (для кастомных эндпоинтов)  | `https://api.openai.com/v1`|
| `OPENAI_MODEL`           | Модель LLM                                  | `gpt-4o-mini`              |
| `OPENAI_TEMPERATURE`     | Температура генерации                       | `0.2`                      |
| `OPENAI_MAX_TOKENS`      | Макс. токенов в ответе                      | `1200`                     |
| `OPENAI_CONTEXT_TOKENS`  | Лимит контекста                             | `8192`                     |
| `AI_DOCS_THREADS`        | Количество потоков                          | `4`                        |
| `AI_DOCS_LOCAL_SITE`     | Режим локальной сборки MkDocs (без публикации) | `false`                  |

### Конфигурационный файл `.ai-docs.yaml`

Располагается в корне проекта. Пример:

```yaml
include:
  - "*.yaml"
  - "scripts/*.sh"
exclude:
  - "temp/"
  - "**/*.log"
code_extensions:
  - ".py"
  - ".go"
config_extensions:
  - ".tf"
  - ".hcl"
```

Поддерживаемые поля:
- `include`, `exclude` — glob-шаблоны.
- `code_extensions`, `doc_extensions`, `config_extensions` — кастомные расширения.
- `domains` — пользовательская классификация доменов (необязательно).

---

## CLI-интерфейс

### Основная команда

```bash
ai-docs [OPTIONS]
```

### Флаги

| Флаг               | Описание |
|--------------------|---------|
| `--source PATH_OR_URL` | Путь к локальной директории или URL Git-репозитория (обязательный) |
| `--readme`         | Сгенерировать `README.md` |
| `--mkdocs`         | Сгенерировать и собрать сайт MkDocs |
| `--language LANG`  | Язык документации (`ru`, `en`; по умолчанию `ru`) |
| `--threads N`      | Количество потоков (переопределяет `AI_DOCS_THREADS`) |
| `--force`          | Перезаписать существующий `README.md` |
| `--local-site`     | Режим локальной сборки (не публиковать) |
| `--no-cache`       | Отключить кэширование LLM-запросов |
| `--include GLOB`   | Дополнительные шаблоны включения (можно указать несколько) |
| `--exclude GLOB`   | Дополнительные шаблоны исключения |
| `--max-size N`     | Макс. размер файла в байтах (по умолчанию 200_000) |

---

## Процесс генерации

1. **Сканирование**:
   - Определяется тип источника (локальный/удалённый).
   - При необходимости — клонирование репозитория во временную директорию.
   - Рекурсивный обход файлов с фильтрацией по `.gitignore`, `.build_ignore`, `.ai-docs.yaml`.
   - Файлы > 200 КБ или бинарные — пропускаются.

2. **Анализ**:
   - Классификация файлов по типу (код, конфиг, документация).
   - Определение технологических доменов.
   - Построение `file_map` с метаданными и хэшами.

3. **Кэширование**:
   - `CacheManager` сравнивает текущее состояние с `index.json`.
   - Определяются: добавленные, изменённые, удалённые файлы.
   - Только изменённые файлы передаются в LLM.

4. **Генерация**:
   - Каждый файл суммаризируется через `LLMClient` с кэшированием по хешу запроса.
   - Результат нормализуется и сохраняется в `.ai-docs/summaries/`.

5. **Формирование документации**:
   - Генерация `README.md` и `index.md`.
   - Создание разделов: зависимости, тесты, конфигурации, модули.
   - Построение `mkdocs.yml` с навигацией и плагинами (включая `mermaid2`).
   - Запись всех файлов в выходную директорию.

6. **Отчёт изменений**:
   - Формируется `changes.md` с перечнем изменённых файлов и перегенерированных разделов.

---

## Структура выходных данных

```
output/
├── README.md
├── docs/
│   ├── index.md
│   ├── modules/
│   │   ├── module1.md
│   │   └── ...
│   ├── configs/
│   │   ├── config1.md
│   │   └── ...
│   ├── dependencies.md
│   ├── changes.md
│   └── js/mermaid.min.js
├── mkdocs.yml
└── site/ (результат `mkdocs build`)
```

---

## Интеграция в CI/CD

Пример для GitHub Actions:

```yaml
- name: Generate Docs
  run: |
    pip install ai-docs-gen
    ai-docs --source . --mkdocs --readme --language en --force
  env:
    OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
```

---

## Разработка и вклад

### Запуск для отладки

```bash
python -m ai_docs.cli --source ./test-project --readme
```

### Тестирование

```bash
pytest tests/
```

Поддерживаются тесты:
- `test_scanner.py` — проверка фильтрации и сканирования.
- `test_cache_manager.py` — проверка определения изменений.
- `test_format_changes_md.py` — проверка формирования отчёта.

### Вклад

Приветствуются:
- Исправления ошибок.
- Добавление поддержки новых технологий.
- Улучшение промптов.
- Расширение документации.

Лицензия: **MIT**.

---

## Ограничения

- Файлы > 200 КБ не обрабатываются (настраивается через `--max-size`).
- Бинарные файлы пропускаются.
- Требуется стабильное подключение к LLM API.
- Для больших проектов рекомендуется использовать `--threads` и кэширование.

---

## Поддержка

- GitHub Issues: [https://github.com/your-repo/ai_docs/issues](https://github.com/your-repo/ai_docs/issues)
- Документация: `.ai-docs/` в вашем проекте после генерации.
