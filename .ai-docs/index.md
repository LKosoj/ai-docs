# Документация проекта

## Обзор

Проект `ai_docs` — это инструмент автоматической генерации технической документации по исходному коду с использованием языковых моделей (LLM). Он анализирует структуру проекта, классифицирует файлы, генерирует описания и формирует полноценный сайт документации на основе MkDocs.

Поддерживается работа с локальными и удалёнными Git-репозиториями, кэширование LLM-запросов, многопоточная обработка, многоязычность и интеграция с CI/CD.

---

## Архитектура

### Основные компоненты

| Компонент | Назначение |
|---------|-----------|
| `ai_docs.cli` | Точка входа CLI, обработка аргументов, запуск процесса |
| `ai_docs.scanner` | Сканирование файлов, фильтрация, определение типов и доменов |
| `ai_docs.llm` | Взаимодействие с LLM через API с поддержкой кэширования |
| `ai_docs.generator` | Генерация документации по файлам (краткие описания, Doxygen-подобные комментарии) |
| `ai_docs.mkdocs` | Построение `mkdocs.yml`, навигации и структуры сайта |
| `ai_docs.cache` | Управление кэшем файлов и LLM-ответов |
| `ai_docs.utils` | Вспомогательные функции: хеширование, безопасные пути, работа с текстом |
| `ai_docs.tokenizer` | Подсчёт токенов и чанкинг текста для LLM |
| `ai_docs.config` | Классификация файлов и определение доменов (инфра, CI/CD, Kubernetes и др.) |

---

## Настройка окружения

### Конфигурация через `.env`

Создайте `.env` на основе `.env.example`. Поддерживаются следующие параметры:

```env
# OpenAI или совместимый API
OPENAI_API_KEY=your_api_key_here
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4o-mini
OPENAI_MAX_TOKENS=1200
OPENAI_CONTEXT_TOKENS=8192
OPENAI_TEMPERATURE=0.2

# Производительность
AI_DOCS_THREADS=4
AI_DOCS_LOCAL_SITE=true
```

> **Примечание**: Параметры можно переопределять через переменные окружения при запуске.

---

## Запуск генерации

### CLI-аргументы

```bash
python -m ai_docs \
  --source /path/to/repo \
  --output docs \
  --readme \
  --mkdocs \
  --language ru \
  --threads 4 \
  --max-size 2097152 \
  --cache-dir .ai_docs_cache \
  --include "*.py" "*.md" \
  --exclude "tests/*" "*.log"
```

| Аргумент | Описание | По умолчанию |
|--------|---------|-------------|
| `--source` | Путь или URL репозитория | — |
| `--output` | Директория вывода | `output/<repo>` |
| `--readme` | Генерировать `README.md` | `False` |
| `--mkdocs` | Генерировать `mkdocs.yml` и структуру | `False` |
| `--language` | Язык документации | `ru` |
| `--include` | Шаблоны включения файлов | `*` |
| `--exclude` | Шаблоны исключения | См. `DEFAULT_EXCLUDE_PATTERNS` |
| `--max-size` | Макс. размер файла (байт) | `2097152` (2 МБ) |
| `--cache-dir` | Директория кэша | `.ai_docs_cache` |
| `--no-cache` | Отключить кэширование LLM | `False` |
| `--threads` | Количество потоков | `AI_DOCS_THREADS` |
| `--local-site` | Режим локального MkDocs | `AI_DOCS_LOCAL_SITE` |
| `--force` | Перезаписать существующий `README.md` | `False` |

---

## Процесс генерации

1. **Сканирование**  
   - Рекурсивный обход директории или клонирование Git-репозитория (`--depth 1`).
   - Фильтрация по `include`/`exclude`, `.gitignore`, `.build_ignore`.
   - Исключение бинарных файлов и превышающих `--max-size`.

2. **Классификация**  
   - Определение типа файла: `code`, `config`, `infra`, `docs` и др.
   - Обнаружение доменов: `kubernetes`, `docker`, `terraform`, `ci`, `observability`.

3. **Сравнение с кэшем**  
   - Сравнение хешей файлов с предыдущей версией.
   - Определение: `added`, `modified`, `deleted`, `unchanged`.

4. **Генерация документации**  
   - Для изменённых файлов вызывается `summarize_file`.
   - Поддержка двух режимов: краткое резюме и детализированное (Doxygen-подобное).
   - Используется `LLMClient` с кэшированием по хешу запроса.

5. **Постобработка**  
   - Форматирование через `_normalize_module_summary` при необходимости.
   - Сохранение в `.ai-docs/modules/` с безопасными именами (`safe_slug`).

6. **Формирование структуры**  
   - Генерация `mkdocs.yml` с навигацией по модулям.
   - Создание `_index.json` с метаданными.
   - Опционально: `README.md`.

7. **Очистка**  
   - Удаление временных директорий (для Git-репозиториев).
   - Сохранение обновлённого кэша.

---

## Выходные артефакты

Располагаются в директории `.ai-docs/`:

```
.ai-docs/
├── modules/               # Сгенерированные страницы по модулям
├── cache/
│   ├── index.json         # Хеши файлов и состояние
│   └── llm_cache.json     # Кэш ответов LLM
├── _index.json            # Метаданные и навигация
├── README.md              # Опционально
└── mkdocs.yml             # Опционально
```

Сайт документации генерируется в `ai_docs_site/` при использовании `mkdocs build`.

---

## Интеграция с MkDocs

Файл `mkdocs.yml` генерируется автоматически:

```yaml
site_name: "Документация проекта"
docs_dir: ".ai-docs"
site_dir: "ai_docs_site"
nav:
  - Главная: index.md
  - Архитектура: architecture.md
  - Модули:
    - Модуль 1: modules/module_1.md
  - Конфигурации: configs/kubernetes.md
plugins:
  - search
  - mermaid2
markdown_extensions:
  - admonition
  - pymdownx.details
  - pymdownx.superfences
  - tables
```

При `--local-site`:
- `site_url` не задаётся.
- `use_directory_urls: false`.

---

## Расширения и скилы

### Скил `documentary`

Позволяет использовать сгенерированную документацию для навигации и рефакторинга:

- **Требует**: наличие `.ai-docs/`.
- **Источник данных**: `_index.json`, `.md`-файлы.
- **Поведение**:
  - Не генерирует документацию.
  - Не анализирует код напрямую.
  - Отвечает на языке запроса.
  - Указывает, какие файлы `.ai-docs` использованы.

> Если документация устарела — сначала перегенерируйте её.

---

## Тестирование

Доступны юнит-тесты для ключевых модулей:

- `test_scanner.py` — проверка фильтрации и сканирования.
- `test_cache.py` — валидация `diff_files`, `save_index`.
- `test_changes.py` — проверка форматирования отчёта об изменениях.

Запуск:
```bash
python -m unittest discover tests/
```

---

## Рекомендации

- **Для CI/CD**: используйте `--no-cache` и `--force` для чистой генерации.
- **Для локальной разработки**: включите кэширование и `--local-site`.
- **Производительность**: увеличьте `AI_DOCS_THREADS` на мощных машинах.
- **Безопасность**: не коммитьте `.env` с `OPENAI_API_KEY`.

---

## Поддерживаемые форматы

| Тип | Расширения / Имена |
|-----|-------------------|
| Код | `.py`, `.js`, `.ts`, `.go`, `.java` |
| Конфиги | `.yaml`, `.yml`, `.json`, `.toml`, `.env` |
| Инфра | `Dockerfile`, `k8s/*.yaml`, `*.tf`, `helm/*` |
| Документация | `.md`, `README*`, `CHANGELOG*` |
| CI/CD | `.github/`, `.gitlab-ci.yml`, `Jenkinsfile` |

> Подробные правила — в `ai_docs.config`.

---

## Ограничения

- Максимальный размер файла: 2 МБ (настраивается).
- Бинарные файлы не анализируются.
- Git-репозитории клонируются с `--depth 1`.
- Не поддерживается анализ приватных репозиториев без настройки SSH.

---

## Сборка и запуск

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Запуск

```bash
# Как модуль
python -m ai_docs --source . --mkdocs --language ru

# Как скрипт
python ai_docs/cli.py --source https://github.com/user/repo.git --readme
```

### Просмотр документации

```bash
cd ai_docs_site && python -m http.server 8000
```

или

```bash
mkdocs serve -f mkdocs.yml
```
