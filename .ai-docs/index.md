# Документация проекта

## Обзор

`ai_docs` — это CLI-инструмент для автоматической генерации и поддержки технической документации на основе исходного кода, конфигураций и структуры проекта. Поддерживает анализ локальных директорий и Git-репозиториев (локальных и удалённых), интегрируется с LLM для генерации описаний, кэширует результаты и поддерживает инкрементальное обновление.

Основной выход — `README.md` и полноценный сайт документации в формате **MkDocs**, включающий архитектуру, модули, конфигурации, зависимости и изменения.

---

## Установка и запуск

### Установка
```bash
pip install ai-docs-gen
```

Или из исходников:
```bash
git clone https://github.com/your-repo/ai_docs.git
cd ai_docs
pip install -e .
```

### Быстрый старт
```bash
ai-docs --source . --readme --mkdocs --language ru
```

Сгенерирует `README.md` и сайт MkDocs в папке `docs/`.

---

## Основные команды

| Флаг | Назначение |
|------|-----------|
| `--source PATH_OR_URL` | Путь к директории или URL Git-репозитория (обязательный) |
| `--readme` | Генерировать `README.md` |
| `--mkdocs` | Генерировать сайт MkDocs |
| `--language ru|en` | Язык документации (по умолчанию: `ru`) |
| `--threads N` | Количество потоков обработки (по умолчанию: `4`, можно через `AI_DOCS_THREADS`) |
| `--force` | Перезаписать существующий `README.md` |
| `--no-cache` | Отключить кэширование запросов к LLM |
| `--local-site` | Настроить MkDocs для локального запуска (без `site_url`) |
| `--include GLOB` | Дополнительные шаблоны включения файлов |
| `--exclude GLOB` | Дополнительные шаблоны исключения файлов |
| `--max-size N` | Максимальный размер файла в байтах (по умолчанию: `200000`) |

> Если не указаны `--readme` или `--mkdocs`, генерируются оба формата.

---

## Конфигурация

### Переменные окружения

| Переменная | Назначение | По умолчанию |
|-----------|------------|--------------|
| `OPENAI_API_KEY` | Ключ для доступа к LLM (обязательно) | — |
| `OPENAI_BASE_URL` | Базовый URL API (поддержка OpenAI-совместимых эндпоинтов) | `https://api.openai.com/v1` |
| `OPENAI_MODEL` | Модель LLM | `gpt-4o-mini` |
| `OPENAI_TEMPERATURE` | Температура генерации | `0.2` |
| `OPENAI_MAX_TOKENS` | Макс. токенов в ответе | `1200` |
| `OPENAI_CONTEXT_TOKENS` | Лимит контекста | `8192` |
| `AI_DOCS_THREADS` | Количество потоков | `4` |
| `AI_DOCS_LOCAL_SITE` | Режим локального сайта | `false` |

Переменные загружаются из `.env` при запуске.

---

### Файл `.ai-docs.yaml`

Позволяет кастомизировать поведение сканера и генератора.

Пример:
```yaml
code_extensions:
  - .py
  - .js
  - .go
doc_extensions:
  - .md
  - .rst
config_extensions:
  - .yaml
  - .toml
exclude:
  - temp/
  - *.log
```

При отсутствии файла создаётся конфиг по умолчанию с поддержкой типичных расширений и доменов (Terraform, Docker, Kubernetes и др.).

---

## Структура проекта и артефакты

После запуска создаются:

- `.ai-docs/` — рабочая директория:
  - `_index.json` — навигационный индекс, содержит структуру модулей, домены, хэши файлов.
  - `changes.md` — отчёт об изменениях (новые/изменённые/удалённые файлы).
  - `modules/`, `configs/` — сгенерированные описания.
  - `glossary.md`, `dependencies.md`, `architecture.md` — системные разделы.
- `.ai_docs_cache/` — кэш:
  - `index.json` — хэши файлов для инкрементального анализа.
  - `llm_cache.json` — закэшированные ответы LLM.
- `README.md` — краткое описание проекта.
- `mkdocs.yml` — конфигурация сайта.
- `docs/` — выходная директория MkDocs.

> Директории `.ai-docs` и `.ai_docs_cache` добавлены в `.gitignore` по умолчанию.

---

## Принцип работы

### 1. Сканирование файлов
- Рекурсивный обход директории или клонирование Git-репозитория.
- Фильтрация:
  - Учитываются `.gitignore`, `.build_ignore`.
  - Исключаются: `.git`, `__pycache__`, `node_modules`, `.venv`, `dist`, `build`.
  - Файлы > 200 КБ пропускаются (настраивается).
- Определяются типы файлов: код, конфигурация, документация.
- Автообнаружение технологических доменов:
  - Kubernetes, Helm
  - Terraform, Ansible
  - Docker, CI/CD
  - Observability, Service Mesh
  - Data / Storage

### 2. Кэширование и инкрементальный анализ
- `CacheManager` сравнивает текущие хэши файлов с предыдущим состоянием.
- Определяет:
  - `added` — новые файлы
  - `modified` — изменённые
  - `deleted` — удалённые
  - `unchanged` — без изменений
- Только изменённые файлы перепроцессируются.

### 3. Генерация описаний
- Для каждого файла вызывается `summarize_file` с подходящим промптом:
  - `SUMMARY_PROMPT` — базовое описание
  - `MODULE_SUMMARY_PROMPT` — для модулей кода
  - `CONFIG_SUMMARY_PROMPT` — для конфигов
- Текст разбивается на чанки через `chunk_text` при превышении лимита токенов.
- Вывод нормализуется: убираются лишние символы, форматируется в Markdown.

### 4. Построение документации
- Формируется `file_map` — карта всех файлов с метаданными.
- Генерируются разделы:
  - Архитектура (с диаграммами Mermaid)
  - Зависимости (из `pyproject.toml`, `package.json`, `requirements.txt`)
  - Тестирование
  - Изменения (`changes.md`)
- Строится иерархическая навигация через `_build_tree_nav`.
- Генерируется `mkdocs.yml`:
  - Поддержка `mermaid2`, `pymdownx.superfences`
  - Локализованные заголовки (`Архитектура`, `Запуск`, `Тестирование`)
  - При `--local-site`: отключаются `site_url` и `use_directory_urls`

### 5. Вывод
- `README.md` — краткий обзор проекта.
- `docs/` — полная документация, готовая к публикации.
- Автоматически запускается `mkdocs build -f mkdocs.yml`.

---

## Расширения и интеграции

### Поддерживаемые технологии
- **Языки**: Python, JavaScript/TypeScript, Go, Java, C++
- **Инфраструктура**: Terraform, Kubernetes, Helm, Docker, Ansible
- **CI/CD**: GitHub Actions, GitLab CI, Jenkins
- **Мониторинг**: Prometheus, Grafana
- **Сети**: Istio, Traefik, Nginx

### Поддерживаемые форматы конфигураций
- `.yaml`, `.yml`, `.json`, `.toml`, `.env`
- `Dockerfile`, `Makefile`, `Jenkinsfile`

---

## Разработка и вклад

### Запуск для отладки
```bash
python -m ai_docs.cli --source . --readme --mkdocs --language ru --threads 2
```

### Тестирование
```bash
pytest tests/test_scanner.py
pytest tests/test_cache.py
pytest tests/test_changes.py
```

### Требования
- Python ≥ 3.8
- Зависимости: `requests`, `tiktoken`, `PyYAML`, `python-dotenv`, `pathspec`, `mkdocs`, `pymdown-extensions`, `mkdocs-mermaid2-plugin`

### Лицензия
MIT

---

## Ограничения и рекомендации

- **Размер файлов**: >200 КБ — пропускаются. Увеличивайте `--max-size` при необходимости.
- **LLM-запросы**: кэшируются по хешу payload. При `--no-cache` запросы отправляются повторно.
- **Безопасность**: не отправляются бинарные файлы, файлы с нулевыми байтами.
- **Производительность**: используйте `--threads` для ускорения на многоядерных системах.
- **Локализация**: поддерживается `ru` и `en`. Заголовки автоматически локализуются.

---

## Пример `.ai-docs.yaml`

```yaml
code_extensions:
  - .py
  - .ts
  - .rs
doc_extensions:
  - .md
  - .adoc
config_extensions:
  - .yaml
  - .conf
exclude:
  - logs/
  - *.tmp
  - testdata/
```

---

## Диагностика и отладка

- Логи: выводятся в `stdout`.
- Ошибки обработки файла — записываются, продолжается обработка остальных.
- Состояние кэша сохраняется после каждого запуска.
- При сбоях проверьте:
  - Наличие `OPENAI_API_KEY`
  - Доступность Git (для URL-репозиториев)
  - Права на запись в `.ai-docs/` и `.ai_docs_cache/`

---

Документация обновляется автоматически при каждом запуске. Для поддержки актуальности рекомендуется интегрировать `ai_docs` в CI/CD.
