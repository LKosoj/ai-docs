# Обзор проекта

# `ai_docs` — Генерация технической документации

CLI-инструмент `ai_docs` автоматически создаёт техническую документацию по исходному коду и конфигурационным файлам. Поддерживает анализ локальных директорий, локальных и удалённых git-репозиториев.

## Основные возможности
- Генерация `README.md` и полноценного MkDocs-сайта (включая `mkdocs.yml` и сборку в `ai_docs_site/`)
- Автоматическое определение ключевых инфраструктурных доменов: Kubernetes, Helm, Terraform, Ansible, Docker, CI/CD, мониторинг, Service Mesh / Ingress, хранилища данных
- Детальная документация по модулям (`.ai-docs/modules/`) и конфигурациям (`.ai-docs/configs/`)
- Инкрементальная генерация с кэшированием в `.ai_docs_cache/`
- Фильтрация файлов по `.gitignore`, `.build_ignore` и стандартным исключениям
- Параллельная обработка (настраивается через `--threads` или `AI_DOCS_THREADS`)
- Ведение отчёта об изменениях в `docs/changes.md`
- Автоматическая пагинация при превышении 100 модулей/конфигов
- Поддержка мультиязычности и интеграции в CI/CD (например, GitHub Actions)

## Конфигурация
- **API и LLM**: `OPENAI_API_KEY`, `OPENAI_BASE_URL`, `OPENAI_MODEL`, `OPENAI_MAX_TOKENS`, `OPENAI_CONTEXT_TOKENS`, `OPENAI_TEMPERATURE`
- **Потоки**: `AI_DOCS_THREADS`
- **Режим MkDocs**: `AI_DOCS_LOCAL_SITE`
- **Кастомизация**: `.ai-docs.yaml` — настройка расширений файлов (например, `code_extensions: {.py: Python}`), путей и фильтров

## Поддерживаемые форматы
- Исходный код: Python, JavaScript, Go, Java, C++, TypeScript и др.
- Документация: Markdown, reStructuredText
- Конфигурации: YAML, JSON

## CLI-параметры
Поддерживаются опции для указания:
- Источника (путь/URL)
- Выходной директории
- Языка
- Фильтрации
- Управления кэшированием
- Принудительной перегенерации разделов

## Тестирование и сборка
- Тесты: `pytest` в директории `tests/`
- Сборка сайта: `mkdocs build`

## Лицензия
Проект распространяется под лицензией MIT и открыт для вклада.

# `ai_docs` — Генерация технической документации из кода

CLI-инструмент `ai_docs` автоматически создаёт техническую документацию из исходного кода и конфигурационных файлов. Поддерживает локальные директории, локальные и удалённые Git-репозитории. Основные выходные артефакты — `README.md` и полноценный сайт документации на основе MkDocs.

## Возможности
- Автоматическое определение доменов: Kubernetes, Helm, Terraform, Ansible, Docker, CI/CD, Observability, Service Mesh / Ingress, Data / Storage.
- Генерация с использованием LLM (например, GPT-4o-mini) с поддержкой:
  - Параллельной обработки (`--threads`).
  - Кэширования и инкрементального обновления.
  - Учёта `.gitignore`, `.build_ignore` и встроенных исключений (`.venv`, `node_modules`, `dist`, и др.).
- Поддержка фильтрации файлов по расширениям и путям.

## Выходные артефакты
- `README.md` — краткое описание проекта.
- `.ai-docs/` — детализированная документация:
  - `modules/`, `configs/` — документация по модулям и конфигурациям.
  - `changes.md` — отчёт об изменениях.
  - `_index.json` — навигационный индекс.
- `mkdocs.yml` — конфигурация MkDocs.
- `ai_docs_site/` — собранный сайт документации.
- `.ai_docs_cache/` — кэш промежуточных результатов.

## Конфигурация
### Через переменные окружения:
- `OPENAI_API_KEY`, `OPENAI_BASE_URL`, `OPENAI_MODEL`, `OPENAI_MAX_TOKENS`, `OPENAI_CONTEXT_TOKENS`, `OPENAI_TEMPERATURE` — настройки LLM.
- `AI_DOCS_THREADS` — количество потоков.
- `AI_DOCS_LOCAL_SITE` — режим локального сайта.

### Через `.ai-docs.yaml`:
- `code_extensions`, `doc_extensions`, `config_extensions` — расширения файлов.
- `exclude` — пользовательские исключения (например, `temp/*`, `*.log`).

## Основные CLI-параметры
- `--source` — путь или URL к проекту.
- `--readme`, `--mkdocs` — выбор типа генерации.
- `--language` — язык (ru/en).
- `--include`/`--exclude` — фильтрация файлов.
- `--max-size` — лимит размера файлов.
- `--threads` — количество параллельных запросов.
- `--cache-dir`, `--no-cache` — управление кэшем.
- `--local-site` — настройка MkDocs для локального размещения.
- `--force` — перезапись `README.md`.
- `--regen` — перегенерация разделов (`configs`, `modules`, `all`).

## Поведение по умолчанию
- Генерируются `README.md` и MkDocs-сайт.
- Существующие файлы в `.ai-docs/` не перезаписываются (если не указан `--regen`).
- При <50 модулях — полная перегенерация.
- Пагинация при >100 элементов в списках.
- Автоматический запуск `mkdocs build` после генерации.

## Разработка
- Зависимости устанавливаются вручную (см. Quick start).
- Запуск: `python -m ai_docs ...` (для отладки).
- Поддерживаются PR и улучшения.
- Лицензия: MIT.

Файл `pyproject.toml` определяет метаданные и конфигурацию сборки Python-пакета `ai-docs-gen` — CLI-инструмента для автоматической генерации технической документации по исходному коду и конфигурационным файлам.  

В секции `build-system` указаны зависимости для сборки: `setuptools>=68` и `wheel`, а также бэкенд сборки `setuptools.build_meta`.  

Основные метаданные проекта находятся в секции `project`:  
- **name**: `ai-docs-gen`  
- **version**: `0.1.9`  
- **description**: краткое описание назначения пакета  
- **readme**: ссылка на файл `README.md`  
- **requires-python**: минимальная версия Python — 3.8  
- **dependencies**: список зависимостей, включая `openai`, `pyyaml`, `mkdocs` и плагины для расширения функциональности документации (Mermaid, Markdown-расширения)  

Секция `project.scripts` объявляет консольную команду `ai-docs`, которая запускает функцию `main` из модуля `ai_docs.cli`.  

В `tool.setuptools.packages.find` указано, что при автоматическом поиске пакетов включается `ai_docs`, но исключается поддиректория `assets`.  

В `tool.setuptools.package-data` определено, что в пакет необходимо включить файл `assets/mermaid.min.js`, используемый для визуализации диаграмм в документации.

Файл реализует асинхронные функции для генерации и обновления аннотаций (сводок) к файлам в проекте с использованием LLM. Основное назначение — параллельная обработка изменённых или отсутствующих сводок для кода, конфигураций и модулей с контролем числа одновременных запросов.

Ключевые сущности:
- `summarize_changed_files`, `summarize_changed_modules`, `summarize_changed_configs` — обрабатывают только изменившиеся файлы, разделяя по типам (код, модули, конфиги).
- `summarize_missing_*` — аналогичные функции, но для восстановления пропущенных сводок с отображением прогресса.
- Используется семафор (`asyncio.Semaphore`) для ограничения числа параллельных задач, передаётся через параметр `threads`.
- Все функции используют `summarize_file` для генерации текста сводки и `write_summary` для её сохранения на диск.
- Результаты записываются в метаданные (`meta`) как `summary_path`, `module_summary_path` или `config_summary_path`.
- Ошибки накапливаются в списке `errors`, прогресс отслеживается через `save_cb` и выводится в консоль каждые 5 задач.

Важные настройки:
- `llm` — модель для генерации, используется `llm.model` и кэширование через `llm_cache`.
- `summaries_dir`, `module_summaries_dir`, `config_summaries_dir` — директории для сохранения разных типов сводок.
- `is_test_path` — фильтрация тестовых файлов при обработке модулей.
- Параметр `True/False` в вызове `summarize_file` определяет, генерируется ли сводка как для модуля (с акцентом на интерфейс).

# Обзор модуля сканирования репозиториев

Модуль предназначен для сканирования и анализа структуры репозиториев с целью извлечения информации, пригодной для генерации документации.

## Основные компоненты

- **`ScanResult`** — основной класс, содержащий результаты сканирования: список файлов с метаданными (путь, размер, тип, домены, первые 4000 символов содержимого), корневой путь, исходный URL/путь и имя репозитория.

## Конфигурация и фильтрация

- **Шаблоны включения**: `FIXED_INCLUDE_PATTERNS` — фиксированный набор файлов, всегда включаемых в сканирование (например, `Dockerfile`, `*.tf`, `package.json`).
- **Шаблоны исключения**: `DEFAULT_EXCLUDE_PATTERNS` — стандартные пути, исключаемые по умолчанию (`.git`, `node_modules`, `.venv`, `__pycache__` и др.).
- Поддержка пользовательских правил из:
  - `.ai-docs.yaml` — основной конфигурационный файл (создаётся по умолчанию при отсутствии).
  - `.gitignore`, `.build_ignore` — обрабатываются через `pathspec`.
- **Расширения файлов**:
  - `code_extensions`, `doc_extensions`, `config_extensions` — пользовательские расширения с описанием типов файлов.
- **`exclude`** — пользовательские шаблоны исключений, дополняющие стандартные.

## Функции

- **`_clone_repo`** — клонирует удалённый Git-репозиторий во временную директорию для сканирования.
- **`scan_source`** — основная функция для анализа:
  - Принимает `source` (локальный путь или URL репозитория).
  - Автоматически определяет тип источника.
  - При необходимости клонирует репозиторий.
  - Загружает конфигурацию через `_load_extension_config`.
  - Рекурсивно сканирует файлы с помощью `_scan_directory`.
- **`_scan_directory`** — обходит файлы, применяя фильтры:
  - Проверка типа (текстовый/бинарный), размера (ограничение `max_size`, по умолчанию 200 КБ), симлинков.
  - Фильтрация по шаблонам включения/исключения.

## Результат

Возвращается объект `ScanResult` с полной информацией о проанализированных файлах, готовой к использованию в генерации документации.

Файл содержит функции для генерации и управления документацией проекта. Основное назначение — запись файлов документации, построение индекса, интеграция Mermaid.js для визуализации диаграмм, генерация `mkdocs.yml` и сборка сайта документации с помощью MkDocs.

Ключевые сущности:
- `write_docs` — основная функция записи документации, создает индекс, добавляет статические ресурсы (включая Mermaid), сохраняет файлы и очищает устаревшие.
- `build_docs_index` — формирует структурированный индекс документации на основе файлов и разделов.
- `add_mermaid_asset` — добавляет JavaScript-файл Mermaid для отрисовки диаграмм в документации.
- `write_readme` — записывает `README.md` в корень проекта, с опцией принудительной перезаписи.
- `build_mkdocs` — генерирует конфигурацию `mkdocs.yml` и запускает сборку сайта документации, поддерживает виртуальное окружение.
- `_postprocess_mermaid_html` — постобработка HTML-файлов после сборки, замена `&gt;` на `>` для корректного отображения Mermaid-диаграмм.
- `__serialize_index` — сериализует индекс документации в JSON с меткой времени и правилами ранжирования.

Важные настройки и параметры:
- `SECTION_TITLES`, `DOMAIN_TITLES` — определяют структуру и заголовки разделов документации.
- `has_changes` — триггер очистки устаревших файлов.
- `local_site` — режим локальной сборки сайта (влияет на настройки MkDocs).
- `write_mkdocs` — флаг, управляющий генерацией `mkdocs.yml` и сборкой сайта.
- Автоматическое управление зависимостями через `.venv` или системный `mkdocs`.

Функционал интегрирован с MkDocs, поддерживает динамическую навигацию, очистку неиспользуемых файлов и постобработку результата для корректной работы Mermaid.

# Резюме: Генерация технической документации

Файл предназначен для автоматической генерации и обновления технической документации проекта на основе анализа исходных файлов, аннотаций и контекста. Основные функции включают:

- **Построение иерархического контекста** из фрагментов кода, описаний, зависимостей и тестов с использованием иерархического суммирования для укладки в лимит токенов (`input_budget`).
- **Генерация структурированных разделов документации**, включая:
  - Обзор проекта
  - Архитектура (с Mermaid-диаграммами)
  - Модули и конфигурации (с пагинацией при >100 элементов)
  - Тестирование
  - Зависимости
  - Изменения (`changes.md`)
  - Индекс и навигация
- **Поддержка многоязычности** (`language`) и **кэширование запросов к LLM** (`llm_cache`) для повышения эффективности.
- **Параллельная и асинхронная обработка** с ограничением потоков (`threads`, семафоры) и принудительным обновлением при необходимости (`force_all`, `is_forced`).
- **Управление файлами документации** через `docs_dir`: создание, обновление и удаление устаревших файлов (особенно конфигураций по доменам).
- **Ключевые сущности**:
  - `docs_files` — содержимое генерируемых файлов
  - `section_contexts` — кэш контекстов разделов
  - `module_pages`, `config_pages` — страницы модулей и конфигов
  - `config_nav_paths`, `module_nav_paths` — навигационные пути
  - `regenerated_sections` — список обновлённых разделов
- **Настройки**: `AI_DOCS_REGEN_ALL_THRESHOLD`, `force_sections`, `DOMAIN_TITLES`, `SECTION_TITLES` — управляют логикой генерации и структурой.
- При отсутствии глоссария создаётся заглушка; генерируется `README` и сводка изменений.

**Результат**: комплексная, актуальная документация в формате Markdown, адаптированная под структуру проекта и настройки пользователя.

Скрипт `main.py` — точка входа для генерации документации (README и MkDocs) на основе исходных кодов или конфигураций. Поддерживает локальные директории и Git-репозитории по URL.  

**Назначение**: автоматическое создание документации с использованием LLM, включая анализ архитектуры, модулей, конфигураций и изменений.  

**Ключевые сущности**:  
- `scan_source` — сканирование файлов с фильтрацией по шаблонам (`--include`, `--exclude`) и ограничением размера (`--max-size`).  
- `from_env` — инициализация LLM на основе переменных окружения (например, `LLM_MODEL`, `LLM_API_KEY`).  
- `generate_docs` — основная логика генерации, кэширование ответов LLM, параллельная обработка.  

**Важные параметры командной строки**:  
- `--source` — обязательный путь или URL к исходникам.  
- `--readme`, `--mkdocs` — выбор типа генерируемой документации.  
- `--language` — язык документации (`ru` по умолчанию).  
- `--regen` — принудительная перегенерация указанных разделов (например, `architecture,configs`).  
- `--force` — перезапись существующего `README.md`.  
- `--no-cache` — отключение кэширования запросов к LLM.  
- `--threads` — количество параллельных запросов к модели.  
- `--local-site` — настройка MkDocs для локального запуска.  
- `--cache-dir` — директория кэша (по умолчанию `.ai_docs_cache` внутри `output_root`).  

**Переменные окружения**:  
- `AI_DOCS_THREADS` — количество потоков по умолчанию.  
- `AI_DOCS_LOCAL_SITE` — флаг для локальной конфигурации MkDocs.  
- `AI_DOCS_REGEN` — передаётся в `generate_docs` при использовании `--regen`.  

После обработки временные файлы (для URL-репозиториев) удаляются. Вывод размещается в `output_root`, который определяется автоматически, если не задан явно.

Класс `LLMClient` предоставляет асинхронный интерфейс для взаимодействия с моделью крупного языка (LLM) через OpenAI-совместимое API с поддержкой кэширования, повторных попыток и динамического таймаута. Основан на `AsyncOpenAI` и использует `httpx` для сетевых запросов.

**Ключевые сущности:**
- `LLMClient`: основной класс для отправки запросов к модели.
- `from_env`: фабричная функция, создающая клиент на основе переменных окружения.

**Параметры инициализации:**
- `api_key`: ключ API для аутентификации.
- `base_url`: базовый URL провайдера (опционально, для сторонних хостов).
- `model`: модель для генерации (например, `gpt-4o-mini`).
- `temperature`: параметр креативности генерации (по умолчанию 0.2).
- `max_tokens`: максимальное число токенов в ответе.
- `context_limit`: лимит контекстных токенов модели.

**Особенности:**
- Автоматическая оценка количества входных токенов через `count_tokens`.
- Динамический таймаут чтения (`_compute_read_timeout`) в зависимости от объема входных данных.
- Поддержка кэширования ответов по хешу входного `payload` (через `sha256_text`).
- Устойчивость к сбоям: повторные попытки при ошибках 408, 429, 5xx и таймаутах с экспоненциальной задержкой.
- Потокобезопасное кэширование с использованием `asyncio.Lock`.

**Переменные окружения (используются в `from_env`):**
- `OPENAI_API_KEY` — обязательный ключ API.
- `OPENAI_BASE_URL` — опциональный URL для переопределения эндпоинта.
- `OPENAI_MODEL` — модель (по умолчанию `gpt-4o-mini`).
- `OPENAI_TEMPERATURE` — температура (по умолчанию 0.2).
- `OPENAI_MAX_TOKENS` — максимальное число токенов в ответе (по умолчанию 1200).
- `OPENAI_CONTEXT_TOKENS` — лимит контекста (по умолчанию 8192).

Функция `chat` отправляет список сообщений и возвращает сгенерированный текст, при необходимости сохраняя результат в кэш.

# Резюме модуля обработки технической документации

## Назначение
Модуль предназначен для автоматизированной обработки, нормализации и генерации текстовых описаний конфигураций и модулей с целью интеграции в техническую документацию. Поддерживает форматирование в стиле Doxygen и конфигурационном стиле с использованием LLM и кэшированием.

## Основные функции
- **Проверка и нормализация формата текста** с учётом структурных требований.
- **Асинхронная обработка** больших файлов с разбиением на чанки по ограничению токенов.
- **Генерация резюме** с применением специализированных промптов в зависимости от типа файла (`config`, `infra` и др.) и режима (`detailed`).
- **Форматирование секций** с параметрами и ключами, включая обработку блоков кода и списков.
- **Сохранение результатов** в виде Markdown-файлов с безопасным именованием.

## Ключевые структуры
- `SUMMARY_PROMPT` — общий промпт для резюме.
- `MODULE_SUMMARY_PROMPT`, `MODULE_SUMMARY_REFORMAT_PROMPT` — для Doxygen-документации модулей.
- `CONFIG_SUMMARY_PROMPT`, `CONFIG_SUMMARY_REFORMAT_PROMPT` — для конфигурационных файлов.

## Вспомогательные функции
- `_needs_doxygen_fix` — проверка на несоответствие Doxygen-формату.
- `_normalize_module_summary` — нормализация описания модуля через LLM.
- `_normalize_config_summary` — нормализация конфигурационного описания.
- `_format_config_blocks` — форматирование секций с `<br>`.
- `_strip_fenced_markdown` — очистка от Markdown-блоков (```) и лишних пробелов.
- `summarize_file` — основная функция генерации резюме с кэшированием.
- `write_summary` — сохранение резюме в файл.

## Использование
Модуль автоматизирует документирование кодовой базы, обеспечивая единообразие и соответствие стандартам форматирования.

Модуль отвечает за генерацию конфигурационного файла `mkdocs.yml` и запись Markdown-документации в файловую систему. Основная функция `build_mkdocs_yaml` формирует YAML-конфигурацию сайта документации с поддержкой структурированной навигации, включая разделы по архитектуре, запуску, тестированию, конфигурации и модулям. Поддерживается кастомизация навигации через параметры `sections`, `configs`, `module_nav_paths` и `project_config_nav_paths`. Для корректного отображения Mermaid-диаграмм в MkDocs используется плагин `mermaid2`, который регистрируется в `markdown_extensions` с кастомным репрезентером через `pyyaml`. Функция `_build_tree_nav` строит древовидную структуру навигации на основе путей файлов, преобразуя иерархию директорий в вложенную структуру `nav`. Функция `write_docs_files` записывает переданные файлы в указанную директорию, создавая необходимые поддиректории. Конфигурация адаптируется под локальный запуск при установке флага `local_site`.

Основной модуль генерации документации с использованием LLM. Оркестрирует процесс анализа исходных файлов, кэширования, создания и обновления документации на основе изменений. Поддерживает асинхронную обработку, многопоточность и инкрементальное обновление.

Ключевые сущности:  
- `generate_docs` — синхронная точка входа, запускает асинхронный процесс через `asyncio`.  
- `_generate_docs_async` — основная логика: вычисление diff'а, суммаризация изменённых и отсутствующих файлов, построение структуры документации, запись результатов.  
- Интеграция с кэшем (`init_cache`, `save_cache_snapshot`) для оптимизации перегенерации.  
- Поддержка разных типов документации: модули, конфигурации, общие файлы.  

Важные настройки:  
- `use_cache` — включение/отключение кэширования.  
- `threads` — количество потоков для параллельной обработки.  
- `force` — принудительная перезапись README.  
- `write_readme_flag` — флаг генерации README.  
- `write_mkdocs` — флаг генерации конфигурации MkDocs.  
- `local_site` — режим локального сайта (влияет на структуру навигации).  
- `AI_DOCS_REGEN` — переменная окружения для указания секций, которые нужно перегенерировать принудительно.  

Результат:  
- Генерация документации в `output_root/.ai-docs`.  
- Создание `README.md` и `mkdocs.yml` (опционально).  
- Вывод отчётов об ошибках, если таковые возникли.

Модуль предоставляет функции для управления кэшированием, сравнения файлов, обновления и очистки промежуточных данных (включая резюме файлов) в рамках анализа кодовой базы. Основное назначение — оптимизация процесса обработки файлов за счёт повторного использования ранее вычисленных результатов и поддержания согласованности кэша.

Ключевые сущности:  
- `CacheManager` — управляет хранением и загрузкой кэша (LLM-ответов, индекса файлов).  
- `file_map` — словарь с метаданными файлов (хэш, размер, тип, домены, содержимое), построенный по списку файлов.  
- Промежуточные директории: `intermediate/files`, `intermediate/modules`, `intermediate/configs` — хранят резюме файлов, модулей и конфигураций соответственно.

Основные функции:  
- `init_cache` — инициализирует менеджер кэша, загружает данные индекса и LLM-кэш (если включён).  
- `build_file_map` — создаёт карту файлов с их хэшами и метаданными.  
- `diff_files` — определяет, какие файлы изменились, добавились или были удалены.  
- `ensure_summary_dirs` — гарантирует существование директорий для промежуточных резюме.  
- `save_cache_snapshot` — сохраняет обновлённый индекс файлов и LLM-кэш.  
- `carry_unchanged_summaries` — переносит пути к существующим резюме для неизменившихся файлов, выявляет отсутствующие.  
- `cleanup_orphan_summaries` — удаляет резюме, на которые нет ссылок в текущем file_map.  
- `cleanup_deleted_summaries` — удаляет резюме для удалённых файлов.

Важные настройки:  
- `use_cache` — флаг, определяющий, используется ли кэширование LLM-ответов.  
- `cache_dir` — директория хранения кэша, включая промежуточные файлы.  
- Проверка типа файла (`code`, `config`) и пути (через `is_test_path`) влияет на генерацию и сохранение резюме.

# Резюме документации

Данный документ представляет собой обобщённое описание системы, её компонентов, функциональных возможностей и принципов работы. Система предназначена для эффективного управления данными и обеспечения взаимодействия между различными модулями через чётко определённые интерфейсы. Включает в себя описание архитектуры, основных процессов, требований к окружению и инструкции по развертыванию. Документация ориентирована на разработчиков, администраторов и технических специалистов, обеспечивая полное понимание системы и поддержку её эксплуатации.

Модуль предоставляет инструменты для подсчёта токенов и разбиения текста на части с учётом ограничений по токенам, в зависимости от модели. Использует `tiktoken` для корректного токенизации моделей OpenAI, а при отсутствии поддержки — резервное побайтовое кодирование. Основные функции: `get_encoding` возвращает токенизатор для указанной модели, `count_tokens` подсчитывает количество токенов в тексте, `chunk_text` разделяет текст на фрагменты заданного максимального размера в токенах. Ключевая настройка — параметр `max_tokens` в `chunk_text`, определяющий длину каждого фрагмента. В случае недоступности `tiktoken` используется внутренний класс `_ByteEncoding`, кодирующий текст как UTF-8 байты.

Функция формирует Markdown-отчёт об изменениях, внесённых в проект после генерации файлов. Отчёт включает списки добавленных, изменённых и удалённых файлов, перечень перегенерированных разделов и краткое резюме. Основные параметры: `added`, `modified`, `deleted` — словари с путями файлов; `regenerated_sections` — список названий разделов, подвергшихся перегенерации; `summary` — текст итогового описания изменений. Результат возвращается в виде строки в формате Markdown.

Файл содержит вспомогательные функции для анализа структуры проекта и генерации документации. Основное назначение — сбор информации о тестах, зависимостях, конфигурационных файлах и навигации по документации.  

Ключевые сущности:  
- `SECTION_TITLES`, `DOMAIN_TITLES` — отображение внутренних ключей в читаемые заголовки разделов и доменов.  
- `is_test_path` — определяет, является ли путь тестовым по имени или расположению.  
- `collect_dependencies` — извлекает зависимости из `pyproject.toml`, `requirements.txt`, `package.json`.  
- `collect_test_info` — находит тестовые файлы и команды для запуска тестов (например, `pytest`, `npm test`).  
- `render_testing_section` — формирует Markdown-описание тестов и способов их запуска.  
- `render_project_configs_index` — генерирует оглавление для конфигурационных файлов.  
- `strip_duplicate_heading`, `first_paragraph` — утилиты для обработки текста документации.  
- `build_docs_index` — строит иерархию разделов, модулей и конфигураций для навигации в документации.  

Важные настройки и поведение:  
- Поддержка нескольких форматов конфигураций: TOML, JSON, текстовые файлы.  
- Автоматическое определение тестовых файлов по имени и пути.  
- Формирование структуры документации на основе наличия файлов в `docs/` и метаданных из `file_map`.  
- Генерация кратких описаний модулей и конфигураций на основе первого абзаца из соответствующих `.md`-файлов.

Вспомогательные утилиты для работы с файлами, хеширования и путей. Основные функции: вычисление SHA-256 хеша от байтов и строк, безопасное чтение текстовых файлов с кодировкой UTF-8, проверка, является ли файл бинарным (по наличию нулевых байтов), определение URL по префиксу, нормализация путей в POSIX-формат и создание slug-идентификаторов из строк. Также включает функцию `ensure_dir` для создания директорий с проверкой существования. Используется для подготовки и валидации файловой структуры, безопасной обработки путей и определения типов источников (локальные файлы или URL).

Словари с описаниями расширений файлов и наборы ключевых имён/путей для классификации файлов в проекте. Определяет тип файла (код, конфигурация, документация и др.) и домены инфраструктуры (Kubernetes, Terraform, Docker и др.) на основе расширения, имени и пути. Используется для анализа структуры проекта. Основные сущности: `CODE_EXTENSIONS`, `CONFIG_EXTENSIONS`, `CI_FILENAMES`, `DOCKER_FILENAMES`, `TERRAFORM_EXTENSIONS`, `classify_type`, `detect_domains`. Ключевые параметры — расширения файлов и пути, ассоциированные с инфраструктурными технологиями.

Модуль обеспечивает запуск основного CLI-интерфейса приложения `ai_docs`. Реализует гибкую загрузку функции `main` из модуля `cli`, поддерживая как импорт в рамках пакета, так и запуск скрипта напрямую. В случае, если импорт через относительный путь не удается, автоматически добавляет родительский каталог в `sys.path` для корректного импорта. Основная логика запускается при выполнении файла как скрипта через `if __name__ == "__main__"`, что делает возможным использование команды `python ai_docs/cli.py` из терминала. Ключевая сущность — функция `main`, отвечающая за обработку аргументов командной строки и выполнение действий.

Класс `CacheManager` предназначен для управления кэшем в файловой системе, включая хранение индекса файлов и кэша ответов LLM. Работает с двумя основными файлами: `index.json` — для отслеживания состояния файлов (хэши, метаданные), и `llm_cache.json` — для хранения закэшированных текстовых ответов по ключам. При инициализации создает директорию кэша, если её нет. Метод `load_index` возвращает индекс файлов, инициализируя пустую структуру при отсутствии файла. Метод `save_index` записывает индекс с форматированием. Метод `load_llm_cache` безопасно загружает кэш LLM, обрабатывает пустые и битые JSON-файлы, сохраняя повреждённые данные в резервный файл с суффиксом `.bad`. Метод `save_llm_cache` сохраняет кэш, делая снимок данных. Метод `diff_files` сравнивает текущие метаданные файлов с сохранёнными и возвращает четыре словаря: добавленные, изменённые, удалённые и неизменные файлы — на основе сравнения хэшей. Используется для оптимизации обработки документов при повторных запусках.

Тестовый модуль для проверки функциональности сканера исходного кода из пакета `ai_docs.scanner`. Основное назначение — верификация корректной обработки файлов в директории, включая учёт правил игнорирования. Ключевая функция — `scan_source`, которая анализирует указанную директорию и возвращает список файлов, исключая игнорируемые (например, по правилам `.gitignore` и стандартным шаблонам вроде виртуальных окружений). В тесте `test_scan_local_dir` создаётся временная структура файлов, включая `app.py`, `Dockerfile`, `.gitignore` и файл в виртуальном окружении. Проверяется, что сканируются только ожидаемые файлы, а игнорируемые (например, `ignored.txt` и файлы из `.venv`) исключаются из результата.

# Резюме документации

Данный документ представляет собой обобщённое описание системы, её компонентов, функциональных возможностей и принципов работы. Система предназначена для эффективного управления данными и обеспечения взаимодействия между различными модулями через чётко определённые интерфейсы. Включает в себя описание архитектуры, основных процессов, требований к окружению и инструкции по развертыванию. Документация ориентирована на разработчиков, администраторов и технических специалистов, обеспечивая полное понимание системы и поддержку её эксплуатации.

Назначение файла — тестирование функциональности класса `CacheManager`, отвечающего за управление кэшем файлов, включая отслеживание изменений, добавление, удаление и определение неизменённых файлов. Основная сущность — класс `CacheManager`, работающий с индексом кэша, хранящим хэши файлов. Тесты проверяют метод `diff_files`, который сравнивает переданный список файлов с сохранённым состоянием и возвращает четыре категории: добавленные, изменённые, удалённые и неизменённые файлы. Важные аспекты: временная директория для изоляции тестов, последовательное обновление индекса через `save_index` и проверка корректности определения статусов файлов при изменении состояния. Тесты охватывают сценарии первого запуска, изменения хэшей, добавления и удаления файлов.

Файл содержит модульные тесты для функции `format_changes_md`, формирующей Markdown-представление изменений в документации. Основное назначение — проверка корректности генерации разделов по добавленным, изменённым, удалённым файлам и перегенерированным разделам. В тесте участвуют словари `added`, `modified`, `deleted` и список `regenerated`, а также параметр `summary`. Проверяется наличие ключевых заголовков и упоминание имён файлов и разделов в выходной Markdown-строке. Тест убеждается, что все компоненты правильно отображаются в итоговом тексте.

Помогает в разработке и рефакторинге кода, используя предварительно сгенерированную документацию в каталоге `.ai-docs`. Назначение — быстрая ориентация в структуре проекта, модулях, архитектуре и соглашениях без прямого анализа исходного кода на первом этапе.

Ключевые сущности:  
- Каталог `.ai-docs` — основной источник информации.  
- Файл `_index.json` — навигационный индекс для определения приоритетных модулей.  
- Основные документы: `index.md`, `architecture.md`, `conventions.md`, `dependencies.md`, модульные описания в `modules/`.  

Важные настройки и правила:  
- При отсутствии `.ai-docs` — возвращать сообщение о необходимости предварительной генерации документации.  
- Классифицировать запросы (обзор, рефакторинг, уточнение) и выбирать соответствующие разделы.  
- Использовать приоритеты и ранжирование из `_index.json` для фильтрации релевантных модулей.  
- Опор на `.md`-файлы для формирования контекста; переход к исходному коду — только после локализации нужного компонента через документацию.  
- Ответ формируется на языке запроса пользователя.  
- Не предлагать обновление или перегенерацию документации.  

Результат включает краткий вывод, ссылки на задействованные файлы `.ai-docs` и, при необходимости, план действий с привязкой к разделам документации.
