# Обзор проекта

# `ai_docs` — CLI-инструмент генерации технической документации

`ai_docs` — инструмент командной строки для автоматической генерации технической документации по исходному коду и конфигурационным файлам. Поддерживает анализ локальных директорий, локальных и удалённых Git-репозиториев.

## Основные возможности
- Автоматическое определение доменов: Kubernetes, Helm, Terraform, Ansible, Docker, CI/CD, Observability, Service Mesh / Ingress, Data / Storage.
- Генерация `README.md` и полноценного MkDocs-сайта.
- Инкрементальная обработка с кэшированием в `.ai_docs_cache/` и логом изменений в `docs/changes.md`.
- Учёт `.gitignore`, `.build_ignore` и встроенных исключений (`.venv`, `node_modules`, `.ai-docs`, `dist` и др.).
- Параллельная обработка файлов (настраивается через `AI_DOCS_THREADS`).

## Структура проекта
- `.ai-docs/` — сгенерированная документация (`overview.md`, `changes.md`, модули, конфиги, `_index.json`).
- `mkdocs.yml`, `ai_docs_site/` — конфигурация и собранный сайт документации.
- `.ai-docs/_index.json` — навигационный индекс с маршрутами и приоритетами.

## Конфигурация
- `.ai-docs.yaml` — опциональный файл для настройки расширений:
  - `code_extensions`: сопоставление расширений с языками (напр., `.py` → `Python`).
  - `doc_extensions`: расширения документации (`.md`, `.rst`).
  - `config_extensions`: конфиги (`.yml`, `.json`).
  - `exclude`: шаблоны исключений (напр., `temp/*`, `*.log`).
- При отсутствии — создаётся автоматически.

## Переменные окружения
| Переменная | Назначение | По умолчанию |
|-----------|------------|--------------|
| `OPENAI_API_KEY` | Ключ доступа к LLM | — |
| `OPENAI_MODEL` | Модель для суммаризации | `gpt-4o-mini` |
| `OPENAI_MAX_TOKENS` | Макс. токенов в ответе | — |
| `OPENAI_CONTEXT_TOKENS` | Макс. длина контекста | — |
| `OPENAI_TEMPERATURE` | Температура генерации | — |
| `AI_DOCS_THREADS` | Число потоков обработки | — |
| `AI_DOCS_LOCAL_SITE` | Локальный запуск MkDocs | `false` |

Инструмент интегрируется в CI/CD и поддерживает повторяемую, актуальную документацию на основе кода.

# `ai_docs` — Генерация технической документации из кода

CLI-инструмент `ai_docs` автоматически создаёт техническую документацию из исходного кода и конфигурационных файлов. Поддерживает локальные директории, локальные и удалённые Git-репозитории. Основные выходные артефакты — `README.md` и полноценный сайт документации на основе MkDocs.

## Особенности
- Автоматическое определение доменов: Kubernetes, Helm, Terraform, Ansible, Docker, CI/CD, Observability, Service Mesh, Data/Storage.
- Поддержка множества языков (Python, JS/TS, Go, Java, C++, Rust и др.) по расширениям файлов.
- Учёт `.gitignore`, `.build_ignore` и стандартных исключений (`.venv`, `node_modules`, `dist`, `build`, `.ai-docs`, `.ai_docs_cache`, `ai_docs_site` и др.).
- Параллельная обработка с настраиваемым числом потоков (`--threads` / `AI_DOCS_THREADS`).
- Инкрементальная генерация с кэшированием; отчёт об изменениях — `docs/changes.md`.
- Поддержка `.ai-docs.yaml` для кастомизации сканирования (расширения, приоритеты, исключения).

## Выходные артефакты
- `README.md` — краткое описание проекта.
- `.ai-docs/` — структурированные страницы документации.
- `.ai-docs/_index.json` — навигационный индекс.
- `mkdocs.yml` — конфигурация MkDocs.
- `ai_docs_site/` — собранная документация.
- `.ai_docs_cache/` — кэш LLM-запросов.

## Переменные окружения
```bash
OPENAI_API_KEY=...                # обязательный ключ API
OPENAI_BASE_URL=...               # опциональный URL (по умолчанию OpenAI)
OPENAI_MODEL=gpt-4o-mini          # модель LLM
OPENAI_MAX_TOKENS=4096            # лимит токенов
OPENAI_CONTEXT_TOKENS=32768       # контекстные токены
OPENAI_TEMPERATURE=0.3            # креативность
AI_DOCS_THREADS=4                 # число потоков
AI_DOCS_LOCAL_SITE=true           # локальный режим MkDocs (без публикации)
```

## CLI-опции
- `--source` — путь или URL к проекту.
- `--readme` / `--mkdocs` — тип генерации.
- `--language ru/en` — язык документации.
- `--force` — перезапись файлов.
- `--regen` — перегенерация указанных разделов.
- `--local-site` — настройка MkDocs для локального хостинга.
- `--no-cache` — отключение кэширования.

## Интеграция
Поддерживается в CI/CD (например, GitHub Actions) через установку `ai-docs-gen` и передачу переменных окружения. Сборка сайта: `mkdocs build -f mkdocs.yml`.

## Дополнительно
- `/index.md` разбивается на страницы по 100 элементов с навигацией ←/→.
- Для разработки: `python -m ai_docs ...`, зависимости — см. «Quick start».
- Лицензия: MIT.
- Приветствуются pull request'ы и предложения.

Файл `pyproject.toml` определяет метаданные и конфигурацию сборки Python-пакета `ai-docs-gen` — CLI-инструмента для автоматической генерации технической документации по исходному коду и конфигурационным файлам.  

В секции `build-system` указаны зависимости для сборки: `setuptools>=68` и `wheel`, а также бэкенд сборки `setuptools.build_meta`.  

Основные метаданные проекта находятся в секции `project`:  
- **name**: `ai-docs-gen`  
- **version**: `0.1.9`  
- **description**: краткое описание назначения пакета  
- **readme**: ссылка на файл `README.md`  
- **requires-python**: минимальная версия Python — 3.8  
- **dependencies**: список зависимостей, включая `openai`, `pyyaml`, `mkdocs` и плагины для расширения функциональности документации (Mermaid, Markdown-расширения)  

Секция `project.scripts` объявляет консольную команду `ai-docs`, которая запускает функцию `main` из модуля `ai_docs.cli`.  

В `tool.setuptools.packages.find` указано, что при автоматическом поиске пакетов включается `ai_docs`, но исключается поддиректория `assets`.  

В `tool.setuptools.package-data` определено, что в пакет необходимо включить файл `assets/mermaid.min.js`, используемый для визуализации диаграмм в документации.

# Резюме: Асинхронная генерация аннотаций с использованием LLM

Файл предназначен для асинхронной обработки и генерации сводок (аннотаций) для различных типов файлов — кода, конфигураций и модулей — с помощью языковых моделей (LLM). Поддерживает параллельную обработку с ограничением числа одновременных задач через `asyncio.Semaphore`.

## Ключевые функции
- **`summarize_changed_*`**: Обработка изменённых файлов (файлы, модули, конфиги).
- **`summarize_missing_*`**: Генерация сводок для файлов без существующих аннотаций.
- **`summarize_file`**: Основная функция генерации аннотации; флаг указывает на тип (модульную или файловую).
- **`write_summary`**: Сохранение результата в файл.
- **`is_test_path`**: Фильтрация тестовых файлов при обработке модулей.

## Настройки и параметры
- **`threads`**: Максимальное число параллельных задач.
- **`llm` / `llm_cache`**: Модель для генерации и кэширование результатов.
- **`save_cb`**: Колбэк после успешной обработки файла.
- **`errors`**: Сбор ошибок в процессе выполнения.
- **`log_every`**: Логирование прогресса каждые 5 задач или по завершении.

## Пути сохранения
- `summaries_dir` — общие сводки.
- `module_summaries_dir` — сводки по модулям.
- `config_summaries_dir` — конфигурационные сводки (записывается в `meta["config_summary_path"]`).

## Особенности реализации
- Асинхронная обработка через `run_one`.
- Синхронизация доступа к ресурсам через `lock`.
- Поддержка кэширования для оптимизации.
- Фильтрация тестовых путей.
- Периодический вывод прогресса и накопление ошибок.

# Обзор модуля сканирования репозиториев

Модуль предназначен для сканирования и анализа структуры репозиториев с целью извлечения информации, пригодной для генерации документации.

## Основные компоненты

- **`ScanResult`** — основной класс, содержащий результаты сканирования: список файлов с метаданными (путь, размер, тип, домены, первые 4000 символов содержимого), корневой путь, исходный URL/путь и имя репозитория.

## Конфигурация и фильтрация

- **Шаблоны включения**: `FIXED_INCLUDE_PATTERNS` — фиксированный набор файлов, всегда включаемых в сканирование (например, `Dockerfile`, `*.tf`, `package.json`).
- **Шаблоны исключения**: `DEFAULT_EXCLUDE_PATTERNS` — стандартные пути, исключаемые по умолчанию (`.git`, `node_modules`, `.venv`, `__pycache__` и др.).
- Поддержка пользовательских правил из:
  - `.ai-docs.yaml` — основной конфигурационный файл (создаётся по умолчанию при отсутствии).
  - `.gitignore`, `.build_ignore` — обрабатываются через `pathspec`.
- **Расширения файлов**:
  - `code_extensions`, `doc_extensions`, `config_extensions` — пользовательские расширения с описанием типов файлов.
- **`exclude`** — пользовательские шаблоны исключений, дополняющие стандартные.

## Функции

- **`_clone_repo`** — клонирует удалённый Git-репозиторий во временную директорию для сканирования.
- **`scan_source`** — основная функция для анализа:
  - Принимает `source` (локальный путь или URL репозитория).
  - Автоматически определяет тип источника.
  - При необходимости клонирует репозиторий.
  - Загружает конфигурацию через `_load_extension_config`.
  - Рекурсивно сканирует файлы с помощью `_scan_directory`.
- **`_scan_directory`** — обходит файлы, применяя фильтры:
  - Проверка типа (текстовый/бинарный), размера (ограничение `max_size`, по умолчанию 200 КБ), симлинков.
  - Фильтрация по шаблонам включения/исключения.

## Результат

Возвращается объект `ScanResult` с полной информацией о проанализированных файлах, готовой к использованию в генерации документации.

Файл содержит функции для генерации и управления документацией на основе MkDocs. Основное назначение — запись файлов документации, очистка устаревших файлов, постобработка HTML-выхода и создание индекса поиска.  

Ключевые сущности:  
- `docs_files` — словарь с содержимым файлов документации, где ключ — путь, значение — текст.  
- `file_map`, `module_pages`, `config_pages` — структуры данных с информацией о модулях и конфигурациях.  
- `SECTION_TITLES`, `DOMAIN_TITLES` — отображения для заголовков разделов и доменов конфигураций.  

Основные функции:  
- `write_docs` — записывает файлы документации, добавляет Mermaid.js, очищает неиспользуемые файлы.  
- `write_readme` — создает или обновляет README.md.  
- `build_mkdocs` — генерирует `mkdocs.yml` и запускает сборку сайта документации.  
- `_postprocess_mermaid_html` — исправляет HTML-символы в диаграммах Mermaid.  
- `__serialize_index` — формирует JSON-индекс с метаданными, включая время генерации и правила ранжирования.  

Важные настройки:  
- Автоматическая очистка устаревших файлов по списку `keep_files`.  
- Поддержка локальной среды через `.venv/bin/mkdocs` или глобальный `mkdocs`.  
- Интеграция Mermaid.js для визуализации диаграмм.  
- Индексация документации с указанием приоритетов файлов для навигации.

# Резюме: Генерация технической документации

Файл отвечает за автоматическую генерацию и управление структурированной технической документации проекта с использованием LLM. Основные функции включают анализ кода, построение контекста, генерацию Markdown-файлов и поддержку многоязычности, кэширования и параллельной обработки.

## Ключевые возможности
- **Генерация документации**: создание `overview.md`, `index.md`, `testing.md`, `changes.md`, `dependencies.md`, `glossary.md` и секций по доменам.
- **Модульная и конфигурационная документация**: автоматическое создание страниц в поддиректориях `modules/` и `configs/` с пагинацией (по 100 элементов) и навигацией.
- **Иерархический контекст**: использование `build_hierarchical_context` для укладки в лимит токенов через иерархическое суммирование.
- **Поддержка Mermaid**: визуализация архитектуры в виде диаграмм.
- **Управление изменениями**: отслеживание добавленных, изменённых и удалённых файлов с кратким резюме.
- **Кэширование и производительность**: `llm_cache` для повторных запросов, параллельная обработка с `asyncio.Semaphore`.

## Ключевые сущности
- `docs_dir` — корневая директория вывода документации.
- `file_map` — метаданные файлов проекта.
- `all_summaries` — агрегированные сводки для контекста.
- `SECTION_TITLES`, `DOMAIN_TITLES` — отображение ключей в читаемые заголовки.
- `llm`, `llm_cache` — модель и кэш для генерации текста.

## Важные настройки
- `AI_DOCS_REGEN_ALL_THRESHOLD`, `input_budget` — управление перегенерацией и объёмом контекста.
- `language` — локализация документации.
- `force_sections` — принудительная регенерация секций.

## Особенности
- Условная перегенерация: только при отсутствии файла или флаге `force`.
- Автоматическая очистка устаревших файлов доменов.
- Поддержка навигации: «← Предыдущая / Следующая →».
- Специальная обработка тестов через `render_testing_section`.

## Результат
Набор актуальных, структурированных Markdown-файлов, готовых к публикации, с полным охватом архитектуры, конфигураций, изменений и глоссария проекта.

Скрипт `main.py` — точка входа для генерации документации (README и MkDocs) на основе исходных кодов или конфигураций. Поддерживает локальные директории и Git-репозитории по URL.  

**Назначение**: автоматическое создание документации с использованием LLM, включая анализ архитектуры, модулей, конфигураций и изменений.  

**Ключевые сущности**:  
- `scan_source` — сканирование файлов с фильтрацией по шаблонам (`--include`, `--exclude`) и ограничением размера (`--max-size`).  
- `from_env` — инициализация LLM на основе переменных окружения (например, `LLM_MODEL`, `LLM_API_KEY`).  
- `generate_docs` — основная логика генерации, кэширование ответов LLM, параллельная обработка.  

**Важные параметры командной строки**:  
- `--source` — обязательный путь или URL к исходникам.  
- `--readme`, `--mkdocs` — выбор типа генерируемой документации.  
- `--language` — язык документации (`ru` по умолчанию).  
- `--regen` — принудительная перегенерация указанных разделов (например, `architecture,configs`).  
- `--force` — перезапись существующего `README.md`.  
- `--no-cache` — отключение кэширования запросов к LLM.  
- `--threads` — количество параллельных запросов к модели.  
- `--local-site` — настройка MkDocs для локального запуска.  
- `--cache-dir` — директория кэша (по умолчанию `.ai_docs_cache` внутри `output_root`).  

**Переменные окружения**:  
- `AI_DOCS_THREADS` — количество потоков по умолчанию.  
- `AI_DOCS_LOCAL_SITE` — флаг для локальной конфигурации MkDocs.  
- `AI_DOCS_REGEN` — передаётся в `generate_docs` при использовании `--regen`.  

После обработки временные файлы (для URL-репозиториев) удаляются. Вывод размещается в `output_root`, который определяется автоматически, если не задан явно.

Класс `LLMClient` предоставляет асинхронный интерфейс для взаимодействия с моделью крупного языка (LLM) через OpenAI-совместимое API с поддержкой кэширования, повторных попыток и динамического таймаута. Основан на `AsyncOpenAI` и использует `httpx` для сетевых запросов.

**Ключевые сущности:**
- `LLMClient`: основной класс для отправки запросов к модели.
- `from_env`: фабричная функция, создающая клиент на основе переменных окружения.

**Параметры инициализации:**
- `api_key`: ключ API для аутентификации.
- `base_url`: базовый URL провайдера (опционально, для сторонних хостов).
- `model`: модель для генерации (например, `gpt-4o-mini`).
- `temperature`: параметр креативности генерации (по умолчанию 0.2).
- `max_tokens`: максимальное число токенов в ответе.
- `context_limit`: лимит контекстных токенов модели.

**Особенности:**
- Автоматическая оценка количества входных токенов через `count_tokens`.
- Динамический таймаут чтения (`_compute_read_timeout`) в зависимости от объема входных данных.
- Поддержка кэширования ответов по хешу входного `payload` (через `sha256_text`).
- Устойчивость к сбоям: повторные попытки при ошибках 408, 429, 5xx и таймаутах с экспоненциальной задержкой.
- Потокобезопасное кэширование с использованием `asyncio.Lock`.

**Переменные окружения (используются в `from_env`):**
- `OPENAI_API_KEY` — обязательный ключ API.
- `OPENAI_BASE_URL` — опциональный URL для переопределения эндпоинта.
- `OPENAI_MODEL` — модель (по умолчанию `gpt-4o-mini`).
- `OPENAI_TEMPERATURE` — температура (по умолчанию 0.2).
- `OPENAI_MAX_TOKENS` — максимальное число токенов в ответе (по умолчанию 1200).
- `OPENAI_CONTEXT_TOKENS` — лимит контекста (по умолчанию 8192).

Функция `chat` отправляет список сообщений и возвращает сгенерированный текст, при необходимости сохраняя результат в кэш.

# Резюме модуля обработки технической документации

## Назначение
Модуль предназначен для автоматизированной обработки, нормализации и генерации текстовых описаний конфигураций и модулей с целью интеграции в техническую документацию. Поддерживает форматирование в стиле Doxygen и конфигурационном стиле с использованием LLM и кэшированием.

## Основные функции
- **Проверка и нормализация формата текста** с учётом структурных требований.
- **Асинхронная обработка** больших файлов с разбиением на чанки по ограничению токенов.
- **Генерация резюме** с применением специализированных промптов в зависимости от типа файла (`config`, `infra` и др.) и режима (`detailed`).
- **Форматирование секций** с параметрами и ключами, включая обработку блоков кода и списков.
- **Сохранение результатов** в виде Markdown-файлов с безопасным именованием.

## Ключевые структуры
- `SUMMARY_PROMPT` — общий промпт для резюме.
- `MODULE_SUMMARY_PROMPT`, `MODULE_SUMMARY_REFORMAT_PROMPT` — для Doxygen-документации модулей.
- `CONFIG_SUMMARY_PROMPT`, `CONFIG_SUMMARY_REFORMAT_PROMPT` — для конфигурационных файлов.

## Вспомогательные функции
- `_needs_doxygen_fix` — проверка на несоответствие Doxygen-формату.
- `_normalize_module_summary` — нормализация описания модуля через LLM.
- `_normalize_config_summary` — нормализация конфигурационного описания.
- `_format_config_blocks` — форматирование секций с `<br>`.
- `_strip_fenced_markdown` — очистка от Markdown-блоков (```) и лишних пробелов.
- `summarize_file` — основная функция генерации резюме с кэшированием.
- `write_summary` — сохранение резюме в файл.

## Использование
Модуль автоматизирует документирование кодовой базы, обеспечивая единообразие и соответствие стандартам форматирования.

Модуль отвечает за генерацию конфигурационного файла `mkdocs.yml` и запись документации в файловую систему. Основная функция `build_mkdocs_yaml` формирует YAML-конфигурацию для MkDocs на основе входных параметров: названия сайта, структуры разделов, конфигурационных файлов и модулей. Динамически строится навигация (`nav`) с поддержкой вложенных разделов, включая архитектуру, запуск, зависимости, тестирование, соглашения, глоссарий, конфиги, модули и изменения. Поддерживается кастомизация навигации для конфигурации проекта и модулей через `_build_tree_nav`, которая преобразует список путей в древовидную структуру. В конфигурацию добавляются плагины (`search`, `mermaid2`) и расширения Markdown, включая поддержку Mermaid-диаграмм через `pymdownx.superfences`. Для локальных сайтов настраиваются `site_url` и `use_directory_urls`. Функция `write_docs_files` записывает сгенерированные файлы документации в указанную директорию, отслеживая прогресс. Используется кастомный YAML-дампер `_YamlSafeDumper` для корректного представления Python-объектов (например, `mermaid2.fence_mermaid`).

Основной модуль генерации документации с использованием LLM. Оркестрирует процесс анализа исходных файлов, кэширования, создания и обновления документации на основе изменений. Поддерживает асинхронную обработку, многопоточность и инкрементальное обновление.

Ключевые сущности:  
- `generate_docs` — синхронная точка входа, запускает асинхронный процесс через `asyncio`.  
- `_generate_docs_async` — основная логика: вычисление diff'а, суммаризация изменённых и отсутствующих файлов, построение структуры документации, запись результатов.  
- Интеграция с кэшем (`init_cache`, `save_cache_snapshot`) для оптимизации перегенерации.  
- Поддержка разных типов документации: модули, конфигурации, общие файлы.  

Важные настройки:  
- `use_cache` — включение/отключение кэширования.  
- `threads` — количество потоков для параллельной обработки.  
- `force` — принудительная перезапись README.  
- `write_readme_flag` — флаг генерации README.  
- `write_mkdocs` — флаг генерации конфигурации MkDocs.  
- `local_site` — режим локального сайта (влияет на структуру навигации).  
- `AI_DOCS_REGEN` — переменная окружения для указания секций, которые нужно перегенерировать принудительно.  

Результат:  
- Генерация документации в `output_root/.ai-docs`.  
- Создание `README.md` и `mkdocs.yml` (опционально).  
- Вывод отчётов об ошибках, если таковые возникли.

Модуль отвечает за управление кэшированием, сравнение файлов и сопровождение промежуточных результатов (например, аннотаций и сводок) в процессе генерации документации. Основные функции включают инициализацию кэша, построение карты файлов с метаданными, выявление изменений, сохранение снимков состояния, а также очистку устаревших или неиспользуемых файлов сводок.

Ключевые сущности:  
- `CacheManager` — управляет хранением и загрузкой кэша (LLM-ответов и индекса файлов).  
- `file_map` — словарь с хешами, размерами, типами и содержимым файлов, построенный на основе входных данных.  
- Промежуточные директории: `files`, `modules`, `configs` — хранят сгенерированные сводки по категориям.

Важные функции:  
- `init_cache` — инициализирует кэш и загружает предыдущее состояние, если кэширование включено.  
- `build_file_map` — создаёт карту файлов с хешами содержимого (через `sha256_text`) для отслеживания изменений.  
- `diff_files` — определяет, какие файлы изменились, добавлены или удалены, на основе сравнения хешей.  
- `save_cache_snapshot` — сохраняет обновлённый индекс файлов и кэш LLM, исключая содержимое файлов из индекса.  
- `carry_unchanged_summaries` — переносит пути к существующим сводкам для неизменённых файлов, чтобы избежать повторной обработки.  
- `cleanup_orphan_summaries` и `cleanup_deleted_summaries` — удаляют сводки, которые больше не связаны с актуальными файлами, с пошаговым логированием процесса.

Параметры:  
- `cache_dir` — корневая директория для кэша.  
- `use_cache` — флаг, включающий использование кэша LLM и индексации.  
- `is_test_path` — утилита для фильтрации тестовых файлов (не требуют модульных сводок).  

Модуль обеспечивает эффективную инкрементальную обработку, минимизируя избыточные вычисления и поддерживая чистоту промежуточных данных.

# Резюме документации

Данный документ представляет собой обобщённое описание системы, её компонентов, функциональных возможностей и принципов работы. Система предназначена для эффективного управления данными и обеспечения взаимодействия между различными модулями через чётко определённые интерфейсы. Включает в себя описание архитектуры, основных процессов, требований к окружению и инструкции по развертыванию. Документация ориентирована на разработчиков, администраторов и технических специалистов, обеспечивая полное понимание системы и поддержку её эксплуатации.

Модуль предоставляет инструменты для подсчёта токенов и разбиения текста на части с учётом ограничений по токенам, в зависимости от модели. Использует `tiktoken` для корректного токенизации моделей OpenAI, а при отсутствии поддержки — резервное побайтовое кодирование. Основные функции: `get_encoding` возвращает токенизатор для указанной модели, `count_tokens` подсчитывает количество токенов в тексте, `chunk_text` разделяет текст на фрагменты заданного максимального размера в токенах. Ключевая настройка — параметр `max_tokens` в `chunk_text`, определяющий длину каждого фрагмента. В случае недоступности `tiktoken` используется внутренний класс `_ByteEncoding`, кодирующий текст как UTF-8 байты.

Функция формирует Markdown-отчёт об изменениях, внесённых в проект после генерации файлов. Отчёт включает списки добавленных, изменённых и удалённых файлов, перечень перегенерированных разделов и краткое резюме. Основные параметры: `added`, `modified`, `deleted` — словари с путями файлов; `regenerated_sections` — список названий разделов, подвергшихся перегенерации; `summary` — текст итогового описания изменений. Результат возвращается в виде строки в формате Markdown.

Файл содержит вспомогательные функции для анализа структуры проекта и генерации документации. Основное назначение — сбор информации о тестах, зависимостях, конфигурационных файлах и навигации по документации.  

Ключевые сущности:  
- `SECTION_TITLES`, `DOMAIN_TITLES` — отображение внутренних ключей в читаемые заголовки разделов и доменов.  
- `is_test_path` — определяет, является ли путь тестовым по имени или расположению.  
- `collect_dependencies` — извлекает зависимости из `pyproject.toml`, `requirements.txt`, `package.json`.  
- `collect_test_info` — находит тестовые файлы и команды для запуска тестов (например, `pytest`, `npm test`).  
- `render_testing_section` — формирует Markdown-описание тестов и способов их запуска.  
- `render_project_configs_index` — генерирует оглавление для конфигурационных файлов.  
- `strip_duplicate_heading`, `first_paragraph` — утилиты для обработки текста документации.  
- `build_docs_index` — строит иерархию разделов, модулей и конфигураций для навигации в документации.  

Важные настройки и поведение:  
- Поддержка нескольких форматов конфигураций: TOML, JSON, текстовые файлы.  
- Автоматическое определение тестовых файлов по имени и пути.  
- Формирование структуры документации на основе наличия файлов в `docs/` и метаданных из `file_map`.  
- Генерация кратких описаний модулей и конфигураций на основе первого абзаца из соответствующих `.md`-файлов.

Вспомогательные утилиты для работы с файлами, хеширования и путей. Основные функции: вычисление SHA-256 хеша от байтов и строк, безопасное чтение текстовых файлов с кодировкой UTF-8, проверка, является ли файл бинарным (по наличию нулевых байтов), определение URL по префиксу, нормализация путей в POSIX-формат и создание slug-идентификаторов из строк. Также включает функцию `ensure_dir` для создания директорий с проверкой существования. Используется для подготовки и валидации файловой структуры, безопасной обработки путей и определения типов источников (локальные файлы или URL).

Словари с описаниями расширений файлов и наборы ключевых имён/путей для классификации файлов в проекте. Определяет тип файла (код, конфигурация, документация и др.) и домены инфраструктуры (Kubernetes, Terraform, Docker и др.) на основе расширения, имени и пути. Используется для анализа структуры проекта. Основные сущности: `CODE_EXTENSIONS`, `CONFIG_EXTENSIONS`, `CI_FILENAMES`, `DOCKER_FILENAMES`, `TERRAFORM_EXTENSIONS`, `classify_type`, `detect_domains`. Ключевые параметры — расширения файлов и пути, ассоциированные с инфраструктурными технологиями.

Модуль обеспечивает запуск основного CLI-интерфейса приложения `ai_docs`. Реализует гибкую загрузку функции `main` из модуля `cli`, поддерживая как импорт в рамках пакета, так и запуск скрипта напрямую. В случае, если импорт через относительный путь не удается, автоматически добавляет родительский каталог в `sys.path` для корректного импорта. Основная логика запускается при выполнении файла как скрипта через `if __name__ == "__main__"`, что делает возможным использование команды `python ai_docs/cli.py` из терминала. Ключевая сущность — функция `main`, отвечающая за обработку аргументов командной строки и выполнение действий.

Класс `CacheManager` предназначен для управления кэшем в файловой системе, включая хранение индекса файлов и кэша ответов LLM. Работает с двумя основными файлами: `index.json` — для отслеживания состояния файлов (хэши, метаданные), и `llm_cache.json` — для хранения закэшированных текстовых ответов по ключам. При инициализации создает директорию кэша, если её нет. Метод `load_index` возвращает индекс файлов, инициализируя пустую структуру при отсутствии файла. Метод `save_index` записывает индекс с форматированием. Метод `load_llm_cache` безопасно загружает кэш LLM, обрабатывает пустые и битые JSON-файлы, сохраняя повреждённые данные в резервный файл с суффиксом `.bad`. Метод `save_llm_cache` сохраняет кэш, делая снимок данных. Метод `diff_files` сравнивает текущие метаданные файлов с сохранёнными и возвращает четыре словаря: добавленные, изменённые, удалённые и неизменные файлы — на основе сравнения хэшей. Используется для оптимизации обработки документов при повторных запусках.

Тестовый модуль для проверки функциональности сканера исходного кода из пакета `ai_docs.scanner`. Основное назначение — верификация корректной обработки файлов в директории, включая учёт правил игнорирования. Ключевая функция — `scan_source`, которая анализирует указанную директорию и возвращает список файлов, исключая игнорируемые (например, по правилам `.gitignore` и стандартным шаблонам вроде виртуальных окружений). В тесте `test_scan_local_dir` создаётся временная структура файлов, включая `app.py`, `Dockerfile`, `.gitignore` и файл в виртуальном окружении. Проверяется, что сканируются только ожидаемые файлы, а игнорируемые (например, `ignored.txt` и файлы из `.venv`) исключаются из результата.

# Резюме документации

Данный документ представляет собой обобщённое описание системы, её компонентов, функциональных возможностей и принципов работы. Система предназначена для эффективного управления данными и обеспечения взаимодействия между различными модулями через чётко определённые интерфейсы. Включает в себя описание архитектуры, основных процессов, требований к окружению и инструкции по развертыванию. Документация ориентирована на разработчиков, администраторов и технических специалистов, обеспечивая полное понимание системы и поддержку её эксплуатации.

Назначение файла — тестирование функциональности класса `CacheManager`, отвечающего за управление кэшем файлов, включая отслеживание изменений, добавление, удаление и определение неизменённых файлов. Основная сущность — класс `CacheManager`, работающий с индексом кэша, хранящим хэши файлов. Тесты проверяют метод `diff_files`, который сравнивает переданный список файлов с сохранённым состоянием и возвращает четыре категории: добавленные, изменённые, удалённые и неизменённые файлы. Важные аспекты: временная директория для изоляции тестов, последовательное обновление индекса через `save_index` и проверка корректности определения статусов файлов при изменении состояния. Тесты охватывают сценарии первого запуска, изменения хэшей, добавления и удаления файлов.

Файл содержит модульные тесты для функции `format_changes_md`, формирующей Markdown-представление изменений в документации. Основное назначение — проверка корректности генерации разделов по добавленным, изменённым, удалённым файлам и перегенерированным разделам. В тесте участвуют словари `added`, `modified`, `deleted` и список `regenerated`, а также параметр `summary`. Проверяется наличие ключевых заголовков и упоминание имён файлов и разделов в выходной Markdown-строке. Тест убеждается, что все компоненты правильно отображаются в итоговом тексте.

Помогает в разработке и рефакторинге кода, используя предварительно сгенерированную документацию в каталоге `.ai-docs`. Назначение — быстрая ориентация в структуре проекта, модулях, архитектуре и соглашениях без прямого анализа исходного кода на первом этапе.

Ключевые сущности:  
- Каталог `.ai-docs` — основной источник информации.  
- Файл `_index.json` — навигационный индекс для определения приоритетных модулей.  
- Основные документы: `index.md`, `architecture.md`, `conventions.md`, `dependencies.md`, модульные описания в `modules/`.  

Важные настройки и правила:  
- При отсутствии `.ai-docs` — возвращать сообщение о необходимости предварительной генерации документации.  
- Классифицировать запросы (обзор, рефакторинг, уточнение) и выбирать соответствующие разделы.  
- Использовать приоритеты и ранжирование из `_index.json` для фильтрации релевантных модулей.  
- Опор на `.md`-файлы для формирования контекста; переход к исходному коду — только после локализации нужного компонента через документацию.  
- Ответ формируется на языке запроса пользователя.  
- Не предлагать обновление или перегенерацию документации.  

Результат включает краткий вывод, ссылки на задействованные файлы `.ai-docs` и, при необходимости, план действий с привязкой к разделам документации.
