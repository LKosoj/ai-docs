# Модули

```markdown
# Модули

## Сканирование файловой системы и репозиториев

Модуль отвечает за сканирование локальных директорий или удалённых Git-репозиториев с целью анализа структуры проекта. Поддерживает фильтрацию файлов по шаблонам включения/исключения, задаваемым явно или через конфигурацию. Результат — объект `ScanResult`, содержащий информацию о файлах и метаданные источника.

### Ключевые структуры данных

#### `ScanResult`
Результат сканирования исходного кода.

**Поля:**
- `root` — абсолютный путь к корню сканированного каталога.
- `files` — список словарей с информацией о каждом файле (путь, размер, тип и т.д.).
- `source` — исходная строка (путь или URL), переданная в `scan_source`.
- `repo_name` — имя репозитория, извлечённое из URL или пути.

---

### Основные функции

#### `_normalize_extensions(raw, defaults)`
Нормализует пользовательские расширения из конфигурации: добавляет точки к расширениям и заполняет описания по умолчанию.

**Аргументы:**
- `raw` — словарь или список пользовательских расширений.
- `defaults` — словарь описаний по умолчанию.

**Возвращает:**  
Словарь вида `{".py": "Python source"}`.

---

#### `_normalize_excludes(raw)`
Преобразует входной список строк в множество очищенных паттернов исключения (удаляет пробелы, пропускает пустые).

**Аргументы:**
- `raw` — список строк с паттернами исключения.

**Возвращает:**  
`set` очищенных строк.

---

#### `_load_extension_config(root)`
Загружает конфигурацию из `.ai-docs.yaml` в корне проекта. Если файл отсутствует — возвращает значения по умолчанию.

**Аргументы:**
- `root` — корневой путь проекта.

**Возвращает:**  
Словарь с ключами:
- `code_extensions`, `doc_extensions`, `config_extensions` — словари расширений с описаниями.
- `exclude` — множество паттернов исключения.

---

#### `_build_default_include_patterns(extension_config)`
Формирует набор паттернов включения на основе расширений из конфигурации и фиксированных правил (например, `README.*`, `pyproject.toml`).

**Аргументы:**
- `extension_config` — результат `_load_extension_config`.

**Возвращает:**  
Множество строк, например: `{"*.py", "*.md", "README.*"}`.

---

#### `_load_ignore_specs(root)`
Загружает правила игнорирования из `.gitignore` и `.build_ignore`.

**Аргументы:**
- `root` — корневой путь проекта.

**Возвращает:**  
Список объектов `pathspec.PathSpec`.

---

#### `_should_include(rel_path, include, exclude, ignore_specs)`
Проверяет, должен ли файл быть включён в результат.

**Аргументы:**
- `rel_path` — относительный путь в формате POSIX.
- `include` — множество паттернов включения (или `None`).
- `exclude` — множество паттернов исключения (или `None`).
- `ignore_specs` — список `PathSpec`.

**Возвращает:**  
`True`, если файл проходит все фильтры.

---

#### `_scan_directory(root, include, exclude, max_size)`
Рекурсивно сканирует директорию, применяя фильтры и ограничение по размеру.

**Аргументы:**
- `root` — корневой путь.
- `include`, `exclude` — паттерны.
- `max_size` — максимальный размер файла в байтах (по умолчанию 200 КБ).

**Возвращает:**  
Список словарей с полями: `path`, `size`, `type`, `domains`.

---

#### `_clone_repo(repo_url)`
Клонирует Git-репозиторий во временный каталог.

**Аргументы:**
- `repo_url` — URL репозитория.

**Возвращает:**  
Кортеж `(temp_dir_path, repo_name)`.

**Исключения:**
- `RuntimeError` — при ошибке клонирования.

---

#### `scan_source(source, include=None, exclude=None, max_size=200_000)`
Сканирует локальную директорию или URL репозитория.

**Аргументы:**
- `source` — путь или URL.
- `include` — дополнительные паттерны включения.
- `exclude` — дополнительные паттерны исключения (объединяются с конфигурацией).
- `max_size` — лимит размера файла.

**Возвращает:**  
`ScanResult`.

**Исключения:**
- `FileNotFoundError` — если локальный путь не существует.
- `RuntimeError` — при ошибке клонирования.

---

## Генерация документации

Модуль обрабатывает файлы, генерирует описания с помощью LLM и формирует документацию в формате Markdown и MkDocs.

### Ключевые функции

#### `summarize_file(content, file_type, domains, llm_client, llm_cache, model, detailed=False)`
Генерирует краткое или детализированное описание файла.

**Аргументы:**
- `content` — содержимое файла.
- `file_type` — тип (например, `"code"`, `"infra"`).
- `domains` — домены (например, `["kubernetes", "ci"]`).
- `llm_client` — клиент для вызова LLM.
- `llm_cache` — словарь кэша запросов.
- `model` — модель для подсчёта токенов.
- `detailed` — использовать ли формат Doxygen.

**Возвращает:**  
Строка с описанием в Markdown.

---

#### `write_summary(summary_dir, rel_path, summary)`
Сохраняет резюме файла в указанной директории, сохраняя структуру путей.

**Аргументы:**
- `summary_dir` — корневая директория для сохранения.
- `rel_path` — относительный путь исходного файла.
- `summary` — текст резюме.

**Возвращает:**  
Путь к созданному файлу.

---

#### `_normalize_module_summary(summary, llm_client, llm_cache)`
Приводит текст к строгому Doxygen-формату, если обнаружены отклонения.

**Аргументы:**
- `summary` — исходный текст.
- `llm_client`, `llm_cache` — для повторного запроса к LLM.

**Возвращает:**  
Отформатированный текст.

---

#### `_needs_doxygen_fix(text)`
Проверяет, содержит ли текст признаки несоответствия Doxygen (например, отсутствие `@brief`).

**Возвращает:**  
`True`, если требуется переформатирование.

---

#### `_strip_fenced_markdown(text)`
Удаляет окружающие маркеры ```` ``` ```` из строки, если они есть.

**Возвращает:**  
Очищенный текст.

---

## Утилиты

### Работа с путями и файлами

#### `read_text_file(path)`
Читает текстовый файл в кодировке UTF-8.

**Исключения:**  
`OSError` — при ошибках доступа.

---

#### `is_binary_file(path, sample_size=2048)`
Проверяет, содержит ли файл нулевые байты в первых `sample_size` байтах.

**Возвращает:**  
`True`, если файл, вероятно, бинарный.

---

#### `is_url(value)`
Проверяет, начинается ли строка с `http://`, `https://` или `git@`.

**Возвращает:**  
`True`, если строка — URL.

---

#### `to_posix(path)`
Преобразует `Path` в строку с `/` в качестве разделителя.

**Возвращает:**  
POSIX-совместимый путь.

---

#### `safe_slug(path)`
Заменяет все неалфавитно-цифровые символы на `_`.

**Пример:**  
`"my/file.py"` → `"my_file_py"`.

---

#### `ensure_dir(path)`
Создаёт директорию и все родительские, если они отсутствуют.

**Исключения:**  
`OSError` — при ошибках создания.

---

### Хеширование

#### `sha256_bytes(data)`
**Аргументы:**  
`data` — байты.

**Возвращает:**  
HEX-строка хеша SHA-256.

---

#### `sha256_text(text)`
**Аргументы:**  
`text` — строка.

**Возвращает:**  
HEX-строка хеша SHA-256 от UTF-8 представления.

---

## Классификация файлов

### `classify_type(path)`
Определяет тип файла по расширению или имени.

**Возвращает:**  
Одно из: `"code"`, `"docs"`, `"config"`, `"data"`, `"ci"`, `"infra"`, `"other"`.

---

### `detect_domains(path, content_snippet)`
Анализирует путь и фрагмент содержимого для определения доменов.

**Возвращает:**  
`set` доменов, например: `{"kubernetes", "docker"}`.

---

### `is_infra(domains)`
Проверяет, содержит ли множество доменов инфраструктурные (например, `kubernetes`, `terraform`).

**Возвращает:**  
`True`, если хотя бы один домен — инфраструктурный.

---

## Кэширование

### `CacheManager`
Менеджер кэша для хранения индекса файлов и ответов LLM.

**Поля:**
- `cache_dir` — директория хранения.
- `index_path` — путь к `index.json`.
- `llm_cache_path` — путь к `llm_cache.json`.

**Методы:**
- `__init__(cache_dir)` — создаёт директорию и файлы при необходимости.
- `load_index()` — загружает индекс; при отсутствии — возвращает `{}`.
- `save_index(data)` — сохраняет индекс.
- `load_llm_cache()` — загружает кэш LLM; при отсутствии — возвращает `{}`.
- `save_llm_cache(data)` — сохраняет кэш.
- `diff_files(current_files)` — сравнивает текущие файлы с предыдущим состоянием.

**Возвращает:**  
Кортеж из четырёх словарей: `(added, modified, deleted, unchanged)`.

---

## Поддержка MkDocs

### `build_mkdocs_yaml(site_name, sections, configs, local_site=False, has_modules=False, module_nav_paths=None)`
Генерирует содержимое `mkdocs.yml`.

**Аргументы:**
- `site_name` — название сайта.
- `sections` — разделы документации (название → путь).
- `configs` — конфигурационные файлы (например, Helm, Kubernetes).
- `local_site` — отключает `site_url` и `repo_url`.
- `has_modules`, `module_nav_paths` — для включения навигации по модулям.

**Возвращает:**  
Строка в формате YAML.

---

### `_build_modules_nav(module_paths)`
Строит иерархическую навигацию по модулям на основе списка путей.

**Возвращает:**  
Список словарей для вставки в `nav`.

---

### `write_docs_files(docs_dir, files)`
Записывает файлы в указанную директорию.

**Аргументы:**
- `docs_dir` — корневая директория.
- `files` — словарь: `относительный_путь → содержимое`.

---

## Токенизация

### `count_tokens(text, model)`
Подсчитывает токены в тексте с использованием кодировки модели.

**Использует:** `tiktoken`.

**Возвращает:**  
Целое число — количество токенов.

---

### `chunk_text(text, model, max_tokens)`
Разбивает текст на фрагменты, каждый не более `max_tokens`.

**Возвращает:**  
Список строк.

---

## LLM-клиент

### `LLMClient`
Клиент для взаимодействия с LLM через OpenAI-совместимый API.

**Поля:**
- `api_key`, `base_url`, `model`
- `temperature`, `max_tokens`, `context_limit`

**Методы:**
- `__init__()` — инициализация.
- `_cache_key(payload)` — генерирует SHA256 от JSON-тела запроса.
- `chat(messages, cache=None)` — отправляет запрос, использует кэш при наличии.
- `from_env()` — создаёт клиент из переменных окружения (`OPENAI_API_KEY`, `LLM_MODEL` и др.).

**Исключения:**
- `RuntimeError` — если `OPENAI_API_KEY` не задан или ответ API некорректен.
```

## Список модулей

- [modules/ai_docs/__init__](ai_docs/__init__.md)
- [modules/ai_docs/__main__](ai_docs/__main__.md)
- [modules/ai_docs/cache](ai_docs/cache.md)
- [modules/ai_docs/changes](ai_docs/changes.md)
- [modules/ai_docs/cli](ai_docs/cli.md)
- [modules/ai_docs/domain](ai_docs/domain.md)
- [modules/ai_docs/generator](ai_docs/generator.md)
- [modules/ai_docs/llm](ai_docs/llm.md)
- [modules/ai_docs/mkdocs](ai_docs/mkdocs.md)
- [modules/ai_docs/scanner](ai_docs/scanner.md)
- [modules/ai_docs/summary](ai_docs/summary.md)
- [modules/ai_docs/tokenizer](ai_docs/tokenizer.md)
- [modules/ai_docs/utils](ai_docs/utils.md)
