# ai_docs/generator

Модуль отвечает за генерацию технической документации проекта на основе анализа файлов в репозитории. Он собирает информацию о зависимостях, тестах, архитектуре и других аспектах, формирует контекст и передаёт его в LLM для создания структурированных разделов документации. Поддерживает многоязычность, кэширование запросов к модели, разбиение больших текстов на чанки и интеграцию с MkDocs. Результат — полноценная документация в формате Markdown, включая README и навигацию.

Ключевые структуры данных  
SECTION_TITLES — Словарь соответствия английских ключей разделов и их локализованных заголовков  
DOMAIN_TITLES — Словарь отображения доменов (например, kubernetes) в читаемые названия для документации

---
def _is_test_path(path: str) -> bool  
Проверяет, является ли путь тестовым по имени или расположению.  
Аргументы  
path — путь к файлу для проверки  
Возвращает  
True, если путь соответствует шаблонам тестовых файлов или директорий

---
def _collect_dependencies(files: Dict[str, Dict]) -> List[str]  
Извлекает список зависимостей из файлов pyproject.toml, requirements.txt и package.json.  
Аргументы  
files — словарь файлов проекта с метаданными, включая содержимое  
Возвращает  
Отсортированный список уникальных строк с зависимостями в формате "имя версия"

---
def _collect_test_info(files: Dict[str, Dict]) -> Tuple[List[str], List[str]]  
Собирает информацию о тестовых файлах и командах для их запуска.  
Аргументы  
files — словарь файлов проекта с метаданными  
Возвращает  
Кортеж из двух списков: путей к тестам и команд для запуска тестов

---
def _render_testing_section(test_paths: List[str], commands: List[str]) -> str  
Формирует Markdown-секцию с информацией о тестах.  
Аргументы  
test_paths — список путей к тестовым файлам  
commands — список команд для запуска тестов  
Возвращает  
Строка в формате Markdown с разделами "Найденные тесты" и "Как запускать"

---
def _generate_section(llm: LLMClient, llm_cache: Dict[str, str], title: str, context: str, language: str) -> str  
Генерирует содержимое одного раздела документации с помощью LLM.  
Аргументы  
llm — клиент для взаимодействия с языковой моделью  
llm_cache — кэш для хранения результатов запросов  
title — заголовок генерируемого раздела  
context — контекст, передаваемый модели  
language — язык, на котором должна быть сгенерирована документация  
Возвращает  
Содержимое раздела в формате Markdown без дублирующего заголовка

---
def _strip_duplicate_heading(content: str, title: str) -> str  
Удаляет первый заголовок из текста, если он дублирует указанный заголовок раздела.  
Аргументы  
content — исходный текст с потенциальным заголовком  
title — ожидаемый заголовок раздела  
Возвращает  
Текст без дублирующего заголовка

---
def _generate_readme(llm: LLMClient, llm_cache: Dict[str, str], project_name: str, overview_context: str, language: str) -> str  
Генерирует краткий README.md для проекта с обзором и ссылками.  
Аргументы  
llm — клиент языковой модели  
llm_cache — кэш ответов модели  
project_name — название проекта  
overview_context — общий контекст проекта для генерации  
language — язык документации  
Возвращает  
Сгенерированный README в формате Markdown

---
def _truncate_context(context: str, model: str, max_tokens: int) -> str  
Обрезает контекст до указанного лимита токенов, если он превышает допустимый размер.  
Аргументы  
context — исходный текст контекста  
model — название модели для подсчёта токенов  
max_tokens — максимальное количество токенов  
Возвращает  
Обрезанный или исходный контекст, укладывающийся в лимит

---
def _first_paragraph(text: str) -> str  
Извлекает первый абзац текста, пропуская заголовки и пустые строки.  
Аргументы  
text — входной текст  
Возвращает  
Первый непустой абзац, объединённый в одну строку

---
def _build_docs_index(output_root: Path, docs_dir: Path, docs_files: Dict[str, str], file_map: Dict[str, Dict], module_pages: Dict[str, str]) -> Dict[str, object]  
Формирует структуру навигации (index) для документации в формате, совместимом с MkDocs.  
Аргументы  
output_root — корневая директория вывода  
docs_dir — директория с файлами документации  
docs_files — словарь имён и содержимого сгенерированных файлов документации  
file_map — карта файлов проекта с метаданными  
module_pages — соответствие модулей и путей к страницам документации  
Возвращает  
Словарь, описывающий иерархию разделов документации для использования в mkdocs.yml

---
def generate_docs(files: List[Dict], output_root: Path, cache_dir: Path, llm: LLMClient, language: str, write_readme: bool, write_mkdocs: bool, use_cache: bool = True, threads: int = 1, local_site: bool = False, force: bool = False) -> None  
Генерирует документацию на основе переданных файлов, используя LLM и кэширование.  
Аргументы  
files — список файлов с метаданными (путь, содержимое, тип и др.)  
output_root — корневая директория для вывода сгенерированных документов  
cache_dir — директория для хранения кэша (промежуточных результатов и индекса)  
llm — клиент языковой модели для генерации сводок  
language — язык документации (например, "en", "ru")  
write_readme — флаг, указывающий, нужно ли генерировать README.md  
write_mkdocs — флаг, указывающий, нужно ли генерировать конфигурацию MkDocs  
use_cache — использовать кэш для ускорения обработки неизменённых файлов (по умолчанию True)  
threads — количество потоков для параллельной обработки (по умолчанию 1)  
local_site — флаг для локальной генерации сайта (без публикации)  
force — принудительная перегенерация всех файлов, игнорируя кэш (по умолчанию False)  
Исключения  
Может выбрасывать исключения при ошибках чтения/записи файлов, сбоях LLM или проблемах с кэшем

---
def _save_cache_snapshot() -> None  
Сохраняет снимок текущего состояния файлов и секций в индекс кэша.  
Исключения  
IOError — при ошибках записи в файл кэша

---
class CacheManager  
Управляет кэшированием промежуточных данных и индекса документации.  
Поля  
cache_dir — путь к директории кэша  
Методы  
__init__(cache_dir: Path) — инициализирует менеджер кэша с указанной директорией  
load_index() — загружает индекс предыдущей генерации из кэша  
save_index(data: Dict) — сохраняет индекс текущей генерации  
load_llm_cache() — загружает кэш ответов LLM  
save_llm_cache(cache: Dict) — сохраняет кэш ответов LLM  
diff_files(current_files: Dict[str, Dict]) — вычисляет разницу между текущими файлами и кэшированными (added, modified, deleted, unchanged)
