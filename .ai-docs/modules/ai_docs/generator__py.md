# ai_docs/generator

Модуль отвечает за генерацию технической документации на основе анализа исходного кода и конфигурационных файлов проекта. Использует LLM для создания структурированных разделов документации, таких как архитектура, зависимости и соглашения. Поддерживает многоязычность, кэширование запросов к модели и интеграцию с MkDocs для построения документационного сайта. Результат включает README, разделённые по темам документы и индекс для навигации.

Ключевые структуры данных  
SECTION_TITLES — Словарь соответствия внутренних ключей разделов и их локализованных заголовков.  
DOMAIN_TITLES — Словарь отображения доменов (например, kubernetes) в читаемые названия для документации.

generate_docs(files: List[Dict], output_root: Path, cache_dir: Path, llm: LLMClient, language: str, write: bool = True) -> Dict[str, str]  
Генерирует полный набор документации по проекту на основе переданных файлов.  
Аргументы  
files — Список словарей с метаданными файлов (путь, содержимое, хеш и др.).  
output_root — Корневая директория для вывода сгенерированных документов.  
cache_dir — Директория для хранения кэша LLM-запросов.  
llm — Клиент языковой модели для генерации текста.  
language — Язык документации (например, "ru", "en").  
write — Флаг: записывать ли результат на диск (по умолчанию True).  
Возвращает  
Словарь с путями сгенерированных файлов в формате {относительный_путь: содержимое}.  
Исключения  
Не выбрасывает явных исключений, но может подавлять ошибки при чтении/парсинге отдельных файлов.

---
_is_test_path(path: str) -> bool  
Определяет, является ли путь тестовым (по имени директории или файла).  
Аргументы  
path — Путь к файлу в виде строки.  
Возвращает  
True, если путь соответствует шаблонам тестов (папки tests, файлы test_*, *_test.py), иначе False.

---
_collect_dependencies(files: Dict[str, Dict]) -> List[str]  
Извлекает список зависимостей из pyproject.toml, requirements.txt и package.json.  
Аргументы  
files — Словарь файлов проекта с ключами по пути и полями content.  
Возвращает  
Отсортированный список уникальных строк зависимостей в формате "имя версия".

---
_generate_section(llm: LLMClient, llm_cache: Dict[str, str], title: str, context: str, language: str) -> str  
Генерирует один раздел документации с помощью LLM, включая Mermaid-диаграмму для архитектуры.  
Аргументы  
llm — Клиент языковой модели.  
llm_cache — Кэш для хранения результатов предыдущих запросов.  
title — Заголовок раздела (например, "Архитектура").  
context — Контекстные данные (суммаризация кода, зависимости и т.п.).  
language — Язык вывода.  
Возвращает  
Сгенерированный Markdown-контент раздела без дублирующего заголовка.

---
_strip_duplicate_heading(content: str, title: str) -> str  
Удаляет первый заголовок из текста, если он дублирует указанный заголовок раздела.  
Аргументы  
content — Входной Markdown-текст.  
title — Ожидаемый заголовок раздела.  
Возвращает  
Текст без дублирующего заголовка, если он был первым элементом.

---
_generate_readme(llm: LLMClient, llm_cache: Dict[str, str], project_name: str, overview_context: str, language: str) -> str  
Генерирует краткий README.md с обзором, быстрым стартом и ссылками.  
Аргументы  
llm — Клиент языковой модели.  
llm_cache — Кэш LLM-ответов.  
project_name — Название проекта.  
overview_context — Контекст для генерации обзора.  
language — Язык документации.  
Возвращает  
Сгенерированный Markdown-текст README.

---
_truncate_context(context: str, model: str, max_tokens: int) -> str  
Обрезает контекст до указанного лимита токенов, если он превышает лимит.  
Аргументы  
context — Входной текст.  
model — Название модели для подсчёта токенов.  
max_tokens — Максимальное количество токенов.  
Возвращает  
Обрезанный текст (первый чанк), если превышает лимит, иначе исходный.

---
_first_paragraph(text: str) -> str  
Извлекает первый абзац текста, пропуская заголовки и код.  
Аргументы  
text — Входной текст (обычно Markdown).  
Возвращает  
Первый непустой абзац без заголовков и блоков кода, объединённый в одну строку.

---
_build_docs_index(output_root: Path, docs_dir: Path, docs_files: Dict[str, str], file_map: Dict[str, Dict], module_pages: Dict[str, str]) -> Dict[str, object]  
Формирует JSON-индекс документации с метаданными, разделами и модулями.  
Аргументы  
output_root — Корневая директория вывода.  
docs_dir — Директория с документацией.  
docs_files — Словарь сгенерированных файлов документации.  
file_map — Карта файлов проекта с метаданными.  
module_pages — Сопоставление путей модулей и путей к их страницам.  
Возвращает  
Словарь с полями generated_at, docs_dir, rules, sections, modules, files — используется как _index.json.
