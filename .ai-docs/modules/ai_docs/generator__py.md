# ai_docs/generator

Модуль отвечает за генерацию технической документации проекта на основе анализа исходных файлов с использованием LLM. Собирает контекст, разбивает его на разделы, генерирует Markdown-документы, включая архитектуру, зависимости и модули. Поддерживает кэширование, многопоточную обработку и интеграцию с MkDocs. Результат — структурированная документация в формате, пригодном для публикации.

Ключевые структуры данных  
SECTION_TITLES — Словарь соответствия внутренних ключей разделов и их локализованных заголовков  
DOMAIN_TITLES — Словарь отображения доменов (например, kubernetes) в читаемые названия

---
def _is_test_path(path: str) -> bool  
Проверяет, является ли путь тестовым (по имени папки или файла)  
Аргументы  
path — Путь к файлу или директории  
Возвращает  
True, если путь соответствует шаблону тестового файла или директории

---
def _collect_dependencies(files: Dict[str, Dict]) -> List[str]  
Собирает список зависимостей из pyproject.toml, requirements.txt и package.json  
Аргументы  
files — Словарь файлов с метаданными, включая содержимое  
Возвращает  
Отсортированный список уникальных строк зависимостей в формате "имя версия"

---
def _generate_section(llm: LLMClient, llm_cache: Dict[str, str], title: str, context: str, language: str) -> str  
Генерирует содержимое одного раздела документации с помощью LLM  
Аргументы  
llm — Клиент для взаимодействия с языковой моделью  
llm_cache — Кэш для ответов LLM  
title — Заголовок раздела  
context — Контекст для генерации  
language — Язык вывода  
Возвращает  
Сгенерированный Markdown-контент раздела без дублирующего заголовка

---
def _strip_duplicate_heading(content: str, title: str) -> str  
Удаляет первый заголовок из текста, если он дублирует указанный заголовок раздела  
Аргументы  
content — Входной текст  
title — Ожидаемый заголовок  
Возвращает  
Текст без дублирующего заголовка

---
def _generate_readme(llm: LLMClient, llm_cache: Dict[str, str], project_name: str, overview_context: str, language: str) -> str  
Генерирует краткий README.md на основе общего контекста проекта  
Аргументы  
llm — Клиент LLM  
llm_cache — Кэш LLM  
project_name — Название проекта  
overview_context — Общий контекст проекта  
language — Язык документации  
Возвращает  
Сгенерированный Markdown-текст README

---
def _truncate_context(context: str, model: str, max_tokens: int) -> str  
Обрезает контекст до указанного лимита токенов, если он превышает лимит  
Аргументы  
context — Исходный текст  
model — Название модели для подсчёта токенов  
max_tokens — Максимальное количество токенов  
Возвращает  
Обрезанный или исходный текст, укладывающийся в лимит

---
def _first_paragraph(text: str) -> str  
Извлекает первый абзац текста, пропуская заголовки и пустые строки  
Аргументы  
text — Входной текст  
Возвращает  
Первый абзац как одна строка

---
def _build_docs_index(output_root: Path, docs_dir: Path, docs_files: Dict[str, str], file_map: Dict[str, Dict], module_pages: Dict[str, str]) -> Dict[str, object]  
Формирует JSON-индекс документации с метаданными и структурой  
Аргументы  
output_root — Корневая директория вывода  
docs_dir — Директория с документацией  
docs_files — Сгенерированные файлы документации  
file_map — Карта исходных файлов с метаданными  
module_pages — Сопоставление модулей и путей к страницам  
Возвращает  
Словарь с метаинформацией о сгенерированной документации

---
def generate_docs(files: List[Dict], output_root: Path, cache_dir: Path, llm: LLMClient, language: str, write_readme: bool, write_mkdocs: bool, use_cache: bool = True, threads: int = 1)  
Основная функция генерации документации по списку файлов  
Аргументы  
files — Список файлов с метаданными (путь, содержимое и др.)  
output_root — Корневая директория для вывода документации  
cache_dir — Директория для кэширования  
llm — Клиент языковой модели  
language — Язык документации (например, "ru")  
write_readme — Флаг: генерировать ли README.md  
write_mkdocs — Флаг: генерировать ли mkdocs.yml  
use_cache — Использовать кэш LLM (по умолчанию True)  
threads — Количество потоков для параллельной обработки (по умолчанию 1)  
Исключения  
Может выбрасывать исключения при ошибках чтения/записи файлов или сбоях LLM

---
def process_files(files: List[Dict], cache_dir: Path, llm: LLM, use_cache: bool = True, threads: int = 4, local_site: bool = False, force: bool = False) -> None  
Обрабатывает список файлов: суммаризует содержимое, обновляет кэш и восстанавливает недостающие промежуточные данные  
Аргументы  
files — список файлов с полями path, content, size, type, domains  
cache_dir — директория для хранения кэша и промежуточных данных  
llm — экземпляр модели языковой модели для генерации суммаризаций  
use_cache — флаг использования кэширования LLM-запросов  
threads — количество потоков для параллельной обработки  
local_site — флаг, указывающий на генерацию для локального сайта (не влияет напрямую в текущей реализации)  
force — флаг принудительной перегенерации (не используется в текущей реализации)  
Возвращает  
None  
Исключения  
Может выбрасывать исключения при ошибках чтения/записи файлов или сбоях в LLM, которые логируются и добавляются в список errors

---
def _write_summary(content: str, output_dir: Path, relative_path: str) -> Path  
Записывает суммаризированный контент в файл в указанной директории, сохраняя структуру путей  
Аргументы  
content — текст суммаризации для записи  
output_dir — корневая директория для сохранения  
relative_path — относительный путь файла, определяющий поддиректорию и имя файла  
Возвращает  
Путь к созданному файлу суммаризации  
Исключения  
IOError — при ошибках записи файла

---
def summarize_file(content: str, file_type: str, domains: List[str], llm: LLM, llm_cache: Optional[Dict] = None, model: Optional[str] = None, is_module: bool = False) -> str  
Генерирует текстовую суммаризацию содержимого файла с использованием LLM, с разными шаблонами для обычных и модульных суммаризаций  
Аргументы  
content — исходное содержимое файла  
file_type — тип файла (например, "code", "text")  
domains — список доменов, связанных с файлом  
llm — экземпляр языковой модели  
llm_cache — опциональный кэш для хранения и повторного использования ответов LLM  
model — имя модели LLM (передаётся в кэш)  
is_module — флаг, указывающий, что требуется детальная (модульная) суммаризация  
Возвращает  
Сгенерированный текст суммаризации  
Исключения  
Exception — при ошибках взаимодействия с LLM или кэшем

---
def read_text_file(path: Path) -> str  
Считывает содержимое текстового файла с обработкой кодировки  
Аргументы  
path — путь к файлу  
Возвращает  
Содержимое файла в виде строки

---
class Path  
Представляет файловую систему и операции с путями  
Методы  
as_posix() — возвращает путь в формате с прямым слешем, независимо от ОС  
with_suffix(suffix: str) — возвращает новый путь с заменённым расширением  
parent — возвращает родительскую директорию как объект Path

---
def format_changes_md(added, modified, deleted, regenerated_sections: list[str], summary: str) -> str  
Форматирует Markdown-представление изменений в проекте  
Аргументы  
added — словарь добавленных файлов  
modified — словарь изменённых файлов  
deleted — словарь удалённых файлов  
regenerated_sections — список перегенерированных секций  
summary — краткое резюме изменений  
Возвращает  
Строка в формате Markdown с описанием изменений

---
def write_docs_files(docs_dir: Path, docs_files: dict) -> None  
Записывает все сгенерированные файлы документации на диск  
Аргументы  
docs_dir — директория назначения  
docs_files — словарь путей и содержимого файлов

---
class cache  
Управляет кэшированием индекса файлов и ответов LLM  
Методы  
save_index(index: dict) — сохраняет индекс файлов в постоянное хранилище  
save_llm_cache(llm_cache) — сохраняет кэш языковой модели на диск

---
def build_mkdocs_yaml(site_name: str, sections: dict, configs: list, has_modules: bool, module_nav_paths: list = None, local_site: bool = False) -> str  
Генерирует содержимое файла mkdocs.yml для сборки документации  
Аргументы  
site_name — название сайта документации  
sections — отображение заголовков секций  
configs — список сгенерированных конфигурационных файлов  
has_modules — флаг наличия модулей  
module_nav_paths — пути навигации по модулям (опционально)  
local_site — флаг локальной сборки (без публикации)  
Возвращает  
Строка в формате YAML, пригодная для записи в mkdocs.yml
