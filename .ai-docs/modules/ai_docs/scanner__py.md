# ai_docs/scanner

/**
 * Результат сканирования исходного кода: содержит метаданные и список обработанных файлов.
 * Используется для передачи данных между этапами анализа и генерации документации.
 *
 * Ключевые структуры данных
 * ScanResult — результат сканирования: содержит корневой путь, список файлов, источник и имя репозитория
 */

---
def _normalize_extensions(raw: object, defaults: Dict[str, str]) -> Dict[str, str]
Приводит пользовательские расширения из конфига к нормальному виду с описаниями
Аргументы
raw — входные данные (словарь или список расширений)
defaults — словарь описаний по умолчанию
Возвращает
Словарь вида {".ext": "описание"}, дополненный значениями по умолчанию

---
def _normalize_excludes(raw: object) -> Set[str]
Преобразует входные данные в множество строковых шаблонов исключения
Аргументы
raw — входной объект (ожидается список строк)
Возвращает
Множество непустых строк шаблонов исключения

---
def _load_extension_config(root: Path) -> Dict[str, object]
Загружает или создаёт конфигурацию расширений из .ai-docs.yaml в корне проекта
Аргументы
root — корневой путь проекта
Возвращает
Словарь с ключами code_extensions, doc_extensions, config_extensions, exclude

---
def _build_default_include_patterns(extension_config: Dict[str, object]) -> Set[str]
Формирует набор шаблонов включения на основе расширений из конфигурации и фиксированных паттернов
Аргументы
extension_config — конфигурация расширений (результат _load_extension_config)
Возвращает
Множество строковых шаблонов включения файлов

---
def _load_ignore_specs(root: Path) -> List[pathspec.PathSpec]
Загружает правила игнорирования из .gitignore и .build_ignore
Аргументы
root — корневой путь проекта
Возвращает
Список скомпилированных pathspec.PathSpec для проверки соответствия путей

---
def _should_include(rel_path: str, include: Optional[Set[str]], exclude: Optional[Set[str]], ignore_specs: List[pathspec.PathSpec]) -> bool
Определяет, должен ли файл быть включён в сканирование
Аргументы
rel_path — относительный путь к файлу в POSIX-формате
include — множество шаблонов включения (если None — включаются все, кроме исключённых)
exclude — множество шаблонов исключения
ignore_specs — список скомпилированных спецификаций игнорирования (например, из .gitignore)
Возвращает
True, если файл должен быть включён в результат сканирования

---
def _scan_directory(root: Path, include: Optional[Set[str]], exclude: Optional[Set[str]], max_size: int) -> List[Dict]
Рекурсивно сканирует директорию и возвращает список подходящих файлов с содержимым и метаданными
Аргументы
root — корневой путь для сканирования
include — шаблоны включения (если None — ограничение только по exclude)
exclude — шаблоны исключения
max_size — максимальный размер файла в байтах (0 — без ограничения)
Возвращает
Список словарей с полями: path, abs_path, size, content, type, domains
Исключения
OSError — при ошибках доступа к файлам (игнорируются, файл пропускается)

---
def _clone_repo(repo_url: str) -> Tuple[Path, str]
Клонирует удалённый репозиторий в временную директорию
Аргументы
repo_url — URL Git-репозитория
Возвращает
Кортеж из пути к временной директории и имени репозитория
Исключения
RuntimeError — при ошибке клонирования репозитория

---
def scan_source(source: str, include: Optional[Set[str]] = None, exclude: Optional[Set[str]] = None, max_size: int = 200000) -> ScanResult
Сканирует локальную директорию или удалённый репозиторий по URL, фильтруя файлы по расширениям и размеру.
Аргументы
source — путь к локальной директории или URL удалённого репозитория
include — множество шаблонов расширений файлов для включения (по умолчанию — определяется конфигурацией)
exclude — множество шаблонов путей или расширений для исключения (дополняется конфигурацией)
max_size — максимальный размер файла в байтах, превышение которого приводит к исключению файла
Возвращает
Объект ScanResult, содержащий информацию о просканированных файлах, корневой директории, источнике и имени репозитория
Исключения
FileNotFoundError — если указанный локальный путь не существует

---
class ScanResult
Результат сканирования исходного кода: список файлов, корневая директория, источник и имя репозитория.
Поля
root — абсолютный путь к корневой директории сканирования
files — список объектов `FileEntry`, представляющих просканированные файлы
source — исходная строка (путь или URL), с которой было начато сканирование
repo_name — имя репозитория (для URL — извлекается из URL, для локальной директории — имя самой директории)
Методы
__init__(root: Path, files: List[FileEntry], source: str, repo_name: str) — создаёт объект результата сканирования
