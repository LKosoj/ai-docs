# ai_docs/generator_sections

Модуль отвечает за генерацию технической документации на основе анализа кодовой базы, изменений в файлах и контекста от LLM.  
Он строит иерархический контекст, разбивает его на управляемые фрагменты, генерирует разделы документации (включая архитектуру, обзор, тестирование) и формирует финальный README.  
Поддерживается многоязычность, кэширование запросов к LLM и принудительное обновление определённых разделов.

Ключевые структуры данных  
file_map — словарь с метаинформацией о файлах проекта, включая тип, домены, путь к сводке  
llm_cache — кэш ответов LLM для ускорения повторной генерации  
DOMAIN_TITLES — отображение внутренних доменов в читаемые заголовки разделов

---
async def generate_section(llm: LLM, llm_cache: LLMLiteCache, title: str, context: str, language: str) -> str  
Генерирует содержимое раздела документации по заданному контексту и заголовку.  
Аргументы  
llm — экземпляр языковой модели  
llm_cache — кэш для повторного использования результатов LLM  
title — заголовок раздела  
context — входной контекст для генерации  
language — язык вывода  
Возвращает  
Сгенерированный текст раздела  
Исключения  
Может выбрасывать исключения при ошибках взаимодействия с LLM

---
async def generate_readme(llm, llm_cache: Dict[str, str], project_name: str, overview_context: str, language: str) -> str  
Формирует краткий README.md с обзором, быстрым стартом, архитектурой и ссылками.  
Аргументы  
llm — объект модели языковой модели  
llm_cache — кэш ответов LLM  
project_name — название проекта  
overview_context — обобщённый контекст проекта  
language — язык документации  
Возвращает  
Текст README в формате Markdown  
Исключения  
Возможны исключения от llm.chat

---
def truncate_context(context: str, model: str, max_tokens: int) -> str  
Обрезает контекст до указанного лимита токенов, если он превышает лимит.  
Аргументы  
context — исходный текст  
model — название модели для подсчёта токенов  
max_tokens — максимальное количество токенов  
Возвращает  
Обрезанный текст (первый чанк, если требуется разбиение)

---
async def summarize_chunk(llm, llm_cache: Dict[str, str], chunk: str, language: str, focus: str = "") -> str  
Сжимает фрагмент текста до краткого конспекта с сохранением ключевой информации.  
Аргументы  
llm — модель для генерации  
llm_cache — кэш LLM  
chunk — текстовый фрагмент для сжатия  
language — язык вывода  
focus — дополнительный фокус (необязательно)  
Возвращает  
Сжатый конспект на указанном языке  
Исключения  
Возможны исключения от llm.chat

---
async def build_hierarchical_context(llm: LLM, llm_cache: LLMLiteCache, summaries: List[str], input_budget: float, language: str, cache_key: str, focus: str) -> str  
Генерирует иерархический контекст для указанного раздела документации на основе резюме файлов.  
Аргументы  
llm — экземпляр языковой модели для генерации текста  
llm_cache — кэш для хранения результатов запросов к LLM  
summaries — список текстовых резюме, на основе которых строится контекст  
input_budget — лимит длины входного текста для модели  
language — язык, на котором генерируется документация  
cache_key — ключ для кэширования результата  
focus — тема или заголовок, по которой строится контекст  
Возвращает  
Сгенерированный контекст в виде строки  
Исключения  
Может выбрасывать исключения, связанные с выполнением запроса к LLM

---
async def build_sections(file_map: Dict[str, Dict], added: Dict[str, Dict], modified: Dict[str, Dict], deleted: Dict[str, Dict], docs_dir: Path, llm, llm_cache: Dict[str, str], language: str, threads: int, input_budget: int, force_sections: Optional[Set[str]] = None) -> Tuple[Dict[str, str], Dict[str, str], Dict[str, str], List[str], List[str], Dict[str, str], List[str], str]  
Основная функция построения всех разделов документации на основе изменений и контекста.  
Аргументы  
file_map — карта всех файлов проекта с метаданными  
added — добавленные файлы  
modified — изменённые файлы  
deleted — удалённые файлы  
docs_dir — путь к директории документации  
llm — модель для генерации текста  
llm_cache — кэш ответов LLM  
language — язык документации  
threads — количество параллельных потоков (не используется напрямую)  
input_budget — лимит токенов на вход  
force_sections — множество разделов, которые нужно перегенерировать принудительно  
Возвращает  
Кортеж из: контекстов доменов, сгенерированных разделов, контекстов модулей, путей тестов, команд тестов, зависимостей, имён изменённых доменов и обобщённого контекста проекта  
Исключения  
Возможны исключения от llm.chat и операций с файловой системой

---
def read_text_file(path: Path) -> str  
Считывает содержимое текстового файла с обработкой кодировки.  
Аргументы  
path — путь к файлу  
Возвращает  
Содержимое файла в виде строки  
Исключения  
Выбрасывает исключение при ошибке чтения файла

---
def render_testing_section(test_paths: List[str], test_commands: List[str]) -> str  
Формирует Markdown-содержимое раздела тестирования на основе путей и команд.  
Аргументы  
test_paths — список путей к тестовым файлам  
test_commands — список команд для запуска тестов  
Возвращает  
Строка в формате Markdown с описанием тестирования

---
def is_forced(*keys: str) -> bool  
Проверяет, требуется ли перегенерация контента по ключам принудительного обновления.  
Аргументы  
keys — иерархические ключи, определяющие, должен ли контент быть обновлён  
Возвращает  
True, если хотя бы один из ключей помечен как принудительный для перегенерации

---
def is_test_path(path: str) -> bool  
Определяет, является ли путь тестовым (по шаблонам включения/исключения).  
Аргументы  
path — путь к файлу в виде строки  
Возвращает  
True, если путь соответствует критериям тестового файла

---
def format_changes_md(added, modified, deleted, regenerated_sections, summary)  
Форматирует сводку изменений в виде Markdown-документа.  
Аргументы  
added — словарь добавленных файлов и их метаданных  
modified — словарь изменённых файлов и их метаданных  
deleted — словарь удалённых файлов  
regenerated_sections — список названий секций, которые были перегенерированы  
summary — итоговое резюме изменений  
Возвращает  
Строка в формате Markdown, содержащая детализацию изменений и сводку

---
def collect_dependencies(file_map)  
Собирает список внешних зависимостей проекта на основе анализа карты файлов.  
Аргументы  
file_map — словарь, описывающий структуру и содержание файлов проекта  
Возвращает  
Список строк, каждая из которых представляет собой обнаруженную зависимость

---
def render_project_configs_index(config_list)  
Генерирует Markdown-представление списка конфигураций.  
Аргументы  
config_list — список конфигураций или путей к ним  
Возвращает  
Строка в формате Markdown с оформлением списка конфигураций как ссылок

---
class DOMAIN_TITLES  
Словарь сопоставления внутренних доменных ключей с их отображаемыми заголовками.  
Поля  
key — строковой идентификатор домена (например, "api", "db")  
value — читаемое название домена для использования в заголовках документации
