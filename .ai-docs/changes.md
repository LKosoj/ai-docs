# Изменения с последней генерации

## Добавленные файлы

- README_EN.md
- ai_docs/generator_cache.py
- ai_docs/generator_output.py
- ai_docs/generator_sections.py
- ai_docs/generator_shared.py
- ai_docs/generator_summarize.py
## Изменённые файлы

- README.md
- ai_docs/cache.py
- ai_docs/cli.py
- ai_docs/generator.py
- ai_docs/llm.py
- ai_docs/mkdocs.py
- ai_docs/summary.py
- ai_docs/tokenizer.py
- pyproject.toml
## Удалённые файлы

- нет
## Перегенерированные разделы

- Тестирование
- Зависимости
- Соглашения
- Запуск и окружение
- Модули
- Конфигурация проекта
- Документация проекта
- Архитектура
- Глоссарий

## Краткое резюме

Этот раздел описывает ключевые изменения в поведении и архитектуре инструмента `ai_docs` на основе анализа исходного кода и конфигураций.

## Основные изменения

- **Инкрементальная генерация**: документация обновляется только для изменённых или отсутствующих файлов. Используется `CacheManager` для отслеживания хэшей и метаданных через `file_map` и `index.json`.
- **Параллельная обработка**: асинхронные функции (`summarize_changed_files`, `summarize_changed_modules`) работают с ограничением по потокам через `asyncio.Semaphore`, управляемым параметром `--threads` или `AI_DOCS_THREADS`.
- **Кэширование LLM-ответов**: запросы к модели кэшируются по хешу `payload` в `llm_cache.json`. При повторном запуске без изменений — повторное использование результатов.
- **Структура выходных данных**:  
  - `.ai-docs/modules/`, `.ai-docs/configs/` — документация по модулям и конфигурациям.  
  - `changes.md` — автоматически генерируется на основе diff'а файлов.  
  - `_index.json` — навигационный индекс с меткой времени и ранжированием.
- **Очистка устаревших данных**: при обновлении удаляются:
  - резюме для удалённых файлов (`cleanup_deleted_summaries`).
  - неиспользуемые промежуточные файлы (`cleanup_orphan_summaries`).
- **Генерация README и MkDocs**:  
  - `write_readme` поддерживает принудительную перезапись (`--force`).  
  - `build_mkdocs` генерирует `mkdocs.yml` с поддержкой `mermaid2` и адаптирует навигацию под `local_site`.
- **Пагинация**: при превышении 100 элементов в разделах модулей или конфигураций включается пагинация.
- **Поддержка Mermaid**: JavaScript-файл `mermaid.min.js` включается в сборку, HTML-файлы постобрабатываются для корректного отображения `>` в диаграммах.

## Поведение по умолчанию

- Генерируются `README.md` и сайт документации (`ai_docs_site/`).
- Кэширование включено, директория — `.ai_docs_cache/`.
- Фильтрация по `.gitignore`, `.build_ignore`, и исключениям вроде `node_modules`, `.venv`.
- При <50 модулях — полная перегенерация без пагинации.
- Автоматический запуск `mkdocs build` после генерации.

## Управление перегенерацией

- `--regen configs` — пересоздаёт только конфигурации.
- `--regen modules` — только модули.
- `--regen all` — полная перегенерация.
- `AI_DOCS_REGEN_ALL_THRESHOLD` — порог, при превышении которого применяется инкрементальный режим.

## Интеграция с окружением

- LLM настраивается через переменные окружения: `OPENAI_API_KEY`, `OPENAI_MODEL`, `OPENAI_MAX_TOKENS` и др.
- Поддержка сторонних API через `OPENAI_BASE_URL`.
- Конфигурация расширений и исключений — через `.ai-docs.yaml`.

Изменения направлены на повышение производительности, точности и удобства сопровождения документации в CI/CD и локальной разработке.
